{% extends "base.html" %}
{% block title %}360¬∞ Rasm boshqaruvi - Admin{% endblock %}

{% block additional_css %}
<style>
.photo360-management-container {
    min-height: calc(100vh - 200px);
    padding: 20px 0;
}

.admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 0;
    margin-bottom: 30px;
    border-radius: 12px;
}

.upload-section {
    background: var(--bg-color);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.gallery-section {
    background: var(--bg-color);
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.upload-area {
    border: 3px dashed #e0e0e0;
    border-radius: 12px;
    padding: 60px 30px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.upload-area:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.upload-area.dragover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.upload-icon {
    font-size: 4rem;
    color: #999;
    margin-bottom: 20px;
}

.upload-text {
    font-size: 1.2rem;
    color: var(--text-color);
    margin-bottom: 10px;
}

.upload-subtext {
    color: #666;
    font-size: 0.9rem;
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.photo360-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.photo360-item {
    background: var(--bg-color);
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
}

.photo360-item:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.photo360-preview {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 15px;
    cursor: pointer;
}

.photo360-info h4 {
    color: var(--text-color);
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.photo360-meta {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 15px;
}

.photo360-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.btn-preview {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-preview:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
}

.btn-delete {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-delete:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
}

.btn-set-active {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-set-active:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.active-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #4CAF50;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
}

.upload-progress {
    margin-top: 20px;
    display: none;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 10px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state .icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

/* 360 Photo Viewer Modal */
.photo360-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
}

.photo360-viewer {
    width: 90%;
    max-width: 800px;
    height: 70%;
    background: #000;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
}

.photo360-controls {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
}

.photo360-title {
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
}

.photo360-close {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.photo360-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.photo360-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: grab;
    user-select: none;
    transition: transform 0.1s ease;
}

.photo360-image:active {
    cursor: grabbing;
}

/* Dark theme support */
body.dark-theme .upload-section,
body.dark-theme .gallery-section {
    background: #2d2d2d !important;
    color: #ffffff !important;
}

body.dark-theme .photo360-item {
    background: #404040 !important;
    border-color: #555 !important;
    color: #ffffff !important;
}

body.dark-theme .photo360-item:hover {
    border-color: #667eea !important;
}

body.dark-theme .upload-area {
    border-color: #555 !important;
    background: rgba(255, 255, 255, 0.02) !important;
}

body.dark-theme .upload-area:hover {
    border-color: #667eea !important;
    background: rgba(102, 126, 234, 0.1) !important;
}

body.dark-theme .upload-text {
    color: #ffffff !important;
}

body.dark-theme .upload-subtext,
body.dark-theme .photo360-meta {
    color: #aaa !important;
}

body.dark-theme .progress-bar {
    background: #555 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container photo360-management-container">
    <!-- Header -->
    <div class="admin-header text-center">
        <h1 class="mb-0">üîÑ 360¬∞ Rasm boshqaruvi</h1>
        <p class="mb-0 mt-2">Foydalanuvchilar uchun 360¬∞ rasm gallereyasini boshqaring</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h3 class="mb-4">üì§ Yangi 360¬∞ rasm yuklash</h3>
        <div class="upload-area" id="upload-area">
            <div class="upload-icon">üîÑ</div>
            <div class="upload-text">360¬∞ rasmni bu yerga tashlang yoki yuklash uchun bosing</div>
            <div class="upload-subtext">JPG, PNG fayllar qabul qilinadi. Maksimal hajm: 10MB</div>
            <input type="file" class="file-input" id="file-input" accept="image/*" multiple>
        </div>

        <div class="upload-progress" id="upload-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="text-center mt-2">
                <span id="progress-text">Yuklanmoqda...</span>
            </div>
        </div>
    </div>

    <!-- Gallery Section -->
    <div class="gallery-section">
        <h3 class="mb-4">üñºÔ∏è 360¬∞ Rasm gallereyasi</h3>
        
        <div class="photo360-gallery" id="photo360-gallery">
            <!-- Photos will be loaded here dynamically -->
        </div>

        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="icon">üì∑</div>
            <h4>Hech qanday 360¬∞ rasm topilmadi</h4>
            <p>Birinchi 360¬∞ rasmni yuklang</p>
        </div>
    </div>
</div>

<!-- 360 Photo Viewer Modal -->
<div class="photo360-modal" id="photo360-modal">
    <div class="photo360-viewer">
        <div class="photo360-controls">
            <div class="photo360-title" id="photo360-title">360¬∞ Rasm</div>
            <button class="photo360-close" onclick="closePhoto360Viewer()">‚úï</button>
        </div>
        <img class="photo360-image" id="photo360-image" src="" alt="360¬∞ rasm">
    </div>
</div>

<script>
let photos360 = [];
let dragStartX = 0;
let currentRotationX = 0;
let isDragging = false;

// Load photos on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPhotos360();
    setupUploadArea();
});

function setupUploadArea() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    // Click to upload
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files);
        }
    });
}

function handleFileUpload(files) {
    const formData = new FormData();
    
    // Validate files
    for (let file of files) {
        if (!file.type.startsWith('image/')) {
            showError('Faqat rasm fayllari qabul qilinadi');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB
            showError('Fayl hajmi 10MB dan oshmasligi kerak');
            return;
        }
        
        formData.append('files', file);
    }

    // Show progress
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    progressDiv.style.display = 'block';
    progressFill.style.width = '0%';
    progressText.textContent = 'Yuklanmoqda...';

    // Upload files
    fetch('/api/upload-360-photos', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressFill.style.width = '100%';
            progressText.textContent = 'Muvaffaqiyatli yuklandi!';
            
            setTimeout(() => {
                progressDiv.style.display = 'none';
                loadPhotos360(); // Reload gallery
            }, 2000);
        } else {
            throw new Error(data.message || 'Yuklashda xatolik');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        progressDiv.style.display = 'none';
        showError('360¬∞ rasm yuklashda xatolik: ' + error.message);
    });
}

function loadPhotos360() {
    fetch('/api/360-photos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                photos360 = data.photos || [];
                renderPhotos360();
            } else {
                throw new Error(data.message || 'Ma\'lumot yuklashda xatolik');
            }
        })
        .catch(error => {
            console.error('Load error:', error);
            showError('360¬∞ rasmlarni yuklashda xatolik');
            renderPhotos360(); // Show empty state
        });
}

function renderPhotos360() {
    const gallery = document.getElementById('photo360-gallery');
    const emptyState = document.getElementById('empty-state');
    
    if (photos360.length === 0) {
        gallery.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    gallery.innerHTML = photos360.map(photo => `
        <div class="photo360-item">
            ${photo.is_active ? '<div class="active-badge">Faol</div>' : ''}
            <img src="${photo.image_url}" alt="${photo.title}" class="photo360-preview" 
                 onclick="openPhoto360Viewer('${photo.image_url}', '${photo.title}')">
            <div class="photo360-info">
                <h4>${photo.title || 'Nomsiz 360¬∞ rasm'}</h4>
                <div class="photo360-meta">
                    Yuklandi: ${formatDate(photo.created_at)}
                </div>
                <div class="photo360-actions">
                    <button class="btn-preview" onclick="openPhoto360Viewer('${photo.image_url}', '${photo.title}')">
                        üëÅÔ∏è Ko'rish
                    </button>
                    ${!photo.is_active ? `<button class="btn-set-active" onclick="setActive360Photo(${photo.id})">
                        ‚úÖ Faollashtirish
                    </button>` : ''}
                    <button class="btn-delete" onclick="delete360Photo(${photo.id})">
                        üóëÔ∏è O'chirish
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function openPhoto360Viewer(imageUrl, title) {
    const modal = document.getElementById('photo360-modal');
    const image = document.getElementById('photo360-image');
    const titleElement = document.getElementById('photo360-title');
    
    titleElement.textContent = title || '360¬∞ Rasm';
    image.src = imageUrl;
    modal.style.display = 'flex';
    
    // Reset rotation
    currentRotationX = 0;
    image.style.transform = 'rotateY(0deg)';
    
    // Add event listeners for 360 interaction
    setup360Interaction();
}

function setup360Interaction() {
    const image = document.getElementById('photo360-image');
    
    // Mouse events
    image.addEventListener('mousedown', start360Drag);
    document.addEventListener('mousemove', do360Drag);
    document.addEventListener('mouseup', end360Drag);
    
    // Touch events
    image.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        start360Drag({ clientX: touch.clientX });
    });
    
    document.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (e.touches.length > 0) {
            const touch = e.touches[0];
            do360Drag({ clientX: touch.clientX });
        }
    });
    
    document.addEventListener('touchend', end360Drag);
}

function start360Drag(e) {
    isDragging = true;
    dragStartX = e.clientX;
    document.getElementById('photo360-image').style.cursor = 'grabbing';
}

function do360Drag(e) {
    if (!isDragging) return;
    
    const deltaX = e.clientX - dragStartX;
    currentRotationX += deltaX * 0.5; // Adjust sensitivity
    
    const image = document.getElementById('photo360-image');
    image.style.transform = `rotateY(${currentRotationX}deg)`;
    
    dragStartX = e.clientX;
}

function end360Drag() {
    isDragging = false;
    document.getElementById('photo360-image').style.cursor = 'grab';
}

function closePhoto360Viewer() {
    document.getElementById('photo360-modal').style.display = 'none';
    
    // Remove event listeners
    const image = document.getElementById('photo360-image');
    image.removeEventListener('mousedown', start360Drag);
    document.removeEventListener('mousemove', do360Drag);
    document.removeEventListener('mouseup', end360Drag);
}

function setActive360Photo(photoId) {
    fetch(`/api/set-active-360-photo/${photoId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-Token': typeof CSRF_TOKEN !== 'undefined' ? CSRF_TOKEN : ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('360¬∞ rasm faollashtirildi');
            loadPhotos360();
        } else {
            showError(data.message || 'Faollashtirish xatoligi');
        }
    })
    .catch(error => {
        console.error('Activation error:', error);
        showError('360¬∞ rasmni faollashtirish xatoligi');
    });
}

function delete360Photo(photoId) {
    if (!confirm('Rostdan ham bu 360¬∞ rasmni o\'chirmoqchimisiz?')) {
        return;
    }
    
    fetch(`/api/delete-360-photo/${photoId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRF-Token': typeof CSRF_TOKEN !== 'undefined' ? CSRF_TOKEN : ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('360¬∞ rasm o\'chirildi');
            loadPhotos360();
        } else {
            showError(data.message || 'O\'chirish xatoligi');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showError('360¬∞ rasmni o\'chirish xatoligi');
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('uz-UZ') + ' ' + date.toLocaleTimeString('uz-UZ', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function showSuccess(message) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 3000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}

function showError(message) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #f44336;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 3000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePhoto360Viewer();
    }
});
</script>
{% endblock %}