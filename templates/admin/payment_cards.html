{% extends "base.html" %}
{% block title %}To'lov Kartalari Boshqaruvi - Admin{% endblock %}

{% block additional_css %}
<style>
.payment-cards-container {
    min-height: calc(100vh - 200px);
    padding: 20px 0;
}

.admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 0;
    margin-bottom: 30px;
    border-radius: 12px;
}

.btn-add-card {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
}

.btn-add-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
}

.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.payment-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    position: relative;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.payment-card.uzcard {
    background: linear-gradient(135deg, #0066cc 0%, #004499 100%);
}

.payment-card.humo {
    background: linear-gradient(135deg, #00aa44 0%, #008833 100%);
}

.payment-card.visa {
    background: linear-gradient(135deg, #1a365d 0%, #2b77ad 100%);
}

.payment-card.mastercard {
    background: linear-gradient(135deg, #cc0000 0%, #aa0000 100%);
}

.card-type-logo {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 24px;
    opacity: 0.8;
}

.card-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}

.card-number {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 2px;
    margin-bottom: 15px;
    font-family: 'Courier New', monospace;
}

.card-holder {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 10px;
}

.card-bank {
    font-size: 12px;
    opacity: 0.8;
}

.card-actions {
    position: absolute;
    bottom: 15px;
    right: 15px;
    display: flex;
    gap: 10px;
}

.card-actions .btn {
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 5px;
    border: none;
}

.btn-edit-card {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.btn-delete-card {
    background: rgba(220, 53, 69, 0.8);
    color: white;
}

.card-status {
    position: absolute;
    top: 15px;
    left: 15px;
    padding: 4px 8px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: rgba(40, 167, 69, 0.8);
}

.status-inactive {
    background: rgba(108, 117, 125, 0.8);
}

@media (max-width: 768px) {
    .cards-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .payment-card {
        min-height: 160px;
        padding: 20px;
    }
    
    .card-number {
        font-size: 16px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="payment-cards-container">
    <div class="container">
        <!-- Header -->
        <div class="admin-header text-center">
            <h1 class="mb-3">üí≥ To'lov Kartalari Boshqaruvi</h1>
            <p class="mb-0">Savatchada ko'rinadigan to'lov kartalarini boshqaring</p>
        </div>

        <!-- Actions Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Mavjud To'lov Kartalari</h4>
            <button type="button" class="btn btn-add-card" data-bs-toggle="modal" data-bs-target="#cardModal" onclick="openCardModal()">
                <i class="bi bi-plus-circle me-2"></i>Yangi Karta Qo'shish
            </button>
        </div>

        <!-- Payment Cards Grid -->
        <div class="cards-grid" id="cardsGrid">
            <!-- Cards will be loaded here via JavaScript -->
        </div>
    </div>
</div>

<!-- Card Modal -->
<div class="modal fade" id="cardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardModalTitle">Yangi Karta Qo'shish</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cardForm">
                    <input type="hidden" id="cardId">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="cardName" class="form-label">Karta Nomi *</label>
                                <input type="text" class="form-control" id="cardName" required maxlength="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cardType" class="form-label">Karta Turi</label>
                                <select class="form-control" id="cardType" required>
                                    <option value="uzcard">üí≥ UzCard</option>
                                    <option value="humo">üíö Humo</option>
                                    <option value="visa">üíô Visa</option>
                                    <option value="mastercard">‚ù§Ô∏è MasterCard</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">Karta Raqami *</label>
                        <input type="text" class="form-control" id="cardNumber" required maxlength="20" 
                               placeholder="8600 **** **** 1234">
                        <small class="form-text text-muted">Xavfsizlik uchun to'liq raqamni kiritmang</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cardHolderName" class="form-label">Karta Egasi *</label>
                                <input type="text" class="form-control" id="cardHolderName" required maxlength="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bankName" class="form-label">Bank Nomi</label>
                                <input type="text" class="form-control" id="bankName" maxlength="100">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="displayOrder" class="form-label">Tartib Raqami</label>
                                <input type="number" class="form-control" id="displayOrder" value="0" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input type="checkbox" class="form-check-input" id="isActive" checked>
                                    <label class="form-check-label" for="isActive">
                                        Faol (ko'rsatilsin)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" id="saveCardBtn" onclick="saveCard()">
                    <i class="bi bi-check-circle me-2"></i>Saqlash
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
let editingCardId = null;

// Initialize page
$(document).ready(function() {
    loadPaymentCards();
});

// Load payment cards
function loadPaymentCards() {
    fetch('/api/payment-cards-admin')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCards(data.cards);
            } else {
                showNotification('Kartalar yuklanmadi: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Load cards error:', error);
            showNotification('Kartalar yuklanishida xatolik', 'error');
        });
}

// Display cards in grid
function displayCards(cards) {
    const grid = document.getElementById('cardsGrid');
    grid.innerHTML = '';

    if (!cards || cards.length === 0) {
        grid.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Hech qanday karta topilmadi</p></div>';
        return;
    }

    cards.forEach(card => {
        const cardElement = createCardElement(card);
        grid.appendChild(cardElement);
    });
}

// Create card element
function createCardElement(card) {
    const cardDiv = document.createElement('div');
    cardDiv.className = `payment-card ${card.card_type}`;
    
    const typeEmoji = {
        'uzcard': 'üí≥',
        'humo': 'üíö', 
        'visa': 'üíô',
        'mastercard': '‚ù§Ô∏è'
    };

    cardDiv.innerHTML = `
        <div class="card-status ${card.is_active ? 'status-active' : 'status-inactive'}">
            ${card.is_active ? 'Faol' : 'Nofaol'}
        </div>
        <div class="card-type-logo">${typeEmoji[card.card_type] || 'üí≥'}</div>
        <div class="card-name">${card.card_name}</div>
        <div class="card-number">${card.card_number}</div>
        <div class="card-holder">${card.card_holder_name}</div>
        <div class="card-bank">${card.bank_name || ''}</div>
        <div class="card-actions">
            <button class="btn btn-edit-card" onclick="editCard(${card.id})" title="Tahrirlash">
                <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-delete-card" onclick="deleteCard(${card.id})" title="O'chirish">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;

    return cardDiv;
}

// Open card modal
function openCardModal(cardData = null) {
    const modal = document.getElementById('cardModal');
    const title = document.getElementById('cardModalTitle');
    const form = document.getElementById('cardForm');
    
    // Reset form
    form.reset();
    editingCardId = null;
    
    if (cardData) {
        // Edit mode
        title.textContent = 'Kartani Tahrirlash';
        editingCardId = cardData.id;
        
        document.getElementById('cardId').value = cardData.id;
        document.getElementById('cardName').value = cardData.card_name || '';
        document.getElementById('cardNumber').value = cardData.card_number || '';
        document.getElementById('cardHolderName').value = cardData.card_holder_name || '';
        document.getElementById('bankName').value = cardData.bank_name || '';
        document.getElementById('cardType').value = cardData.card_type || 'uzcard';
        document.getElementById('displayOrder').value = cardData.display_order || 0;
        document.getElementById('isActive').checked = !!cardData.is_active;
    } else {
        // Add mode
        title.textContent = 'Yangi Karta Qo\'shish';
        document.getElementById('isActive').checked = true;
    }
}

// Edit card
function editCard(cardId) {
    fetch(`/api/payment-cards-admin`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const card = data.cards.find(c => c.id === cardId);
                if (card) {
                    openCardModal(card);
                    const modal = new bootstrap.Modal(document.getElementById('cardModal'));
                    modal.show();
                }
            }
        })
        .catch(error => console.error('Edit card error:', error));
}

// Save card
function saveCard() {
    const formData = {
        card_name: document.getElementById('cardName').value.trim(),
        card_number: document.getElementById('cardNumber').value.trim(),
        card_holder_name: document.getElementById('cardHolderName').value.trim(),
        bank_name: document.getElementById('bankName').value.trim(),
        card_type: document.getElementById('cardType').value,
        display_order: parseInt(document.getElementById('displayOrder').value) || 0,
        is_active: document.getElementById('isActive').checked
    };
    
    // Validation
    if (!formData.card_name || !formData.card_number || !formData.card_holder_name) {
        showNotification('Majburiy maydonlarni to\'ldiring', 'error');
        return;
    }
    
    const isEdit = !!editingCardId;
    const url = isEdit ? `/api/payment-cards/${editingCardId}` : '/api/payment-cards';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': typeof CSRF_TOKEN !== 'undefined' ? CSRF_TOKEN : ''
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(isEdit ? 'Karta yangilandi' : 'Karta qo\'shildi', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('cardModal'));
            modal.hide();
            loadPaymentCards();
        } else {
            showNotification('Xatolik: ' + (data.message || 'Noma\'lum xatolik'), 'error');
        }
    })
    .catch(error => {
        console.error('Save card error:', error);
        showNotification('Saqlashda xatolik yuz berdi', 'error');
    });
}

// Delete card
function deleteCard(cardId) {
    if (confirm('Ushbu kartani o\'chirishni tasdiqlaysizmi?')) {
        fetch(`/api/payment-cards/${cardId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': typeof CSRF_TOKEN !== 'undefined' ? CSRF_TOKEN : ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Karta o\'chirildi', 'success');
                loadPaymentCards();
            } else {
                showNotification('Xatolik: ' + (data.message || 'Noma\'lum xatolik'), 'error');
            }
        })
        .catch(error => {
            console.error('Delete card error:', error);
            showNotification('O\'chirishda xatolik yuz berdi', 'error');
        });
    }
}

// Show notification function (basic implementation)
function showNotification(message, type) {
    alert(message); // Replace with proper notification system
}
</script>
{% endblock %}