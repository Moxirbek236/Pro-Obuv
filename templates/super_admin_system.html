{% extends "base.html" %}

{% block title %}Tizim Boshqaruvi - Super Admin{% endblock %}

{% block content %}
<div class="system-container">
    <div class="system-header">
        <h1>‚öôÔ∏è Tizim Boshqaruvi</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Tizim
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="status-grid">
        <div class="status-card">
            <div class="status-icon">üñ•Ô∏è</div>
            <div class="status-content">
                <h4>Server Holati</h4>
                <div class="status-value" id="server-status">Ishlayapti</div>
                <div class="status-uptime" id="uptime">Uptime: 0h 0m</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">üíæ</div>
            <div class="status-content">
                <h4>Database</h4>
                <div class="status-value" id="db-status">Ulangan</div>
                <div class="status-uptime" id="db-size">Hajm: 0 MB</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">üöÄ</div>
            <div class="status-content">
                <h4>Performance</h4>
                <div class="status-value" id="performance">Yaxshi</div>
                <div class="status-uptime" id="response-time">Response: 0ms</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">üí∞</div>
            <div class="status-content">
                <h4>Memory</h4>
                <div class="status-value" id="memory-usage">Normal</div>
                <div class="status-uptime" id="memory-percent">0%</div>
            </div>
        </div>
    </div>

    <!-- System Actions -->
    <div class="actions-section">
        <div class="action-group">
            <h3>üîß Tizim Amallar</h3>
            <div class="action-buttons">
                <button class="btn btn-warning" onclick="restartServer()">üîÑ Serverni qayta ishga tushirish</button>
                <button class="btn btn-info" onclick="clearCache()">üóëÔ∏è Cache tozalash</button>
                <button class="btn btn-primary" onclick="optimizeDatabase()">‚ö° Database optimallashtirish</button>
                <button class="btn btn-danger" onclick="emergencyShutdown()">üö® Emergency Shutdown</button>
            </div>
        </div>

        <div class="action-group">
            <h3>üìä Monitoring</h3>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="generateHealthReport()">üìã Health Report</button>
                <button class="btn btn-info" onclick="viewSystemLogs()">üìù System Logs</button>
                <button class="btn btn-primary" onclick="downloadBackup()">üíæ Backup yaratish</button>
            </div>
        </div>
    </div>

    <!-- Configuration Section -->
    <div class="config-section">
        <h3>‚öôÔ∏è Tizim Sozlamalari</h3>
        <form id="config-form" class="config-form">
            <div class="config-grid">
                <div class="form-group">
                    <label>Rate Limit (soatiga):</label>
                    <input type="number" id="rate-limit" value="100" min="10" max="1000">
                </div>
                <div class="form-group">
                    <label>Worker processes:</label>
                    <input type="number" id="workers" value="4" min="1" max="16">
                </div>
                <div class="form-group">
                    <label>Max connections:</label>
                    <input type="number" id="max-connections" value="50" min="5" max="500">
                </div>
                <div class="form-group">
                    <label>Session timeout (daqiqa):</label>
                    <input type="number" id="session-timeout" value="30" min="5" max="50">
                </div>
                <div class="form-group">
                    <label>Cache TTL (soniya):</label>
                    <input type="number" id="cache-ttl" value="300" min="60" max="3600">
                </div>
                <div class="form-group">
                    <label>Log level:</label>
                    <select id="log-level">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Compression faol:</label>
                    <select id="compression">
                        <option value="true">Ha</option>
                        <option value="false">Yo'q</option>
                    </select>
                </div>
            </div>
        </form>

        <div class="config-actions">
            <button class="btn btn-primary" onclick="saveConfiguration()">üíæ Sozlamalarni saqlash</button>
            <button class="btn btn-secondary" onclick="resetConfiguration()">‚Ü∂ Asl holatga qaytarish</button>
        </div>
    </div>

    <!-- System Information -->
    <div class="system-info">
        <h3>‚ÑπÔ∏è Tizim Ma'lumotlari</h3>
        <div class="info-grid">
            <div class="info-card">
                <h4>üêç Python</h4>
                <div id="python-version">3.12.x</div>
            </div>
            <div class="info-card">
                <h4>üåê Flask</h4>
                <div id="flask-version">2.3.x</div>
            </div>
            <div class="info-card">
                <h4>üíæ Platform</h4>
                <div id="platform">Linux</div>
            </div>
            <div class="info-card">
                <h4>üîß Environment</h4>
                <div id="environment">Production</div>
            </div>
            <div class="info-card">
                <h4>üíΩ Total Storage</h4>
                <div id="total-storage">1 GB</div>
            </div>
            <div class="info-card">
                <h4>üì¶ Used Storage</h4>
                <div id="used-storage">200 MB</div>
            </div>
            <div class="info-card">
                <h4>üìö Packages</h4>
                <div id="packages">25+</div>
            </div>
            <div class="info-card">
                <h4>üîÑ Last Update</h4>
                <div id="last-update">2025-01-23</div>
            </div>
        </div>
    </div>

    <!-- Health Report Modal -->
    <div id="healthModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Health Report</h3>
                <button class="btn-close" onclick="closeHealthModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="health-report-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
// System status ma'lumotlarini yuklash
function loadSystemInfo() {
    fetch('/api/super-admin/system-info')
        .then(response => response.json())
        .then(data => {
            // Status cards yangilash
            if (data.status) {
                document.getElementById('server-status').textContent = data.status.server;
                document.getElementById('uptime').textContent = 'Uptime: ' + data.status.uptime;
                document.getElementById('db-status').textContent = data.status.database;
                document.getElementById('db-size').textContent = 'Hajm: ' + data.status.dbSize + ' MB';
                document.getElementById('performance').textContent = data.status.performance;
                document.getElementById('response-time').textContent = 'Response: ' + data.status.responseTime + 'ms';
                document.getElementById('memory-usage').textContent = data.status.memory;
                document.getElementById('memory-percent').textContent = data.status.memoryPercent + '%';
            }

            // System info yangilash
            if (data.info) {
                document.getElementById('python-version').textContent = data.info.python;
                document.getElementById('flask-version').textContent = data.info.flask;
                document.getElementById('platform').textContent = data.info.platform;
                document.getElementById('environment').textContent = data.info.environment;
                document.getElementById('total-storage').textContent = data.info.totalStorage;
                document.getElementById('used-storage').textContent = data.info.usedStorage;
                document.getElementById('packages').textContent = data.info.packages;
                document.getElementById('last-update').textContent = data.info.lastUpdate;
            }
        })
        .catch(error => {
            console.error('System info yuklashda xatolik:', error);
        });
}

// Cache tozalash
function clearCache() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'üîÑ Tozalanmoqda...';

    fetch('/api/super-admin/clear-cache-v1', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('Cache muvaffaqiyatli tozalandi!');
            } else {
                showErrorMessage('Cache tozalashda xatolik: ' + data.message);
            }
        })
        .catch(error => {
            showErrorMessage('Cache tozalashda xatolik');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'üóëÔ∏è Cache tozalash';
        });
}

// Database optimallashtirish
function optimizeDatabase() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚ö° Optimallashtirilmoqda...';

    fetch('/api/super-admin/optimize-database-v1', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Database muvaffaqiyatli optimallashtirildi!');
        } else {
            showErrorMessage('Database optimallashtirish xatoligi: ' + data.message);
        }
    })
    .catch(error => {
        showErrorMessage('Database optimallashtirish xatoligi');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = '‚ö° Database optimallashtirish';
    });
}

// Health report yaratish
function generateHealthReport() {
    fetch('/api/super-admin/health-report-detailed')
        .then(response => response.json())
        .then(data => {
            let reportHtml = '<div class="health-report">';

            // Server health
            reportHtml += '<div class="health-section"><h6>üñ•Ô∏è Server Status</h6><ul>';
            reportHtml += `<li>Status: ${data.server.status}</li>`;
            reportHtml += `<li>Uptime: ${data.server.uptime}</li>`;
            reportHtml += `<li>CPU: ${data.server.cpu}</li>`;
            reportHtml += `<li>Memory: ${data.server.memory}</li>`;
            reportHtml += '</ul></div>';

            // Database health
            reportHtml += '<div class="health-section"><h6>üíæ Database Status</h6><ul>';
            reportHtml += `<li>Status: ${data.database.status}</li>`;
            reportHtml += `<li>Tables: ${data.database.tables}</li>`;
            reportHtml += `<li>Records: ${data.database.records}</li>`;
            reportHtml += `<li>Size: ${data.database.size} MB</li>`;
            reportHtml += '</ul></div>';

            // Performance health
            reportHtml += '<div class="health-section"><h6>üöÄ Performance</h6><ul>';
            reportHtml += `<li>Avg Response: ${data.performance.avgResponse}ms</li>`;
            reportHtml += `<li>Active Sessions: ${data.performance.activeSessions}</li>`;
            reportHtml += `<li>Cache Hit Rate: ${data.performance.cacheHitRate}%</li>`;
            reportHtml += '</ul></div>';

            reportHtml += '</div>';

            document.getElementById('health-report-content').innerHTML = reportHtml;
            document.getElementById('healthModal').style.display = 'block';
        })
        .catch(error => {
            showErrorMessage('Health report yaratishda xatolik');
        });
}

// Modal yopish
function closeHealthModal() {
    document.getElementById('healthModal').style.display = 'none';
}

// Sozlamalarni saqlash
function saveConfiguration() {
    const config = {
        rateLimit: document.getElementById('rate-limit').value,
        workers: document.getElementById('workers').value,
        maxConnections: document.getElementById('max-connections').value,
        sessionTimeout: document.getElementById('session-timeout').value,
        cacheTtl: document.getElementById('cache-ttl').value,
        logLevel: document.getElementById('log-level').value,
        compression: document.getElementById('compression').value
    };

    // Bu yerda API orqali sozlamalarni saqlash
    showSuccessMessage('Sozlamalar saqlandi!');
}

// Asl holatga qaytarish
function resetConfiguration() {
    if (confirm('Barcha sozlamalarni asl holatga qaytarmoqchimisiz?')) {
        document.getElementById('rate-limit').value = 100;
        document.getElementById('workers').value = 4;
        document.getElementById('max-connections').value = 50;
        document.getElementById('session-timeout').value = 30;
        document.getElementById('cache-ttl').value = 300;
        document.getElementById('log-level').value = 'INFO';
        document.getElementById('compression').value = 'true';
        showSuccessMessage('Sozlamalar asl holatga qaytarildi!');
    }
}

// Server qayta ishga tushirish
function restartServer() {
    if (confirm('Rostdan ham serverni qayta ishga tushirmoqchimisiz?')) {
        showSuccessMessage('Server qayta ishga tushirilmoqda...');
        // Bu yerda API orqali restart
    }
}

// Emergency shutdown
function emergencyShutdown() {
    if (confirm('DIQQAT! Bu emergency shutdown. Rostdan ham davom etmoqchimisiz?')) {
        showErrorMessage('Emergency shutdown faollashtirildi');
        // Bu yerda API orqali emergency shutdown
    }
}

// System logs ko'rish
function viewSystemLogs() {
    window.open('/super-admin/logs', '_blank');
}

// Backup yaratish
function downloadBackup() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'üíæ Backup yaratilmoqda...';

    // Bu yerda backup yaratish API
    setTimeout(() => {
        showSuccessMessage('Backup muvaffaqiyatli yaratildi!');
        btn.disabled = false;
        btn.textContent = 'üíæ Backup yaratish';
    }, 3000);
}

// Success message
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Error message
function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Sahifa yuklanganda system info ni yuklash
document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();

    // 30 soniyada bir marta status yangilanishi
    setInterval(loadSystemInfo, 30000);
});
</script>

<style>
.system-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.system-header {
    margin-bottom: 30px;
}

.system-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.status-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
}

.status-icon {
    font-size: 3rem;
    opacity: 0.8;
}

.status-content h4 {
    color: #718096;
    font-size: 1rem;
    margin-bottom: 8px;
}

.status-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
}

.status-uptime {
    color: #a0aec0;
    font-size: 0.9rem;
}

.actions-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.action-group {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.action-group h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.config-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.config-section h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #2d3748;
}

.form-group input,
.form-group select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.system-info {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.system-info h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.info-card {
    text-align: center;
    padding: 20px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.info-card h4 {
    margin-bottom: 10px;
    color: #2d3748;
}

.info-card div {
    font-weight: bold;
    color: #007bff;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.2s ease;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary { background: #007bff; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-info { background: #17a2b8; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-danger { background: #dc3545; color: white; }

.btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 800px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.health-report {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.health-section h6 {
    margin-bottom: 10px;
    color: #2d3748;
}

.health-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.health-section li {
    padding: 5px 0;
    border-bottom: 1px solid #f1f1f1;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification.success {
    background-color: #28a745;
}

.notification.error {
    background-color: #dc3545;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .system-container {
        padding: 15px;
    }

    .status-grid {
        grid-template-columns: 1fr;
    }

    .actions-section {
        grid-template-columns: 1fr;
    }

    .config-grid {
        grid-template-columns: 1fr;
    }

    .config-actions {
        flex-direction: column;
    }

    .info-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}