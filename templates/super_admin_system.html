
{% extends "base.html" %}

{% block title %}Tizim Boshqaruvi - Super Admin{% endblock %}

{% block content %}
<div class="system-container">
    <div class="system-header">
        <h1>⚙️ Tizim Boshqaruvi</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Tizim
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="status-grid">
        <div class="status-card">
            <div class="status-icon">🖥️</div>
            <div class="status-content">
                <h4>Server Holati</h4>
                <div class="status-value" id="server-status">Ishlayapti</div>
                <div class="status-uptime" id="uptime">Uptime: 0h 0m</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon">💾</div>
            <div class="status-content">
                <h4>Database</h4>
                <div class="status-value" id="db-status">Ulangan</div>
                <div class="status-uptime" id="db-size">Hajm: 0 MB</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon">🚀</div>
            <div class="status-content">
                <h4>Performance</h4>
                <div class="status-value" id="performance">Yaxshi</div>
                <div class="status-uptime" id="response-time">Response: 0ms</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon">💰</div>
            <div class="status-content">
                <h4>Memory</h4>
                <div class="status-value" id="memory-usage">Normal</div>
                <div class="status-uptime" id="memory-percent">0%</div>
            </div>
        </div>
    </div>

    <!-- System Actions -->
    <div class="actions-section">
        <div class="action-group">
            <h3>🔧 Tizim Amallar</h3>
            <div class="action-buttons">
                <button class="btn btn-warning" onclick="restartServer()">🔄 Serverni qayta ishga tushirish</button>
                <button class="btn btn-info" onclick="clearCache()">🗑️ Cache tozalash</button>
                <button class="btn btn-primary" onclick="optimizeDatabase()">⚡ Database optimallashtirish</button>
                <button class="btn btn-danger" onclick="emergencyShutdown()">🚨 Emergency Shutdown</button>
            </div>
        </div>
        
        <div class="action-group">
            <h3>📊 Monitoring</h3>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="generateHealthReport()">📋 Health Report</button>
                <button class="btn btn-info" onclick="viewSystemLogs()">📝 System Logs</button>
                <button class="btn btn-primary" onclick="downloadBackup()">💾 Backup yaratish</button>
            </div>
        </div>
    </div>

    <!-- Configuration Section -->
    <div class="config-section">
        <h3>⚙️ Tizim Konfiguratsiyasi</h3>
        
        <div class="config-tabs">
            <button class="config-tab active" onclick="showConfigTab('general')">Umumiy</button>
            <button class="config-tab" onclick="showConfigTab('database')">Database</button>
            <button class="config-tab" onclick="showConfigTab('security')">Xavfsizlik</button>
            <button class="config-tab" onclick="showConfigTab('performance')">Performance</button>
        </div>

        <!-- General Config -->
        <div id="general-config" class="config-content active">
            <div class="config-form">
                <div class="form-group">
                    <label>Dastur nomi:</label>
                    <input type="text" id="app-name" value="O'zbek Milliy Taomlar Restorani">
                </div>
                <div class="form-group">
                    <label>Asosiy til:</label>
                    <select id="default-language">
                        <option value="uz">O'zbek</option>
                        <option value="ru">Русский</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vaqt zonasi:</label>
                    <select id="timezone">
                        <option value="Asia/Tashkent">Asia/Tashkent</option>
                        <option value="Asia/Samarkand">Asia/Samarkand</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>O'rtacha tayyorlanish vaqti (daqiqa):</label>
                    <input type="number" id="prep-time" value="7" min="1" max="60">
                </div>
            </div>
        </div>

        <!-- Database Config -->
        <div id="database-config" class="config-content">
            <div class="config-form">
                <div class="form-group">
                    <label>Database URL:</label>
                    <input type="text" id="db-url" value="sqlite:///database.sqlite3" readonly>
                </div>
                <div class="form-group">
                    <label>Maksimal ulanishlar:</label>
                    <input type="number" id="max-connections" value="20" min="5" max="100">
                </div>
                <div class="form-group">
                    <label>Connection timeout (soniya):</label>
                    <input type="number" id="connection-timeout" value="30" min="10" max="300">
                </div>
                <div class="form-group">
                    <label>Backup davri (soat):</label>
                    <input type="number" id="backup-interval" value="24" min="1" max="168">
                </div>
            </div>
        </div>

        <!-- Security Config -->
        <div id="security-config" class="config-content">
            <div class="config-form">
                <div class="form-group">
                    <label>Session muddati (soat):</label>
                    <input type="number" id="session-lifetime" value="2" min="1" max="24">
                </div>
                <div class="form-group">
                    <label>Kunlik so'rovlar chegarasi:</label>
                    <input type="number" id="daily-limit" value="1000" min="100" max="10000">
                </div>
                <div class="form-group">
                    <label>Soatlik so'rovlar chegarasi:</label>
                    <input type="number" id="hourly-limit" value="200" min="50" max="1000">
                </div>
                <div class="form-group">
                    <label>HTTPS majburiy:</label>
                    <select id="force-https">
                        <option value="true">Ha</option>
                        <option value="false">Yo'q</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Performance Config -->
        <div id="performance-config" class="config-content">
            <div class="config-form">
                <div class="form-group">
                    <label>Thread pool hajmi:</label>
                    <input type="number" id="thread-pool" value="10" min="5" max="50">
                </div>
                <div class="form-group">
                    <label>Cache TTL (soniya):</label>
                    <input type="number" id="cache-ttl" value="300" min="60" max="3600">
                </div>
                <div class="form-group">
                    <label>Log level:</label>
                    <select id="log-level">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Compression faol:</label>
                    <select id="compression">
                        <option value="true">Ha</option>
                        <option value="false">Yo'q</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="config-actions">
            <button class="btn btn-primary" onclick="saveConfiguration()">💾 Sozlamalarni saqlash</button>
            <button class="btn btn-secondary" onclick="resetConfiguration()">↶ Asl holatga qaytarish</button>
        </div>
    </div>

    <!-- System Information -->
    <div class="system-info">
        <h3>ℹ️ Tizim Ma'lumotlari</h3>
        <div class="info-grid">
            <div class="info-card">
                <h4>🐍 Python</h4>
                <div id="python-info">Loading...</div>
            </div>
            <div class="info-card">
                <h4>🌐 Flask</h4>
                <div id="flask-info">Loading...</div>
            </div>
            <div class="info-card">
                <h4>💾 Storage</h4>
                <div id="storage-info">Loading...</div>
            </div>
            <div class="info-card">
                <h4>🔗 Dependencies</h4>
                <div id="deps-info">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Tizim ma'lumotlarini yuklash
function loadSystemInfo() {
    fetch('/api/super-admin/system-info')
        .then(response => response.json())
        .then(data => {
            updateSystemStatus(data.status);
            updateSystemInfo(data.info);
        })
        .catch(error => {
            console.error('Tizim ma\'lumotlarini yuklashda xatolik:', error);
        });
}

// Tizim holatini yangilash
function updateSystemStatus(status) {
    document.getElementById('server-status').textContent = status.server || 'Noma\'lum';
    document.getElementById('db-status').textContent = status.database || 'Noma\'lum';
    document.getElementById('performance').textContent = status.performance || 'Noma\'lum';
    document.getElementById('memory-usage').textContent = status.memory || 'Noma\'lum';
    
    document.getElementById('uptime').textContent = `Uptime: ${status.uptime || '0h 0m'}`;
    document.getElementById('db-size').textContent = `Hajm: ${status.dbSize || '0'} MB`;
    document.getElementById('response-time').textContent = `Response: ${status.responseTime || '0'}ms`;
    document.getElementById('memory-percent').textContent = `${status.memoryPercent || '0'}%`;
}

// Tizim ma'lumotlarini yangilash
function updateSystemInfo(info) {
    document.getElementById('python-info').innerHTML = `
        <div>Versiya: ${info.python || 'N/A'}</div>
        <div>Platform: ${info.platform || 'N/A'}</div>
    `;
    
    document.getElementById('flask-info').innerHTML = `
        <div>Versiya: ${info.flask || 'N/A'}</div>
        <div>Environment: ${info.environment || 'N/A'}</div>
    `;
    
    document.getElementById('storage-info').innerHTML = `
        <div>Jami: ${info.totalStorage || 'N/A'}</div>
        <div>Ishlatilgan: ${info.usedStorage || 'N/A'}</div>
    `;
    
    document.getElementById('deps-info').innerHTML = `
        <div>Kutubxonalar: ${info.packages || 'N/A'}</div>
        <div>Oxirgi yangilanish: ${info.lastUpdate || 'N/A'}</div>
    `;
}

// Config tab ko'rsatish
function showConfigTab(tabName) {
    document.querySelectorAll('.config-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.config-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(`${tabName}-config`).classList.add('active');
    event.target.classList.add('active');
}

// Serverni qayta ishga tushirish
function restartServer() {
    if (confirm('Serverni qayta ishga tushirmoqchimisiz? Bu barcha faol sessiyalarni uzadi.')) {
        fetch('/api/super-admin/restart-server', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Server qayta ishga tushirilmoqda...');
            setTimeout(() => location.reload(), 5000);
        })
        .catch(error => {
            console.error('Server qayta ishga tushirishda xatolik:', error);
            alert('Xatolik yuz berdi');
        });
    }
}

// Cache tozalash
function clearCache() {
    if (confirm('Barcha cache ma\'lumotlarini tozalamoqchimisiz?')) {
        fetch('/api/super-admin/clear-cache', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Cache tozalandi');
        })
        .catch(error => {
            console.error('Cache tozalashda xatolik:', error);
            alert('Xatolik yuz berdi');
        });
    }
}

// Database optimallashtirish
function optimizeDatabase() {
    if (confirm('Database ni optimallashtirmoqchimisiz? Bu biroz vaqt olishi mumkin.')) {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Optimallashtirish...';
        
        fetch('/api/super-admin/optimize-database', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Database optimallashtirildi');
            btn.disabled = false;
            btn.textContent = '⚡ Database optimallashtirish';
        })
        .catch(error => {
            console.error('Database optimallashtirish xatoligi:', error);
            alert('Xatolik yuz berdi');
            btn.disabled = false;
            btn.textContent = '⚡ Database optimallashtirish';
        });
    }
}

// Health report yaratish
function generateHealthReport() {
    fetch('/api/super-admin/health-report')
        .then(response => response.json())
        .then(data => {
            showHealthReportModal(data);
        })
        .catch(error => {
            console.error('Health report xatoligi:', error);
            alert('Health report yaratishda xatolik');
        });
}

// Health report modali
function showHealthReportModal(data) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>📋 Tizim Health Report</h5>
                    <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                </div>
                <div class="modal-body">
                    <div class="health-report">
                        <div class="health-section">
                            <h6>🖥️ Server</h6>
                            <ul>
                                <li>Status: ${data.server?.status || 'N/A'}</li>
                                <li>Uptime: ${data.server?.uptime || 'N/A'}</li>
                                <li>CPU: ${data.server?.cpu || 'N/A'}%</li>
                                <li>Memory: ${data.server?.memory || 'N/A'}%</li>
                            </ul>
                        </div>
                        
                        <div class="health-section">
                            <h6>💾 Database</h6>
                            <ul>
                                <li>Status: ${data.database?.status || 'N/A'}</li>
                                <li>Jami jadvallar: ${data.database?.tables || 'N/A'}</li>
                                <li>Jami yozuvlar: ${data.database?.records || 'N/A'}</li>
                                <li>Hajm: ${data.database?.size || 'N/A'} MB</li>
                            </ul>
                        </div>
                        
                        <div class="health-section">
                            <h6>🚀 Performance</h6>
                            <ul>
                                <li>O'rtacha response: ${data.performance?.avgResponse || 'N/A'}ms</li>
                                <li>Aktiv sessionlar: ${data.performance?.activeSessions || 'N/A'}</li>
                                <li>Cache hit rate: ${data.performance?.cacheHitRate || 'N/A'}%</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Yopish</button>
                    <button class="btn btn-primary" onclick="downloadHealthReport()">📄 Yuklab olish</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Konfiguratsiyani saqlash
function saveConfiguration() {
    const config = {
        app_name: document.getElementById('app-name').value,
        default_language: document.getElementById('default-language').value,
        timezone: document.getElementById('timezone').value,
        prep_time: document.getElementById('prep-time').value,
        max_connections: document.getElementById('max-connections').value,
        connection_timeout: document.getElementById('connection-timeout').value,
        backup_interval: document.getElementById('backup-interval').value,
        session_lifetime: document.getElementById('session-lifetime').value,
        daily_limit: document.getElementById('daily-limit').value,
        hourly_limit: document.getElementById('hourly-limit').value,
        force_https: document.getElementById('force-https').value,
        thread_pool: document.getElementById('thread-pool').value,
        cache_ttl: document.getElementById('cache-ttl').value,
        log_level: document.getElementById('log-level').value,
        compression: document.getElementById('compression').value
    };
    
    fetch('/api/super-admin/save-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Konfiguratsiya saqlandi! Ba\'zi o\'zgarishlar server qayta ishga tushgandan keyin kuchga kiradi.');
        } else {
            alert('Xatolik: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Konfiguratsiya saqlashda xatolik:', error);
        alert('Konfiguratsiya saqlashda xatolik');
    });
}

// Backup yaratish
function downloadBackup() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Backup yaratilmoqda...';
    
    fetch('/api/super-admin/create-backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `restaurant_backup_${new Date().toISOString().split('T')[0]}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        btn.disabled = false;
        btn.textContent = '💾 Backup yaratish';
    })
    .catch(error => {
        console.error('Backup yaratishda xatolik:', error);
        alert('Backup yaratishda xatolik');
        btn.disabled = false;
        btn.textContent = '💾 Backup yaratish';
    });
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();
    
    // 30 soniyada bir marta status yangilanishi
    setInterval(loadSystemInfo, 30000);
});
</script>

<style>
.system-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.system-header {
    margin-bottom: 30px;
}

.system-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.status-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
}

.status-icon {
    font-size: 3rem;
    opacity: 0.8;
}

.status-content h4 {
    color: #718096;
    font-size: 1rem;
    margin-bottom: 8px;
}

.status-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
}

.status-uptime {
    color: #a0aec0;
    font-size: 0.9rem;
}

.actions-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.action-group {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.action-group h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.config-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.config-section h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.config-tabs {
    display: flex;
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 20px;
    overflow-x: auto;
}

.config-tab {
    background: none;
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 14px;
    color: #718096;
    border-bottom: 3px solid transparent;
    white-space: nowrap;
}

.config-tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
}

.config-content {
    display: none;
}

.config-content.active {
    display: block;
}

.config-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: #2d3748;
    font-size: 14px;
}

.form-group input,
.form-group select {
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.config-actions {
    border-top: 1px solid #e2e8f0;
    padding-top: 20px;
    display: flex;
    gap: 15px;
}

.system-info {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.system-info h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.info-card {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px;
}

.info-card h4 {
    margin-bottom: 15px;
    color: #2d3748;
}

.info-card div {
    color: #718096;
    margin-bottom: 5px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-primary { background: #007bff; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-danger { background: #dc3545; color: white; }
.btn-info { background: #17a2b8; color: white; }

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    background: white;
    border-radius: 12px;
    padding: 0;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.health-report {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.health-section h6 {
    margin-bottom: 10px;
    color: #2d3748;
}

.health-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.health-section li {
    padding: 5px 0;
    border-bottom: 1px solid #f1f1f1;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .system-container {
        padding: 15px;
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .actions-section {
        grid-template-columns: 1fr;
    }
    
    .config-form {
        grid-template-columns: 1fr;
    }
    
    .config-actions {
        flex-direction: column;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
