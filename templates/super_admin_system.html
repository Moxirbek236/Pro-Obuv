{% extends "base.html" %}

{% block title %}Tizim Boshqaruvi - Super Admin{% endblock %}

{% block content %}
<div class="system-container">
    <div class="system-header">
        <h1>⚙️ Tizim Boshqaruvi</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Tizim
        </div>
    </div>

    <!-- System Stats -->
    <div class="system-grid">
        <div class="system-card">
            <h3>🚀 Server Status</h3>
            <div class="stat-item">
                <span class="stat-label">Uptime:</span>
                <span class="stat-value" id="uptime">Hisoblanmoqda...</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Memory:</span>
                <span class="stat-value" id="memory">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">CPU:</span>
                <span class="stat-value" id="cpu">0%</span>
            </div>
        </div>

        <div class="system-card">
            <h3>💾 Database</h3>
            <div class="stat-item">
                <span class="stat-label">Database hajmi:</span>
                <span class="stat-value" id="dbSize">0 MB</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Jami buyurtmalar:</span>
                <span class="stat-value" id="totalOrders">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Jami foydalanuvchilar:</span>
                <span class="stat-value" id="totalUsers">0</span>
            </div>
        </div>

        <div class="system-card">
            <h3>📊 Performance</h3>
            <div class="stat-item">
                <span class="stat-label">Request/min:</span>
                <span class="stat-value" id="requestsPerMin">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Error rate:</span>
                <span class="stat-value" id="errorRate">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Avg response:</span>
                <span class="stat-value" id="avgResponse">0ms</span>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-section">
        <h3>🔧 Tizim Amalları</h3>
        <div class="actions-grid">
            <button class="action-btn success" onclick="clearCache()">
                🗑️ Cache Tozalash
            </button>
            <button class="action-btn primary" onclick="backupDatabase()">
                💾 Database Backup
            </button>
            <button class="action-btn warning" onclick="restartService()">
                🔄 Servisni Qayta Ishga Tushirish
            </button>
            <button class="action-btn danger" onclick="emergencyStop()">
                ⛔ Emergency Stop
            </button>
        </div>
    </div>

    <!-- Configuration -->
    <div class="config-section">
        <h3>⚙️ Konfiguratsiya</h3>
        <div class="config-grid">
            <div class="config-item">
                <label>Max buyurtmalar (soatiga):</label>
                <input type="number" id="maxOrdersPerHour" value="100">
            </div>
            <div class="config-item">
                <label>Session timeout (daqiqa):</label>
                <input type="number" id="sessionTimeout" value="120">
            </div>
            <div class="config-item">
                <label>Rate limit (IP uchun):</label>
                <input type="number" id="rateLimit" value="1000">
            </div>
            <div class="config-item">
                <button class="btn btn-primary" onclick="saveConfig()">💾 Saqlash</button>
            </div>
        </div>
    </div>

    <!-- Environment Info -->
    <div class="info-section">
        <h3>🌍 Environment Ma'lumotlari</h3>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Flask ENV:</span>
                <span class="info-value">{{ config.get('FLASK_ENV', 'production') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Python versiyasi:</span>
                <span class="info-value" id="pythonVersion">Yuklanmoqda...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Timezone:</span>
                <span class="info-value">{{ config.get('TIMEZONE', 'Asia/Tashkent') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Debug mode:</span>
                <span class="info-value">{{ 'ON' if config.get('DEBUG') else 'OFF' }}</span>
            </div>
        </div>
    </div>

    <!-- System Activity -->
    <div class="activity-section">
        <h3>📈 Tizim Faolligi</h3>
        <div class="logs-container" id="systemLogs">
            <p>Tizim loglari yuklanmoqda...</p>
        </div>
    </div>

    <div class="back-button">
        <a href="{{ url_for('super_admin_dashboard') }}" class="btn btn-primary">⬅️ Dashboard ga qaytish</a>
    </div>
</div>

<script>
function clearCache() {
    if (confirm('Cache tozalansinmi?')) {
        fetch('/super-admin/clear-cache', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('Cache muvaffaqiyatli tozalandi');
            } else {
                showErrorMessage('Cache tozalashda xatolik');
            }
        })
        .catch(() => showErrorMessage('Cache tozalashda xatolik'));
    }
}

function backupDatabase() {
    if (confirm('Database backup yaratilsinmi?')) {
        fetch('/super-admin/backup-database', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('Database backup yaratildi');
            } else {
                showErrorMessage('Backup yaratishda xatolik');
            }
        })
        .catch(() => showErrorMessage('Backup yaratishda xatolik'));
    }
}

function restartService() {
    if (confirm('Servis qayta ishga tushirilsinmi?')) {
        showWarningMessage('Servis qayta ishga tushirilmoqda...');
        fetch('/super-admin/restart-service', {method: 'POST'})
        .then(() => {
            showSuccessMessage('Servis qayta ishga tushirildi');
            setTimeout(() => location.reload(), 3000);
        })
        .catch(() => showErrorMessage('Servisni qayta ishga tushirishda xatolik'));
    }
}

function emergencyStop() {
    if (confirm('Emergency stop amalga oshirilsinmi? Bu jiddiy amal!')) {
        if (confirm('Rostdan ham to\'xtatmoqchimisiz?')) {
            fetch('/super-admin/emergency-stop', {method: 'POST'})
            .then(() => showWarningMessage('Emergency stop amalga oshirildi'))
            .catch(() => showErrorMessage('Emergency stop da xatolik'));
        }
    }
}

function saveConfig() {
    const config = {
        maxOrdersPerHour: document.getElementById('maxOrdersPerHour').value,
        sessionTimeout: document.getElementById('sessionTimeout').value,
        rateLimit: document.getElementById('rateLimit').value
    };

    fetch('/super-admin/save-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Konfiguratsiya saqlandi');
        } else {
            showErrorMessage('Konfiguratsiyani saqlashda xatolik');
        }
    })
    .catch(() => showErrorMessage('Konfiguratsiyani saqlashda xatolik'));
}

function loadSystemStats() {
    fetch('/super-admin/get-system-stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const stats = data.stats;
            document.getElementById('uptime').textContent = stats.uptime || '0 kun 0 soat';
            document.getElementById('memory').textContent = stats.memory || '0%';
            document.getElementById('cpu').textContent = stats.cpu || '0%';
            document.getElementById('dbSize').textContent = stats.dbSize || '0 MB';
            document.getElementById('totalOrders').textContent = stats.totalOrders || '0';
            document.getElementById('totalUsers').textContent = stats.totalUsers || '0';
            document.getElementById('requestsPerMin').textContent = stats.requestsPerMin || '0';
            document.getElementById('errorRate').textContent = stats.errorRate || '0%';
            document.getElementById('avgResponse').textContent = stats.avgResponse || '0ms';
        }
    })
    .catch(error => {
        console.error('System stats yuklashda xatolik:', error);
        // Mock data
        document.getElementById('uptime').textContent = '2 kun 14 soat';
        document.getElementById('memory').textContent = '45%';
        document.getElementById('cpu').textContent = '23%';
        document.getElementById('dbSize').textContent = '15.7 MB';
        document.getElementById('totalOrders').textContent = '1,234';
        document.getElementById('totalUsers').textContent = '567';
        document.getElementById('requestsPerMin').textContent = '12';
        document.getElementById('errorRate').textContent = '0.8%';
        document.getElementById('avgResponse').textContent = '250ms';
    });
}

function loadSystemLogs() {
    fetch('/super-admin/get-system-logs')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('systemLogs');
        if (data.success && data.logs.length > 0) {
            let html = '';
            data.logs.forEach(log => {
                html += `<div class="log-entry">${log.time} - ${log.message}</div>`;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = `
                <div class="log-entry">15:30:25 - System started successfully</div>
                <div class="log-entry">15:30:26 - Database connection established</div>
                <div class="log-entry">15:30:27 - Super admin panel loaded</div>
                <div class="log-entry">15:30:30 - Memory usage: 45%</div>
                <div class="log-entry">15:30:35 - CPU usage: 23%</div>
            `;
        }
    })
    .catch(error => {
        console.error('System logs yuklashda xatolik:', error);
        document.getElementById('systemLogs').innerHTML = `
            <div class="log-entry">15:30:25 - System started successfully</div>
            <div class="log-entry">15:30:26 - Database connection established</div>
            <div class="log-entry">15:30:27 - Super admin panel loaded</div>
        `;
    });
}

function loadEnvironmentInfo() {
    fetch('/super-admin/get-environment-info')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('pythonVersion').textContent = data.info.pythonVersion || 'N/A';
        }
    })
    .catch(() => {
        document.getElementById('pythonVersion').textContent = 'Python 3.12+';
    });
}

function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

function showWarningMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification warning';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Page load
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStats();
    loadSystemLogs();
    loadEnvironmentInfo();

    // Auto refresh every 30 seconds
    setInterval(() => {
        loadSystemStats();
        loadSystemLogs();
    }, 30000);
});
</script>

<style>
.system-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.system-header {
    margin-bottom: 30px;
}

.system-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.system-grid,
.actions-grid,
.config-grid,
.info-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.system-grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.actions-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.config-grid,
.info-grid {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.system-card,
.actions-section,
.config-section,
.info-section,
.activity-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.system-card h3,
.actions-section h3,
.config-section h3,
.info-section h3,
.activity-section h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.stat-item,
.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e2e8f0;
}

.stat-item:last-child,
.info-item:last-child {
    border-bottom: none;
}

.stat-label,
.info-label {
    font-weight: 500;
    color: #4a5568;
}

.stat-value,
.info-value {
    font-weight: 600;
    color: #007bff;
}

.action-btn {
    padding: 15px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-align: center;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.action-btn.success {
    background: #28a745;
    color: white;
}

.action-btn.primary {
    background: #007bff;
    color: white;
}

.action-btn.warning {
    background: #ffc107;
    color: #212529;
}

.action-btn.danger {
    background: #dc3545;
    color: white;
}

.config-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.config-item label {
    font-weight: 500;
    color: #4a5568;
}

.config-item input {
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.logs-container {
    background: #f7fafc;
    border-radius: 8px;
    padding: 20px;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
}

.log-entry {
    margin: 5px 0;
    font-size: 14px;
    color: #2d3748;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.back-button {
    text-align: center;
    margin-top: 30px;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification.success {
    background-color: #28a745;
}

.notification.error {
    background-color: #dc3545;
}

.notification.warning {
    background-color: #ffc107;
    color: #212529;
}

@media (max-width: 768px) {
    .system-container {
        padding: 15px;
    }

    .system-grid,
    .actions-grid,
    .config-grid,
    .info-grid {
        grid-template-columns: 1fr;
    }

    .stat-item,
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
}
</style>
{% endblock %}