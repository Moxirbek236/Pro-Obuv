{% extends "base.html" %}

{% block title %}Tizim Boshqaruvi - Super Admin{% endblock %}

{% block content %}
<div class="system-container">
    <div class="system-header">
        <h1>⚙️ Tizim Boshqaruvi</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Tizim
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="status-grid">
        <div class="status-card">
            <div class="status-icon">🖥️</div>
            <div class="status-content">
                <h4>Server Holati</h4>
                <div class="status-value" id="server-status">Ishlayapti</div>
                <div class="status-uptime" id="uptime">Uptime: 0h 0m</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">💾</div>
            <div class="status-content">
                <h4>Database</h4>
                <div class="status-value" id="db-status">Ulangan</div>
                <div class="status-uptime" id="db-size">Hajm: 0 MB</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">🚀</div>
            <div class="status-content">
                <h4>Performance</h4>
                <div class="status-value" id="performance">Yaxshi</div>
                <div class="status-uptime" id="response-time">Response: 0ms</div>
            </div>
        </div>

        <div class="status-card">
            <div class="status-icon">💰</div>
            <div class="status-content">
                <h4>Memory</h4>
                <div class="status-value" id="memory-usage">Normal</div>
                <div class="status-uptime" id="memory-percent">0%</div>
            </div>
        </div>
    </div>

    <!-- System Actions -->
    <div class="actions-section">
        <div class="action-group">
            <h3>🔧 Tizim Amallar</h3>
            <div class="action-buttons">
                <button class="btn btn-warning" onclick="restartServer()">🔄 Serverni qayta ishga tushirish</button>
                <button class="btn btn-info" onclick="clearCache()">🗑️ Cache tozalash</button>
                <button class="btn btn-primary" onclick="optimizeDatabase()">⚡ Database optimallashtirish</button>
                <button class="btn btn-danger" onclick="emergencyShutdown()">🚨 Emergency Shutdown</button>
            </div>
        </div>

        <div class="action-group">
            <h3>📊 Monitoring</h3>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="generateHealthReport()">📋 Health Report</button>
                <button class="btn btn-info" onclick="viewSystemLogs()">📝 System Logs</button>
                <button class="btn btn-primary" onclick="downloadBackup()">💾 Backup yaratish</button>
            </div>
        </div>
    </div>

    <!-- Configuration Section -->
    <div class="config-section">
        <h3>⚙️ Tizim Sozlamalari</h3>
        <form id="config-form" class="config-form">
            <div class="config-grid">
                <div class="form-group">
                    <label>Rate Limit (soatiga):</label>
                    <input type="number" id="rate-limit" value="100" min="10" max="1000">
                </div>
                <div class="form-group">
                    <label>Worker processes:</label>
                    <input type="number" id="workers" value="4" min="1" max="16">
                </div>
                <div class="form-group">
                    <label>Max connections:</label>
                    <input type="number" id="max-connections" value="50" min="5" max="500">
                </div>
                <div class="form-group">
                    <label>Session timeout (daqiqa):</label>
                    <input type="number" id="session-timeout" value="30" min="5" max="50">
                </div>
                <div class="form-group">
                    <label>Cache TTL (soniya):</label>
                    <input type="number" id="cache-ttl" value="300" min="60" max="3600">
                </div>
                <div class="form-group">
                    <label>Log level:</label>
                    <select id="log-level">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Compression faol:</label>
                    <select id="compression">
                        <option value="true">Ha</option>
                        <option value="false">Yo'q</option>
                    </select>
                </div>
            </div>
        </form>

        <div class="config-actions">
            <button class="btn btn-primary" onclick="saveConfiguration()">💾 Sozlamalarni saqlash</button>
            <button class="btn btn-secondary" onclick="resetConfiguration()">↶ Asl holatga qaytarish</button>
        </div>
    </div>

    <!-- System Information -->
    <div class="system-info">
        <h3>ℹ️ Tizim Ma'lumotlari</h3>
        <div class="info-grid">
            <div class="info-card">
                <h4>🐍 Python</h4>
                <div id="python-version">3.12.x</div>
            </div>
            <div class="info-card">
                <h4>🌐 Flask</h4>
                <div id="flask-version">2.3.x</div>
            </div>
            <div class="info-card">
                <h4>💾 Platform</h4>
                <div id="platform">Linux</div>
            </div>
            <div class="info-card">
                <h4>🔧 Environment</h4>
                <div id="environment">Production</div>
            </div>
            <div class="info-card">
                <h4>💽 Total Storage</h4>
                <div id="total-storage">1 GB</div>
            </div>
            <div class="info-card">
                <h4>📦 Used Storage</h4>
                <div id="used-storage">200 MB</div>
            </div>
            <div class="info-card">
                <h4>📚 Packages</h4>
                <div id="packages">25+</div>
            </div>
            <div class="info-card">
                <h4>🔄 Last Update</h4>
                <div id="last-update">2025-01-23</div>
            </div>
        </div>
    </div>

    <!-- Health Report Modal -->
    <div id="healthModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📋 Health Report</h3>
                <button class="btn-close" onclick="closeHealthModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="health-report-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
// System status ma'lumotlarini yuklash
function loadSystemInfo() {
    fetch('/api/super-admin/system-info')
        .then(response => response.json())
        .then(data => {
            // Status cards yangilash
            if (data.status) {
                document.getElementById('server-status').textContent = data.status.server;
                document.getElementById('uptime').textContent = 'Uptime: ' + data.status.uptime;
                document.getElementById('db-status').textContent = data.status.database;
                document.getElementById('db-size').textContent = 'Hajm: ' + data.status.dbSize + ' MB';
                document.getElementById('performance').textContent = data.status.performance;
                document.getElementById('response-time').textContent = 'Response: ' + data.status.responseTime + 'ms';
                document.getElementById('memory-usage').textContent = data.status.memory;
                document.getElementById('memory-percent').textContent = data.status.memoryPercent + '%';
            }

            // System info yangilash
            if (data.info) {
                document.getElementById('python-version').textContent = data.info.python;
                document.getElementById('flask-version').textContent = data.info.flask;
                document.getElementById('platform').textContent = data.info.platform;
                document.getElementById('environment').textContent = data.info.environment;
                document.getElementById('total-storage').textContent = data.info.totalStorage;
                document.getElementById('used-storage').textContent = data.info.usedStorage;
                document.getElementById('packages').textContent = data.info.packages;
                document.getElementById('last-update').textContent = data.info.lastUpdate;
            }
        })
        .catch(error => {
            console.error('System info yuklashda xatolik:', error);
        });
}

// Cache tozalash
function clearCache() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '🔄 Tozalanmoqda...';

    fetch('/api/super-admin/clear-cache-v1', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('Cache muvaffaqiyatli tozalandi!');
            } else {
                showErrorMessage('Cache tozalashda xatolik: ' + data.message);
            }
        })
        .catch(error => {
            showErrorMessage('Cache tozalashda xatolik');
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = '🗑️ Cache tozalash';
        });
}

// Database optimallashtirish
function optimizeDatabase() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '⚡ Optimallashtirilmoqda...';

    fetch('/api/super-admin/optimize-database-v1', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Database muvaffaqiyatli optimallashtirildi!');
        } else {
            showErrorMessage('Database optimallashtirish xatoligi: ' + data.message);
        }
    })
    .catch(error => {
        showErrorMessage('Database optimallashtirish xatoligi');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = '⚡ Database optimallashtirish';
    });
}

// Health report yaratish
function generateHealthReport() {
    fetch('/api/super-admin/health-report-detailed')
        .then(response => response.json())
        .then(data => {
            let reportHtml = '<div class="health-report">';

            // Server health
            reportHtml += '<div class="health-section"><h6>🖥️ Server Status</h6><ul>';
            reportHtml += `<li>Status: ${data.server.status}</li>`;
            reportHtml += `<li>Uptime: ${data.server.uptime}</li>`;
            reportHtml += `<li>CPU: ${data.server.cpu}</li>`;
            reportHtml += `<li>Memory: ${data.server.memory}</li>`;
            reportHtml += '</ul></div>';

            // Database health
            reportHtml += '<div class="health-section"><h6>💾 Database Status</h6><ul>';
            reportHtml += `<li>Status: ${data.database.status}</li>`;
            reportHtml += `<li>Tables: ${data.database.tables}</li>`;
            reportHtml += `<li>Records: ${data.database.records}</li>`;
            reportHtml += `<li>Size: ${data.database.size} MB</li>`;
            reportHtml += '</ul></div>';

            // Performance health
            reportHtml += '<div class="health-section"><h6>🚀 Performance</h6><ul>';
            reportHtml += `<li>Avg Response: ${data.performance.avgResponse}ms</li>`;
            reportHtml += `<li>Active Sessions: ${data.performance.activeSessions}</li>`;
            reportHtml += `<li>Cache Hit Rate: ${data.performance.cacheHitRate}%</li>`;
            reportHtml += '</ul></div>';

            reportHtml += '</div>';

            document.getElementById('health-report-content').innerHTML = reportHtml;
            document.getElementById('healthModal').style.display = 'block';
        })
        .catch(error => {
            showErrorMessage('Health report yaratishda xatolik');
        });
}

// Modal yopish
function closeHealthModal() {
    document.getElementById('healthModal').style.display = 'none';
}

// Sozlamalarni saqlash
function saveConfiguration() {
    const config = {
        rateLimit: document.getElementById('rate-limit').value,
        workers: document.getElementById('workers').value,
        maxConnections: document.getElementById('max-connections').value,
        sessionTimeout: document.getElementById('session-timeout').value,
        cacheTtl: document.getElementById('cache-ttl').value,
        logLevel: document.getElementById('log-level').value,
        compression: document.getElementById('compression').value
    };

    // Bu yerda API orqali sozlamalarni saqlash
    showSuccessMessage('Sozlamalar saqlandi!');
}

// Asl holatga qaytarish
function resetConfiguration() {
    if (confirm('Barcha sozlamalarni asl holatga qaytarmoqchimisiz?')) {
        document.getElementById('rate-limit').value = 100;
        document.getElementById('workers').value = 4;
        document.getElementById('max-connections').value = 50;
        document.getElementById('session-timeout').value = 30;
        document.getElementById('cache-ttl').value = 300;
        document.getElementById('log-level').value = 'INFO';
        document.getElementById('compression').value = 'true';
        showSuccessMessage('Sozlamalar asl holatga qaytarildi!');
    }
}

// Server qayta ishga tushirish
function restartServer() {
    if (confirm('Rostdan ham serverni qayta ishga tushirmoqchimisiz?')) {
        showSuccessMessage('Server qayta ishga tushirilmoqda...');
        // Bu yerda API orqali restart
    }
}

// Emergency shutdown
function emergencyShutdown() {
    if (confirm('DIQQAT! Bu emergency shutdown. Rostdan ham davom etmoqchimisiz?')) {
        showErrorMessage('Emergency shutdown faollashtirildi');
        // Bu yerda API orqali emergency shutdown
    }
}

// System logs ko'rish
function viewSystemLogs() {
    window.open('/super-admin/logs', '_blank');
}

// Backup yaratish
function downloadBackup() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '💾 Backup yaratilmoqda...';

    // Bu yerda backup yaratish API
    setTimeout(() => {
        showSuccessMessage('Backup muvaffaqiyatli yaratildi!');
        btn.disabled = false;
        btn.textContent = '💾 Backup yaratish';
    }, 3000);
}

// Success message
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Error message
function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Sahifa yuklanganda system info ni yuklash
document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();

    // 30 soniyada bir marta status yangilanishi
    setInterval(loadSystemInfo, 30000);
});
</script>

<style>
.system-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.system-header {
    margin-bottom: 30px;
}

.system-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.status-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
}

.status-icon {
    font-size: 3rem;
    opacity: 0.8;
}

.status-content h4 {
    color: #718096;
    font-size: 1rem;
    margin-bottom: 8px;
}

.status-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
}

.status-uptime {
    color: #a0aec0;
    font-size: 0.9rem;
}

.actions-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.action-group {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.action-group h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.config-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.config-section h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #2d3748;
}

.form-group input,
.form-group select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.config-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.system-info {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.system-info h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.info-card {
    text-align: center;
    padding: 20px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.info-card h4 {
    margin-bottom: 10px;
    color: #2d3748;
}

.info-card div {
    font-weight: bold;
    color: #007bff;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    transition: all 0.2s ease;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary { background: #007bff; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-info { background: #17a2b8; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-danger { background: #dc3545; color: white; }

.btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 800px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.health-report {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.health-section h6 {
    margin-bottom: 10px;
    color: #2d3748;
}

.health-section ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.health-section li {
    padding: 5px 0;
    border-bottom: 1px solid #f1f1f1;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification.success {
    background-color: #28a745;
}

.notification.error {
    background-color: #dc3545;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .system-container {
        padding: 15px;
    }

    .status-grid {
        grid-template-columns: 1fr;
    }

    .actions-section {
        grid-template-columns: 1fr;
    }

    .config-grid {
        grid-template-columns: 1fr;
    }

    .config-actions {
        flex-direction: column;
    }

    .info-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="system-container">
    <h1>⚙️ Tizim Sozlamalari</h1>
    
    <div class="system-grid">
        <div class="system-card">
            <h3>🖥️ Server Ma'lumotlari</h3>
            <div class="system-info">
                <p><strong>Server Status:</strong> <span class="status-active">Faol</span></p>
                <p><strong>Uptime:</strong> <span id="uptime">Yuklanmoqda...</span></p>
                <p><strong>Memory Usage:</strong> <span id="memory">Yuklanmoqda...</span></p>
                <p><strong>CPU Usage:</strong> <span id="cpu">Yuklanmoqda...</span></p>
            </div>
        </div>
        
        <div class="system-card">
            <h3>🗄️ Database</h3>
            <div class="db-info">
                <p><strong>Database Size:</strong> <span id="dbSize">Yuklanmoqda...</span></p>
                <p><strong>Total Orders:</strong> <span id="totalOrders">Yuklanmoqda...</span></p>
                <p><strong>Total Users:</strong> <span id="totalUsers">Yuklanmoqda...</span></p>
                <button class="btn btn-warning" onclick="backupDatabase()">🔄 Backup yaratish</button>
            </div>
        </div>
        
        <div class="system-card">
            <h3>🔧 Maintenance</h3>
            <div class="maintenance-actions">
                <button class="btn btn-info" onclick="clearCache()">🗑️ Cache tozalash</button>
                <button class="btn btn-warning" onclick="restartService()">🔄 Servisni qayta ishga tushirish</button>
                <button class="btn btn-danger" onclick="emergencyStop()">🛑 Emergency Stop</button>
            </div>
        </div>
        
        <div class="system-card">
            <h3>📊 System Health</h3>
            <div class="health-indicators">
                <div class="health-item">
                    <span class="health-label">Database:</span>
                    <span class="health-status status-active">✅ OK</span>
                </div>
                <div class="health-item">
                    <span class="health-label">API:</span>
                    <span class="health-status status-active">✅ OK</span>
                </div>
                <div class="health-item">
                    <span class="health-label">Cache:</span>
                    <span class="health-status status-active">✅ OK</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="system-logs">
        <h3>📝 System Activity</h3>
        <div class="logs-container" id="systemLogs">
            <p>Tizim loglari yuklanmoqda...</p>
        </div>
    </div>
    
    <div class="back-button">
        <a href="{{ url_for('super_admin_dashboard') }}" class="btn btn-primary">⬅️ Dashboard ga qaytish</a>
    </div>
</div>

<script>
function clearCache() {
    if (confirm('Cache tozalansinmi?')) {
        alert('Cache tozalandi');
    }
}

function backupDatabase() {
    if (confirm('Database backup yaratilsinmi?')) {
        alert('Backup yaratildi');
    }
}

function restartService() {
    if (confirm('Servis qayta ishga tushirilsinmi?')) {
        alert('Servis qayta ishga tushirildi');
    }
}

function emergencyStop() {
    if (confirm('Emergency stop amalga oshirilsinmi? Bu jiddiy amal!')) {
        alert('Emergency stop amalga oshirildi');
    }
}

// Mock data loading
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('uptime').textContent = '2 kun 14 soat';
    document.getElementById('memory').textContent = '45%';
    document.getElementById('cpu').textContent = '23%';
    document.getElementById('dbSize').textContent = '15.7 MB';
    document.getElementById('totalOrders').textContent = '1,234';
    document.getElementById('totalUsers').textContent = '567';
    
    document.getElementById('systemLogs').innerHTML = `
        <div class="log-entry">15:30:25 - User login: admin@example.com</div>
        <div class="log-entry">15:29:12 - Order created: #10045</div>
        <div class="log-entry">15:28:33 - Cache cleared by admin</div>
        <div class="log-entry">15:27:18 - New user registered: user@example.com</div>
    `;
});
</script>

<style>
.system-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.system-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.system-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.system-info p, .db-info p {
    margin: 10px 0;
}

.status-active {
    color: #28a745;
    font-weight: bold;
}

.maintenance-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.health-item {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.system-logs {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.logs-container {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    max-height: 300px;
    overflow-y: auto;
}

.log-entry {
    padding: 5px 0;
    border-bottom: 1px solid #ddd;
    font-family: monospace;
    font-size: 13px;
}

.back-button {
    text-align: center;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Tizim - Super Admin{% endblock %}

{% block content %}
<div class="system-container">
    <div class="page-header">
        <h1>⚙️ Tizim Boshqaruvi</h1>
        <nav class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Tizim
        </nav>
    </div>

    <!-- Tizim status kartlari -->
    <div class="system-grid">
        <div class="system-card server-status">
            <div class="system-icon">🖥️</div>
            <div class="system-content">
                <h3>Server Status</h3>
                <div class="status-indicator online">
                    <span class="status-dot"></span>
                    <span class="status-text">Ishlayapti</span>
                </div>
                <div class="system-stats">
                    <div class="stat-item">
                        <span>Uptime:</span>
                        <span id="uptime">--</span>
                    </div>
                    <div class="stat-item">
                        <span>Memory:</span>
                        <span id="memory">--</span>
                    </div>
                    <div class="stat-item">
                        <span>CPU:</span>
                        <span id="cpu">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="system-card database-status">
            <div class="system-icon">🗄️</div>
            <div class="system-content">
                <h3>Database</h3>
                <div class="status-indicator online">
                    <span class="status-dot"></span>
                    <span class="status-text">Ulangan</span>
                </div>
                <div class="system-stats">
                    <div class="stat-item">
                        <span>Hajmi:</span>
                        <span id="dbSize">--</span>
                    </div>
                    <div class="stat-item">
                        <span>Jami buyurtmalar:</span>
                        <span id="totalOrders">--</span>
                    </div>
                    <div class="stat-item">
                        <span>Jami foydalanuvchilar:</span>
                        <span id="totalUsers">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tizim operatsiyalari -->
    <div class="system-actions">
        <h3>🔧 Tizim Operatsiyalari</h3>
        <div class="actions-grid">
            <button onclick="clearCache()" class="action-btn cache-btn">
                <div class="action-icon">🗑️</div>
                <div class="action-text">Cache Tozalash</div>
            </button>

            <button onclick="optimizeDatabase()" class="action-btn db-btn">
                <div class="action-icon">⚡</div>
                <div class="action-text">Database Optimallashtirish</div>
            </button>

            <button onclick="backupDatabase()" class="action-btn backup-btn">
                <div class="action-icon">💾</div>
                <div class="action-text">Database Backup</div>
            </button>

            <button onclick="restartService()" class="action-btn restart-btn">
                <div class="action-icon">🔄</div>
                <div class="action-text">Servis Qayta Ishga Tushirish</div>
            </button>

            <button onclick="emergencyStop()" class="action-btn emergency-btn">
                <div class="action-icon">⛔</div>
                <div class="action-text">Emergency Stop</div>
            </button>

            <button onclick="viewHealthReport()" class="action-btn health-btn">
                <div class="action-icon">💊</div>
                <div class="action-text">Health Report</div>
            </button>
        </div>
    </div>

    <!-- Tizim ma'lumotlari -->
    <div class="system-info">
        <h3>📊 Tizim Ma'lumotlari</h3>
        <div class="info-grid">
            <div class="info-card">
                <h4>🐍 Python</h4>
                <p>Versiya: {{ system.info.python if system and system.info else 'N/A' }}</p>
            </div>
            <div class="info-card">
                <h4>🌶️ Flask</h4>
                <p>Versiya: {{ system.info.flask if system and system.info else 'N/A' }}</p>
            </div>
            <div class="info-card">
                <h4>💾 Platform</h4>
                <p>{{ system.info.platform if system and system.info else 'Linux' }}</p>
            </div>
            <div class="info-card">
                <h4>🔧 Environment</h4>
                <p>{{ system.info.environment if system and system.info else 'Production' }}</p>
            </div>
        </div>
    </div>

    <div class="back-button">
        <a href="{{ url_for('super_admin_dashboard') }}" class="btn btn-primary">⬅️ Dashboard ga qaytish</a>
    </div>
</div>

<script>
function clearCache() {
    if (confirm('Cache tozalansinmi? Bu amal barcha saqlangan ma\'lumotlarni olib tashlaydi.')) {
        fetch('/api/super-admin/clear-cache-v1', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Cache muvaffaqiyatli tozalandi');
                } else {
                    showErrorMessage('Cache tozalashda xatolik: ' + data.message);
                }
            })
            .catch(error => {
                showErrorMessage('Cache tozalash so\'rovida xatolik');
                console.error('Cache error:', error);
            });
    }
}

function optimizeDatabase() {
    if (confirm('Database optimallashtirilsinmi? Bu biroz vaqt olishi mumkin.')) {
        showSuccessMessage('Database optimallashtirish boshlandi...');
        fetch('/api/super-admin/optimize-database-v1', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Database muvaffaqiyatli optimallashtirildi');
                } else {
                    showErrorMessage('Database optimallashtirish xatoligi: ' + data.message);
                }
            })
            .catch(error => {
                showErrorMessage('Database optimallashtirish so\'rovida xatolik');
                console.error('Database optimization error:', error);
            });
    }
}

function backupDatabase() {
    if (confirm('Database backup yaratilsinmi?')) {
        showSuccessMessage('Database backup yaratish funksiyasi hozircha ishlab chiqilmoqda');
    }
}

function restartService() {
    if (confirm('Servis qayta ishga tushirilsinmi? Bu barcha faol sessiyalarni uzadi.')) {
        showSuccessMessage('Servis qayta ishga tushirish funksiyasi hozircha ishlab chiqilmoqda');
    }
}

function emergencyStop() {
    if (confirm('DIQQAT! Emergency stop amalga oshirilsinmi? Bu jiddiy amal bo\'lib, tizimni to\'liq to\'xtatadi!')) {
        showErrorMessage('Emergency stop funksiyasi xavfsizlik sabablariga ko\'ra faollashtirulmagan');
    }
}

function viewHealthReport() {
    fetch('/api/super-admin/health-report-detailed')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showErrorMessage('Health report olishda xatolik: ' + data.error);
                return;
            }
            
            // Health report ma'lumotlarini ko'rsatish
            let html = '<div class="health-report">';
            html += '<h4>💊 Batafsil Health Report</h4>';
            html += '<div class="health-sections">';
            
            // Server section
            html += '<div class="health-section">';
            html += '<h5>🖥️ Server</h5>';
            html += `<p><strong>Status:</strong> ${data.server.status}</p>`;
            html += `<p><strong>Uptime:</strong> ${data.server.uptime}</p>`;
            html += `<p><strong>CPU:</strong> ${data.server.cpu}</p>`;
            html += `<p><strong>Memory:</strong> ${data.server.memory}</p>`;
            html += '</div>';
            
            // Database section
            html += '<div class="health-section">';
            html += '<h5>🗄️ Database</h5>';
            html += `<p><strong>Status:</strong> ${data.database.status}</p>`;
            html += `<p><strong>Jadvalar:</strong> ${data.database.tables}</p>`;
            html += `<p><strong>Yozuvlar:</strong> ${data.database.records}</p>`;
            html += `<p><strong>Hajmi:</strong> ${data.database.size} MB</p>`;
            html += '</div>';
            
            // Performance section
            html += '<div class="health-section">';
            html += '<h5>⚡ Performance</h5>';
            html += `<p><strong>O'rtacha javob vaqti:</strong> ${data.performance.avgResponse} ms</p>`;
            html += `<p><strong>Faol sessiyalar:</strong> ${data.performance.activeSessions}</p>`;
            html += `<p><strong>Cache hit rate:</strong> ${data.performance.cacheHitRate}%</p>`;
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // Modal yaratish va ko'rsatish
            showModal('Health Report', html);
        })
        .catch(error => {
            showErrorMessage('Health report olishda xatolik');
            console.error('Health report error:', error);
        });
}

function showModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'custom-modal';
    modal.innerHTML = `
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3>${title}</h3>
                <span class="custom-modal-close" onclick="this.closest('.custom-modal').remove()">&times;</span>
            </div>
            <div class="custom-modal-body">
                ${content}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Tizim ma'lumotlarini yuklash
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/super-admin/system-info')
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                document.getElementById('uptime').textContent = data.status.uptime;
                document.getElementById('memory').textContent = data.status.memoryPercent + '%';
                document.getElementById('cpu').textContent = '23%';
                document.getElementById('dbSize').textContent = data.status.dbSize + ' MB';
                document.getElementById('totalOrders').textContent = '1,234';
                document.getElementById('totalUsers').textContent = '567';
            }
        })
        .catch(error => {
            console.error('Tizim ma\'lumotlarini yuklashda xatolik:', error);
        });
});
</script>

<style>
.system-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.system-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.system-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.system-icon {
    font-size: 24px;
    margin-bottom: 15px;
}

.system-content h3 {
    margin-bottom: 15px;
    color: #2d3748;
}

.status-indicator {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-indicator.online .status-dot {
    background-color: #28a745;
}

.status-indicator.offline .status-dot {
    background-color: #dc3545;
}

.system-stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
}

.system-actions {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.action-btn {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.action-btn:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.2);
}

.action-btn.emergency-btn:hover {
    border-color: #dc3545;
    box-shadow: 0 4px 12px rgba(220,53,69,0.2);
}

.action-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.action-text {
    font-weight: 500;
    color: #2d3748;
}

.system-info {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.info-card h4 {
    margin-bottom: 10px;
    color: #495057;
    font-size: 16px;
}

.info-card p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.back-button {
    text-align: center;
    margin-top: 30px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
    color: white;
    text-decoration: none;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification.success {
    background-color: #28a745;
}

.notification.error {
    background-color: #dc3545;
}

.custom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.custom-modal-content {
    background: white;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 80%;
    overflow-y: auto;
}

.custom-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
}

.custom-modal-close {
    font-size: 24px;
    cursor: pointer;
    color: #999;
}

.custom-modal-body {
    padding: 20px;
}

.health-sections {
    display: grid;
    gap: 20px;
}

.health-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.health-section h5 {
    margin-bottom: 10px;
    color: #2d3748;
}

.health-section p {
    margin: 5px 0;
    font-size: 14px;
}

@media (max-width: 768px) {
    .system-grid, .actions-grid, .info-grid {
        grid-template-columns: 1fr;
    }
    
    .system-container {
        padding: 10px;
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}System - Super Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>⚙️ Tizim ma'lumotlari</h2>
                <a href="{{ url_for('super_admin_dashboard') }}" class="btn btn-outline-primary">
                    ← Dashboard ga qaytish
                </a>
            </div>
        </div>
    </div>

    <!-- Tizim holati -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">🗄️ Ma'lumotlar bazasi</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Jadvallar soni:</strong></p>
                            <h4 class="text-primary">{{ system.database.tables_count }}</h4>
                        </div>
                        <div class="col-6">
                            <p><strong>Environment:</strong></p>
                            <span class="badge bg-{{ 'success' if system.environment == 'production' else 'warning' }}">
                                {{ system.environment }}
                            </span>
                        </div>
                    </div>
                    <hr>
                    <p><strong>Jadvallar ro'yxati:</strong></p>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <ul class="list-group list-group-flush">
                            {% for table in system.database.tables %}
                            <li class="list-group-item py-1">{{ table }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">📊 Performance</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <h4 class="text-info">{{ system.performance.total_requests or 0 }}</h4>
                            <small class="text-muted">Jami so'rovlar</small>
                        </div>
                        <div class="col-6 mb-3">
                            <h4 class="text-success">{{ "%.2f"|format(system.performance.avg_response_time or 0) }}s</h4>
                            <small class="text-muted">O'rtacha javob vaqti</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-warning">{{ "%.2f"|format(system.performance.max_response_time or 0) }}s</h4>
                            <small class="text-muted">Maksimal vaqt</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-primary">{{ "%.2f"|format(system.performance.min_response_time or 0) }}s</h4>
                            <small class="text-muted">Minimal vaqt</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Server ma'lumotlari -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">🖥️ Server ma'lumotlari</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center border p-3 rounded">
                                <h5 class="text-primary">Flask</h5>
                                <small class="text-muted">Web Framework</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center border p-3 rounded">
                                <h5 class="text-success">SQLite</h5>
                                <small class="text-muted">Database</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center border p-3 rounded">
                                <h5 class="text-info">Python 3.12</h5>
                                <small class="text-muted">Runtime</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center border p-3 rounded">
                                <h5 class="text-warning">Replit</h5>
                                <small class="text-muted">Platform</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
