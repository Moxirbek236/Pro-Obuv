
{% extends "base.html" %}

{% block title %}Loglar - Super Admin{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="logs-header">
        <h1>📝 Tizim Loglari</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Loglar
        </div>
    </div>

    <!-- Log Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label>Log darajasi:</label>
            <select id="logLevel" onchange="filterLogs()">
                <option value="all">Barchasi</option>
                <option value="ERROR">ERROR</option>
                <option value="WARNING">WARNING</option>
                <option value="INFO">INFO</option>
                <option value="DEBUG">DEBUG</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Sana:</label>
            <input type="date" id="logDate" onchange="filterLogs()">
        </div>

        <div class="filter-group">
            <button class="btn btn-primary" onclick="refreshLogs()">🔄 Yangilash</button>
            <button class="btn btn-success" onclick="downloadLogs()">📄 Yuklab olish</button>
        </div>
    </div>

    <!-- Real-time Logs -->
    <div class="logs-section">
        <div class="logs-header-controls">
            <h3>📊 Real-time Logs</h3>
            <div class="log-controls">
                <button class="btn btn-sm btn-success" onclick="startAutoRefresh()">▶️ Auto Refresh</button>
                <button class="btn btn-sm btn-warning" onclick="stopAutoRefresh()">⏸️ Stop</button>
                <button class="btn btn-sm btn-danger" onclick="clearLogDisplay()">🗑️ Clear Display</button>
            </div>
        </div>

        <div class="logs-display" id="logsDisplay">
            <div class="log-entry info">
                <span class="log-time">{{ moment().format('YYYY-MM-DD HH:mm:ss') if moment else '2025-01-23 15:30:45' }}</span>
                <span class="log-level">INFO</span>
                <span class="log-message">Loglar yuklanyapti...</span>
            </div>
        </div>
    </div>

    <!-- System Performance -->
    <div class="performance-section">
        <h3>📈 Tizim Performance</h3>
        <div class="performance-grid">
            <div class="perf-card">
                <h4>🚀 Response Time</h4>
                <div class="perf-value" id="responseTime">0ms</div>
                <div class="perf-subtitle">O'rtacha javob vaqti</div>
            </div>

            <div class="perf-card">
                <h4>💾 Memory Usage</h4>
                <div class="perf-value" id="memoryUsage">0%</div>
                <div class="perf-subtitle">Xotira foydalanishi</div>
            </div>

            <div class="perf-card">
                <h4>🔢 Active Sessions</h4>
                <div class="perf-value" id="activeSessions">0</div>
                <div class="perf-subtitle">Faol sessiyalar</div>
            </div>

            <div class="perf-card">
                <h4>⚠️ Error Rate</h4>
                <div class="perf-value" id="errorRate">0%</div>
                <div class="perf-subtitle">Xatoliklar darajasi</div>
            </div>
        </div>
    </div>

    <!-- Error Summary -->
    <div class="errors-section">
        <h3>🚨 Oxirgi Xatoliklar</h3>
        <div id="errorsSummary" class="errors-list">
            <p class="text-center">Xatoliklar yuklanmoqda...</p>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
        <h3>🔄 So'nggi faollik</h3>
        <div id="recentActivity" class="activity-list">
            <div class="activity-item">
                <span class="activity-time">15:30:45</span>
                <span class="activity-type">LOGIN</span>
                <span class="activity-message">Super admin kirdi</span>
            </div>
            <div class="activity-item">
                <span class="activity-time">15:25:12</span>
                <span class="activity-type">ORDER</span>
                <span class="activity-message">Yangi buyurtma yaratildi: #10125</span>
            </div>
            <div class="activity-item">
                <span class="activity-time">15:20:33</span>
                <span class="activity-type">SYSTEM</span>
                <span class="activity-message">Database backup yaratildi</span>
            </div>
        </div>
    </div>
</div>

<script>
let autoRefreshInterval = null;

// Loglarni yuklash
function loadLogs() {
    const logLevel = document.getElementById('logLevel').value;
    const logDate = document.getElementById('logDate').value;

    // Real log files'dan ma'lumot olish
    fetch('/super-admin/get-logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            level: logLevel,
            date: logDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayLogs(data.logs);
        } else {
            // Fallback - mock data
            const mockLogs = [
                {
                    time: '2025-01-23 15:30:45',
                    level: 'INFO',
                    message: 'Yangi foydalanuvchi ro\'yxatdan o\'tdi: test@example.com',
                    source: 'auth.py:142'
                },
                {
                    time: '2025-01-23 15:30:40',
                    level: 'ERROR',
                    message: 'Database connection timeout',
                    source: 'database.py:67'
                },
                {
                    time: '2025-01-23 15:30:35',
                    level: 'WARNING',
                    message: 'Rate limit exceeded for IP: 192.168.1.100',
                    source: 'middleware.py:23'
                },
                {
                    time: '2025-01-23 15:30:30',
                    level: 'INFO',
                    message: 'Buyurtma yaratildi: #10125',
                    source: 'orders.py:89'
                }
            ];
            displayLogs(mockLogs);
        }
    })
    .catch(error => {
        console.error('Log yuklashda xatolik:', error);
        showErrorMessage('Loglarni yuklashda xatolik yuz berdi');
    });
}

// Loglarni ko'rsatish
function displayLogs(logs) {
    const container = document.getElementById('logsDisplay');
    container.innerHTML = '';

    logs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${log.level.toLowerCase()}`;
        logEntry.innerHTML = `
            <span class="log-time">${log.time}</span>
            <span class="log-level">${log.level}</span>
            <span class="log-source">${log.source || 'system'}</span>
            <span class="log-message">${log.message}</span>
        `;
        container.appendChild(logEntry);
    });

    // Auto scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Loglarni filtrlash
function filterLogs() {
    loadLogs();
}

// Loglarni yangilash
function refreshLogs() {
    loadLogs();
    loadPerformanceStats();
    loadErrorsSummary();
    showSuccessMessage('Loglar yangilandi');
}

// Auto refresh ni boshlash
function startAutoRefresh() {
    if (autoRefreshInterval) return;

    autoRefreshInterval = setInterval(() => {
        loadLogs();
        loadPerformanceStats();
    }, 5000); // 5 soniyada bir

    showSuccessMessage('Auto refresh yoqildi');
}

// Auto refresh ni to'xtatish
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        showSuccessMessage('Auto refresh o\'chirildi');
    }
}

// Log displayni tozalash
function clearLogDisplay() {
    document.getElementById('logsDisplay').innerHTML = '';
    showSuccessMessage('Log display tozalandi');
}

// Performance statistikalarini yuklash
function loadPerformanceStats() {
    fetch('/super-admin/get-performance-stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('responseTime').textContent = data.stats.responseTime + 'ms';
            document.getElementById('memoryUsage').textContent = data.stats.memoryUsage + '%';
            document.getElementById('activeSessions').textContent = data.stats.activeSessions;
            document.getElementById('errorRate').textContent = data.stats.errorRate + '%';
        } else {
            // Fallback mock data
            document.getElementById('responseTime').textContent = Math.floor(Math.random() * 500 + 200) + 'ms';
            document.getElementById('memoryUsage').textContent = Math.floor(Math.random() * 40 + 40) + '%';
            document.getElementById('activeSessions').textContent = Math.floor(Math.random() * 50 + 10);
            document.getElementById('errorRate').textContent = (Math.random() * 5).toFixed(1) + '%';
        }
    })
    .catch(error => {
        console.error('Performance stats xatolik:', error);
        // Fallback mock data
        document.getElementById('responseTime').textContent = Math.floor(Math.random() * 500 + 200) + 'ms';
        document.getElementById('memoryUsage').textContent = Math.floor(Math.random() * 40 + 40) + '%';
        document.getElementById('activeSessions').textContent = Math.floor(Math.random() * 50 + 10);
        document.getElementById('errorRate').textContent = (Math.random() * 5).toFixed(1) + '%';
    });
}

// Xatoliklar xulosasini yuklash
function loadErrorsSummary() {
    fetch('/super-admin/get-errors-summary')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('errorsSummary');
        
        if (data.success && data.errors.length > 0) {
            let html = '';
            data.errors.forEach(error => {
                html += `
                    <div class="error-item">
                        <span class="error-time">${error.time}</span>
                        <span class="error-message">${error.message}</span>
                        <span class="error-count">${error.count}x</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p class="text-center">Xatoliklar topilmadi</p>';
        }
    })
    .catch(error => {
        console.error('Errors summary xatolik:', error);
        document.getElementById('errorsSummary').innerHTML = '<p class="text-center">Xatoliklar ma\'lumotlarini yuklashda xatolik</p>';
    });
}

// Loglarni yuklab olish
function downloadLogs() {
    const logLevel = document.getElementById('logLevel').value;
    const logDate = document.getElementById('logDate').value;

    const params = new URLSearchParams({
        level: logLevel,
        date: logDate
    });

    window.open(`/super-admin/download-logs?${params.toString()}`, '_blank');
    showSuccessMessage('Loglar yuklab olinmoqda...');
}

// Success message
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Error message
function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => notification.remove(), 3000);
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    // Bugungi sanani o'rnatish
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('logDate').value = today;

    // Dastlabki ma'lumotlarni yuklash
    loadLogs();
    loadPerformanceStats();
    loadErrorsSummary();
});
</script>

<style>
.logs-container {
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
}

.logs-header {
    margin-bottom: 30px;
}

.logs-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.filters-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-group label {
    font-weight: 500;
    color: #2d3748;
    font-size: 14px;
}

.filter-group select,
.filter-group input {
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    min-width: 150px;
}

.logs-section,
.performance-section,
.errors-section,
.activity-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.logs-header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.log-controls {
    display: flex;
    gap: 10px;
}

.logs-display {
    background: #1a1a1a;
    color: #ffffff;
    border-radius: 8px;
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.5;
}

.log-entry {
    display: flex;
    margin-bottom: 8px;
    padding: 4px 0;
    border-bottom: 1px solid #333;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-time {
    color: #888;
    margin-right: 15px;
    min-width: 130px;
}

.log-level {
    font-weight: bold;
    margin-right: 15px;
    min-width: 60px;
}

.log-source {
    color: #6c757d;
    margin-right: 15px;
    min-width: 120px;
    font-size: 11px;
}

.log-message {
    flex: 1;
}

.log-entry.error .log-level { color: #ff4757; }
.log-entry.warning .log-level { color: #ffa502; }
.log-entry.info .log-level { color: #3742fa; }
.log-entry.debug .log-level { color: #2ed573; }

.performance-section h3,
.errors-section h3,
.activity-section h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.performance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.perf-card {
    text-align: center;
    padding: 20px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.perf-card h4 {
    margin-bottom: 15px;
    color: #2d3748;
    font-size: 1rem;
}

.perf-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 8px;
}

.perf-subtitle {
    color: #6c757d;
    font-size: 0.9rem;
}

.errors-list,
.activity-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.error-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #fff5f5;
    border-left: 4px solid #e53e3e;
    border-radius: 6px;
}

.error-time {
    color: #666;
    margin-right: 15px;
    min-width: 80px;
    font-size: 0.9rem;
}

.error-message {
    flex: 1;
    color: #2d3748;
}

.error-count {
    background: #e53e3e;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f7fafc;
    border-left: 4px solid #3182ce;
    border-radius: 6px;
}

.activity-time {
    color: #666;
    margin-right: 15px;
    min-width: 80px;
    font-size: 0.9rem;
}

.activity-type {
    background: #3182ce;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 15px;
    min-width: 80px;
    text-align: center;
}

.activity-message {
    flex: 1;
    color: #2d3748;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-primary { background: #007bff; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-danger { background: #dc3545; color: white; }

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification.success {
    background-color: #28a745;
}

.notification.error {
    background-color: #dc3545;
}

.text-center { text-align: center; }

/* Mobile responsive */
@media (max-width: 768px) {
    .logs-container {
        padding: 15px;
    }

    .filters-section {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-group {
        width: 100%;
    }

    .logs-header-controls {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }

    .log-controls {
        justify-content: center;
    }

    .performance-grid {
        grid-template-columns: 1fr;
    }

    .log-entry {
        flex-direction: column;
        gap: 5px;
    }

    .log-time,
    .log-level,
    .log-source {
        min-width: auto;
    }
}
</style>
{% endblock %}
