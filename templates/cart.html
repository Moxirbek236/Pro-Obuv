{% extends "base.html" %}

{% block title %}Savatcha - Restoran{% endblock %}

{% block head %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ config.get('YANDEX_MAPS_API', 'fc256b90-6f74-4f1b-a7ee-d42b695a8284') }}&lang=uz_UZ" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="card cart-section">
  <h2 class="section-title" data-translate="cart_title">üõí Savatcha</h2>

  {% if cart_items %}
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item">
        <div class="item-info">
          <h4>{{ item.name }}</h4>
          {% set discount_percentage = item['discount_percentage'] if item['discount_percentage'] else 0 %}
          {% if discount_percentage > 0 %}
            {% set discounted_price = item.price * (100 - discount_percentage) / 100 %}
            {% set discounted_total = discounted_price * item.quantity %}
            <p>
              <span style="text-decoration: line-through; color: #999; margin-right: 10px;">{{ "{:,.0f}".format(item.price) }} so'm</span>
              <span style="color: #28a745; font-weight: bold;">{{ "{:,.0f}".format(discounted_price) }} so'm</span>
              <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">-{{ discount_percentage }}%</span>
              <br>
              {{ item.quantity }} dona x {{ "{:,.0f}".format(discounted_price) }} = {{ "{:,.0f}".format(discounted_total) }} so'm
            </p>
          {% else %}
            <p>{{ "{:,.0f}".format(item.price) }} so'm x {{ item.quantity }} = {{ "{:,.0f}".format(item.total) }} so'm</p>
          {% endif %}
        </div>
        <form method="post" action="{{ url_for('remove_from_cart', cart_item_id=item.id) }}" style="margin-left: auto;">
          <button type="submit" class="btn small danger" onclick="return confirm('Rostdan ham olib tashlamoqchimisiz?')">
            üóëÔ∏è O'chirish
          </button>
        </form>
      </div>
      {% endfor %}
    </div>

    <div class="cart-total">
      <h3>Jami: {{ "{:,.0f}".format(total) }} so'm</h3>
    </div>

    <div class="cart-actions">
      {% if session.get('user_id') %}
        <form method="post" action="{{ url_for('place_order') }}" onsubmit="return validateOrder()"
            <h3>üìã Buyurtma berish</h3>

            <div class="order-type-selection">
                <h4 data-translate="order_type">Buyurtma turi:</h4>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="dine_in" checked onchange="toggleDeliveryFields()">
                        <span class="radio-text" data-translate="dine_in">üçΩÔ∏è Restoranda iste'mol qilish</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="delivery" onchange="toggleDeliveryFields()">
                        <span class="radio-text" data-translate="delivery">üöö Yetkazib berish</span>
                    </label>
                </div>
            </div>

            <div id="delivery-fields" class="delivery-section" style="display: none;">
                <h4>üìç Yetkazib berish ma'lumotlari:</h4>

                <!-- Ko'rsatma -->
                <div class="delivery-instructions">
                    <div class="instruction-card">
                        <h5>üìç Qanday foydalanish kerak:</h5>
                        <ul class="instruction-list">
                            <li>üó∫Ô∏è Xaritada o'zingizning joylashuvingizni tanlang</li>
                            <li>üîç Yoki quyidagi qidiruv orqali manzilni kiriting</li>
                            <li>‚úÖ Tanlangan joylashuv asosida eng yaqin filial aniqlanadi</li>
                            <li>üöö Yetkazib berish narxi va vaqti avtomatik hisoblanadi</li>
                        </ul>
                    </div>
                </div>

                <!-- Manzil qidirish -->
                <div class="address-search">
                    <input type="text" id="address-search" placeholder="Manzilni kiriting (masalan: Toshkent, Chilonzor)" class="form-control">
                    <button type="button" onclick="searchAddressOnMap()" class="btn btn-search">üîç Qidirish</button>
                </div>

                <!-- Xarita -->
                <div class="map-container">
                    <h5>üó∫Ô∏è Joylashuvingizni xaritadan tanlang:</h5>
                    <div id="map" style="height: 400px; border-radius: 12px; border: 2px solid #e2e8f0; margin-top: 10px;"></div>
                    <p class="map-hint">üí° <em>Xaritaga bosib o'zingizning aniq joylashuvingizni belgilang yoki GPS orqali avtomatik aniqlang</em></p>
                    
                    <!-- GPS va qidiruv tugmalari -->
                    <div class="map-controls" style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" onclick="getCurrentLocation()" class="btn btn-info">
                            üìç Joriy joylashuvni aniqlash
                        </button>
                        <button type="button" onclick="searchNearbyPlaces('restoran')" class="btn btn-secondary">
                            üè™ Yaqin restoranlar
                        </button>
                        <button type="button" onclick="searchNearbyPlaces('do\'kon')" class="btn btn-secondary">
                            üõí Yaqin do'konlar
                        </button>
                    </div>
                </div>

                <!-- Yetkazib berish ma'lumotlari -->
                <div id="delivery-info" class="delivery-info" style="display: none;">
                    <h4>üì¶ Yetkazib berish ma'lumotlari</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-icon">üè¢</span>
                            <div class="info-content">
                                <span class="info-label">Eng yaqin filial:</span>
                                <span id="branch-name" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üìè</span>
                            <div class="info-content">
                                <span class="info-label">Masofa:</span>
                                <span id="distance-display" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üí∞</span>
                            <div class="info-content">
                                <span class="info-label">Yetkazish narxi:</span>
                                <span id="delivery-price-display" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">‚è±Ô∏è</span>
                            <div class="info-content">
                                <span class="info-label">Yetkazish vaqti:</span>
                                <span id="delivery-time-display" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üì±</span>
                            <div class="info-content">
                                <span class="info-label">Filial telefoni:</span>
                                <span id="branch-phone" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">‚≠ê</span>
                            <div class="info-content">
                                <span class="info-label">Filial reytingi:</span>
                                <span id="branch-rating" class="info-value">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yetkazish haritasi -->
                    <div class="delivery-route-info">
                        <h5>üó∫Ô∏è Yetkazish yo'li</h5>
                        <div class="route-details">
                            <div class="route-item">
                                <span class="route-icon">üìç</span>
                                <span class="route-text">Boshlang'ich nuqta: <span id="branch-address">-</span></span>
                            </div>
                            <div class="route-item">
                                <span class="route-icon">üè†</span>
                                <span class="route-text">Yetkazish manzili: <span id="delivery-address-display">-</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Yetkazish shartlari -->
                    <div class="delivery-terms">
                        <h6>üìã Yetkazib berish shartlari:</h6>
                        <ul class="terms-list">
                            <li>‚úÖ Minimal buyurtma summasi: 50,000 so'm</li>
                            <li>‚úÖ Yetkazib berish radiusi: 15 km gacha</li>
                            <li>‚úÖ Taxminiy yetkazib berish vaqti ko'rsatilgan</li>
                            <li>‚úÖ To'lov naqd yoki kartada</li>
                        </ul>
                    </div>
                </div>
                            <span class="info-icon">‚è±Ô∏è</span>
                            <div class="info-content">
                                <span class="info-label">Taxminiy vaqt:</span>
                                <span id="delivery-time-display" class="info-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yashirin maydonlar -->
                <input type="hidden" id="delivery_address" name="delivery_address">
                <input type="hidden" id="delivery_latitude" name="delivery_latitude">
                <input type="hidden" id="delivery_longitude" name="delivery_longitude">
                <input type="hidden" id="delivery_distance" name="delivery_distance">
                <input type="hidden" id="delivery_price" name="delivery_price">
                <input type="hidden" id="delivery_time" name="delivery_time">
                <input type="hidden" id="branch_id" name="branch_id">
            </div>

            <div class="total-section">
                <div class="total-breakdown">
                    <div class="total-item">
                        <span>Mahsulotlar:</span>
                        <span>{{ "{:,.0f}".format(total) }} so'm</span>
                    </div>
                    <div class="delivery-cost-info">
                        <span class="delivery-cost">Yetkazib berish: <span id="delivery-cost-text">Bepul</span></span>
                    </div>
                    <div class="total-final">
                        <strong>Jami summa: <span id="total-amount">{{ "{:,.0f}".format(total) }} so'm</span></strong>
                    </div>
                </div>
                <button type="submit" class="btn checkout-btn" onclick="return validateOrder()">üõí Buyurtma berish</button>
            </div>
        </form>

        <script>
function handleFormSubmit(form) {
    console.log("Form submit boshlandi");
    
    // Order type ni tekshirish
    const orderTypeElement = document.querySelector('input[name="order_type"]:checked');
    if (!orderTypeElement) {
        alert('Iltimos, buyurtma turini tanlang!');
        return false;
    }
    
    const orderType = orderTypeElement.value;
    console.log("Order type:", orderType);
    
    // Agar yetkazib berish tanlangan bo'lsa, manzilni tekshiramiz
    if (orderType === 'delivery') {
        const deliveryAddress = document.getElementById('delivery_address').value;
        const deliveryLatitude = document.getElementById('delivery_latitude').value;
        const deliveryLongitude = document.getElementById('delivery_longitude').value;
        const branchId = document.getElementById('branch_id').value;
        
        console.log("Delivery ma'lumotlari:", {
            address: deliveryAddress,
            lat: deliveryLatitude,
            lng: deliveryLongitude,
            branchId: branchId
        });

        if (!deliveryAddress) {
            alert('Iltimos, xaritadan yetkazib berish manzilini tanlang!');
            return false;
        }

        if (!deliveryLatitude || !deliveryLongitude) {
            alert('Iltimos, xaritadan aniq joylashuvni tanlang!');
            return false;
        }

        if (!branchId) {
            alert('Filial aniqlanmadi. Iltimos, manzilni qaytadan tanlang!');
            return false;
        }
    }

    console.log("Barcha tekshiruvlar muvaffaqiyatli o'tdi");
    return true;
}


let map;
let userMarker;
let branchMarker;
let routeLine;
let nearestBranch = null;
let mapInitialized = false;

function initMap() {
    // Agar xarita allaqachon yaratilgan bo'lsa, qayta yaratmaymiz
    if (mapInitialized || map) {
        console.log("Xarita allaqachon yaratilgan");
        return;
    }

    ymaps.ready(function() {
        // Xarita containerini tekshirish
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.log("Xarita container topilmadi");
            return;
        }

        // Agar container ichida allaqachon xarita bo'lsa, tozalash
        if (mapContainer.innerHTML.trim() !== '') {
            mapContainer.innerHTML = '';
        }

        try {
            // Foydalanuvchi joylashuvi (profil yoki default)
            const userLat = parseFloat('{{ session.get("user_address_latitude", "") }}') || 41.2995;
            const userLng = parseFloat('{{ session.get("user_address_longitude", "") }}') || 69.2401;

            // Xarita yaratish
            map = new ymaps.Map('map', {
                center: [userLat, userLng],
                zoom: 12,
                controls: ['zoomControl', 'fullscreenControl']
            });

            mapInitialized = true;
            console.log("Xarita muvaffaqiyatli yaratildi");

            // Foydalanuvchi joylashuvini belgilash
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = [position.coords.latitude, position.coords.longitude];
                    setUserLocation(userLocation);
                }, function(error) {
                    console.log("Joylashuv olishda xatolik:", error);
                    setUserLocation([userLat, userLng]);
                });
            } else {
                setUserLocation([userLat, userLng]);
            }

            // Xarita bosilganda yangi joylashuv tanlash
            map.events.add('click', function(e) {
                const coords = e.get('coords');
                setUserLocation(coords);
            });

        } catch (error) {
            console.error("Xarita yaratishda xatolik:", error);
            mapInitialized = false;
        }
    });
}

function setUserLocation(coords) {
    // Avvalgi markerlarni olib tashlash
    if (userMarker) {
        map.geoObjects.remove(userMarker);
    }
    if (branchMarker) {
        map.geoObjects.remove(branchMarker);
    }
    if (routeLine) {
        map.geoObjects.remove(routeLine);
    }

    // Foydalanuvchi markeri
    userMarker = new ymaps.Placemark(coords, {
        hintContent: 'Sizning joylashuvingiz',
        balloonContent: 'Yetkazib berish manzili'
    }, {
        iconColor: '#ff6b6b',
        draggable: true
    });

    map.geoObjects.add(userMarker);

    // Marker tortilganda yangi joylashuv
    userMarker.events.add('dragend', function() {
        const newCoords = userMarker.geometry.getCoordinates();
        setUserLocation(newCoords);
    });

    // Koordinatalarni darhol saqlash
    document.getElementById('delivery_latitude').value = coords[0];
    document.getElementById('delivery_longitude').value = coords[1];

    // Manzilni olish
    ymaps.geocode(coords).then(function(res) {
        const firstGeoObject = res.geoObjects.get(0);
        let address = '';

        if (firstGeoObject) {
            address = firstGeoObject.getAddressLine();
        } else {
            address = `Lat: ${coords[0].toFixed(6)}, Lng: ${coords[1].toFixed(6)}`;
        }

        document.getElementById('delivery_address').value = address;
        console.log("Manzil saqlandi:", address);
    }).catch(function(error) {
        console.log("Manzil olishda xatolik:", error);
        const fallbackAddress = `Lat: ${coords[0].toFixed(6)}, Lng: ${coords[1].toFixed(6)}`;
        document.getElementById('delivery_address').value = fallbackAddress;
    });

    // Eng yaqin filialni topish
    findNearestBranchAndRoute(coords);
}

// GPS joylashuvni olish funksiyasi
function getCurrentLocation() {
    if (navigator.geolocation) {
        // Loading ko'rsatish
        showLocationLoading(true);
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLocation = [position.coords.latitude, position.coords.longitude];
                console.log('GPS joylashuv olindi:', userLocation);
                
                // Xaritani GPS joylashuvga o'tkazish
                if (map) {
                    map.setCenter(userLocation, 15);
                    setUserLocation(userLocation);
                }
                
                showLocationLoading(false);
                showNotification('üéØ Joylashuvingiz muvaffaqiyatli aniqlandi!', 'success');
            },
            function(error) {
                showLocationLoading(false);
                console.error('GPS xatoligi:', error);
                
                let errorMessage = 'GPS orqali joylashuv aniqlanmadi.';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'GPS ruxsati berilmadi. Brauzer sozlamalaridan ruxsat bering.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'GPS ma\'lumotlari mavjud emas.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'GPS timeout xatoligi.';
                        break;
                }
                
                showNotification('‚ùå ' + errorMessage, 'error');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        showNotification('‚ùå GPS bu brauzerda qo\'llab-quvvatlanmaydi', 'error');
    }
}

// Yaqin joylarni qidirish
function searchNearbyPlaces(query) {
    if (!map) {
        showNotification('‚ùå Xarita yuklanmadi', 'error');
        return;
    }
    
    const currentCenter = map.getCenter();
    console.log('Yaqin joylarni qidirish:', query, currentCenter);
    
    // Loading ko'rsatish
    showLocationLoading(true);
    
    // API orqali qidirish (agar mavjud bo'lsa)
    fetch('/api/search-nearby-places', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            latitude: currentCenter[0],
            longitude: currentCenter[1],
            radius: 2000 // 2km radius
        })
    })
    .then(response => response.json())
    .then(data => {
        showLocationLoading(false);
        if (data.success && data.places && data.places.length > 0) {
            // Topilgan joylarni xaritaga qo'shish
            data.places.forEach((place, index) => {
                if (place.latitude && place.longitude) {
                    const placeMarker = new ymaps.Placemark([place.latitude, place.longitude], {
                        hintContent: place.name || `${query} ${index + 1}`,
                        balloonContent: `<strong>${place.name || query}</strong><br>${place.address || 'Manzil noma\'lum'}`
                    }, {
                        iconColor: '#FF6B6B',
                        preset: 'islands#redCircleIcon'
                    });
                    
                    map.geoObjects.add(placeMarker);
                    
                    // Marker bosilganda joylashuvni tanlash
                    placeMarker.events.add('click', function() {
                        setUserLocation([place.latitude, place.longitude]);
                        showNotification(`üìç ${place.name || query} tanlandi`, 'success');
                    });
                }
            });
            
            showNotification(`üéØ ${data.places.length} ta ${query} topildi`, 'success');
        } else {
            showNotification(`‚ùå Yaqin atrofda ${query} topilmadi`, 'warning');
        }
    })
    .catch(error => {
        showLocationLoading(false);
        console.error('Yaqin joylarni qidirishda xatolik:', error);
        showNotification('‚ùå Qidirishda xatolik yuz berdi', 'error');
    });
}

// Loading holatini ko'rsatish/yashirish
function showLocationLoading(show) {
    let loadingEl = document.getElementById('location-loading');
    
    if (show) {
        if (!loadingEl) {
            loadingEl = document.createElement('div');
            loadingEl.id = 'location-loading';
            loadingEl.className = 'alert alert-info';
            loadingEl.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Joylashuv aniqlanmoqda...</span>
                </div>
            `;
            document.getElementById('map').parentNode.appendChild(loadingEl);
        }
        loadingEl.style.display = 'block';
    } else {
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
    }
}

// Bildirishnoma ko'rsatish
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 350px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideInRight 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <span style="margin-right: 8px;">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Avtomatik olib tashlash
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
    }, 5000);
}

function findNearestBranchAndRoute(userCoords) {
    fetch('/api/find-nearest-branch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            latitude: userCoords[0],
            longitude: userCoords[1]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nearestBranch = data;
            const branchCoords = [data.branch.latitude, data.branch.longitude];

            // Avvalgi filial markerini olib tashlash
            if (branchMarker) {
                map.geoObjects.remove(branchMarker);
            }
            
            // Filial markeri
            branchMarker = new ymaps.Placemark(branchCoords, {
                hintContent: data.branch.name,
                balloonContent: `
                    <div style="max-width: 200px;">
                        <strong>${data.branch.name}</strong><br>
                        üìç ${data.branch.address}<br>
                        üìû ${data.branch.phone || 'Telefon noma\'lum'}<br>
                        ‚≠ê Reyting: ${data.branch.rating || 'N/A'}<br>
                        üïí ${data.branch.working_hours || '09:00-22:00'}
                    </div>
                `
            }, {
                iconColor: '#4CAF50',
                preset: 'islands#greenHomeIcon'
            });

            map.geoObjects.add(branchMarker);

            // Yo'lni chizish - yaxshilangan usul
            ymaps.route([branchCoords, userCoords], {
                multiRoute: false,
                routingMode: 'auto',
                avoidTrafficJams: true
            }).then(function(route) {
                // Avvalgi yo'lni olib tashlash
                if (routeLine) {
                    map.geoObjects.remove(routeLine);
                }
                
                routeLine = route;
                map.geoObjects.add(route);

                // Yo'l ma'lumotlarini olish
                const routeLength = route.getLength(); // metrda
                const routeTime = route.getTime(); // soniyada
                
                // Realtime ma'lumotlarni yangilash
                const realDistance = routeLength / 1000; // km ga o'tkazish
                const realTime = Math.ceil(routeTime / 60); // daqiqaga o'tkazish
                
                // Kuryer hisob-kitoblari
                const courierSpeedKmPerMin = 1/10; // 10 daqiqada 1km
                const courierTime = Math.ceil(realDistance / courierSpeedKmPerMin);
                const courierCost = realDistance * 10000; // 1km = 10,000 so'm
                
                // Umumiy vaqt hisoblash
                const prepTime = 15; // buyurtma tayyorlash vaqti (daqiqa)
                const packTime = 5;  // qadoqlash vaqti (daqiqa)
                const totalTime = prepTime + packTime + courierTime;
                
                // Ma'lumotlarni yangilash
                const updatedData = {
                    ...data,
                    distance: realDistance.toFixed(1),
                    delivery_cost: Math.round(courierCost),
                    delivery_time: totalTime,
                    courier_time: courierTime,
                    prep_time: prepTime,
                    pack_time: packTime
                };

                // Xaritani yo'lga moslash
                map.setBounds(route.getBounds(), {
                    checkZoomRange: true,
                    zoomMargin: 30
                });

                // Ma'lumotlarni ko'rsatish
                updateDeliveryInfo(updatedData);
                
                console.log('Yo\'l ma\'lumotlari:', {
                    realDistance: realDistance.toFixed(1) + 'km',
                    courierTime: courierTime + ' daqiqa',
                    courierCost: courierCost.toLocaleString() + ' so\'m',
                    totalTime: totalTime + ' daqiqa'
                });
                
            }).catch(function(error) {
                console.error('Yo\'l chizishda xatolik:', error);
                
                // Fallback - oddiy chiziq va hisob-kitob
                if (routeLine) {
                    map.geoObjects.remove(routeLine);
                }
                
                const simpleLine = new ymaps.Polyline([branchCoords, userCoords], {
                    hintContent: 'Taxminiy yo\'l'
                }, {
                    strokeColor: '#4CAF50',
                    strokeWidth: 4,
                    strokeOpacity: 0.8,
                    strokeStyle: 'dash'
                });
                map.geoObjects.add(simpleLine);
                routeLine = simpleLine;

                // Fallback hisob-kitoblar
                const fallbackDistance = calculateDistance(branchCoords, userCoords);
                const fallbackCourierTime = Math.ceil(fallbackDistance * 10); // 1km = 10 daqiqa
                const fallbackCourierCost = fallbackDistance * 10000;
                const fallbackTotalTime = 15 + 5 + fallbackCourierTime; // prep + pack + delivery
                
                const fallbackData = {
                    ...data,
                    distance: fallbackDistance.toFixed(1),
                    delivery_cost: Math.round(fallbackCourierCost),
                    delivery_time: fallbackTotalTime,
                    courier_time: fallbackCourierTime,
                    prep_time: 15,
                    pack_time: 5
                };
                
                updateDeliveryInfo(fallbackData);
                showNotification('‚ö†Ô∏è Aniq yo\'l aniqlanmadi, taxminiy ma\'lumotlar ko\'rsatildi', 'warning');
            });
        } else {
            // Filial topilmagan holatda
            document.getElementById('delivery-info').style.display = 'none';
            
            showNotification('‚ö†Ô∏è Yaqin atrofda faol filial topilmadi', 'warning');
        }
    })
    .catch(error => {
        console.error('Filial topishda xatolik:', error);
        showNotification('‚ùå Filial ma\'lumotlarini yuklashda xatolik', 'error');
    });
}

// Haversine masofani hisoblash funksiyasi
function calculateDistance(coords1, coords2) {
    const R = 6371; // Yer radiusi km
    const dLat = (coords2[0] - coords1[0]) * Math.PI / 180;
    const dLon = (coords2[1] - coords1[1]) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(coords1[0] * Math.PI / 180) * Math.cos(coords2[0] * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function updateDeliveryInfo(data) {
    // Ma'lumotlarni ko'rsatish
    document.getElementById('branch-name').textContent = data.branch.name;
    document.getElementById('distance-display').textContent = data.distance + ' km';
    document.getElementById('delivery-price-display').textContent = data.delivery_cost.toLocaleString() + ' so\'m';
    
    // Batafsil vaqt ma'lumotlari
    const timeBreakdown = `
        Jami: ${data.delivery_time} daqiqa
        (Tayyorlash: ${data.prep_time || 15} daq + 
        Qadoqlash: ${data.pack_time || 5} daq + 
        Yetkazish: ${data.courier_time || data.delivery_time - 20} daq)
    `;
    document.getElementById('delivery-time-display').textContent = timeBreakdown;

    // Qo'shimcha ma'lumotlar
    if (document.getElementById('branch-phone')) {
        document.getElementById('branch-phone').textContent = data.branch.phone || 'Ma\'lumot yo\'q';
    }
    
    if (document.getElementById('branch-rating')) {
        const rating = data.branch.rating || data.branch.average_rating || 'N/A';
        document.getElementById('branch-rating').textContent = rating;
    }
    
    if (document.getElementById('branch-address')) {
        document.getElementById('branch-address').textContent = data.branch.address;
    }
    
    if (document.getElementById('delivery-address-display')) {
        document.getElementById('delivery-address-display').textContent = document.getElementById('delivery_address').value || 'Tanlanmagan';
    }

    // Yashirin maydonlarni to'ldirish
    document.getElementById('delivery_distance').value = data.distance;
    document.getElementById('delivery_price').value = data.delivery_cost;
    document.getElementById('delivery_time').value = data.delivery_time;
    document.getElementById('branch_id').value = data.branch.id;

    // Info panelni ko'rsatish
    document.getElementById('delivery-info').style.display = 'block';

    // Umumiy summani yangilash
    updateTotalAmount();
    
    // Muvaffaqiyatli bildirishnoma
    showNotification(`‚úÖ Eng yaqin filial topildi: ${data.branch.name} (${data.distance} km)`, 'success');
}

function searchAddressOnMap() {
    const address = document.getElementById("address-search").value;
    if (!address) {
        alert("Manzil kiritilmagan!");
        return;
    }

    ymaps.geocode(address + ", Toshkent", {
        results: 1
    }).then(function(res) {
        if (res.geoObjects.getLength() > 0) {
            const firstGeoObject = res.geoObjects.get(0);
            const coords = firstGeoObject.geometry.getCoordinates();

            setUserLocation(coords);
            map.setCenter(coords, 15);
        } else {
            alert("Manzil topilmadi!");
        }
    });
}

function toggleDeliveryFields() {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    const deliveryFields = document.getElementById('delivery-fields');

    if (deliveryRadio.checked) {
        deliveryFields.style.display = 'block';

        // Xaritani yuklash - faqat bir marta
        setTimeout(() => {
            if (!mapInitialized && !map) {
                console.log("Xaritani yuklamoqda...");
                initMap();
            } else if (map) {
                // Mavjud xaritani qayta o'lchamlash
                try {
                    map.container.fitToViewport();
                    console.log("Xarita qayta o'lchanglandi");
                } catch (error) {
                    console.log("Xaritani qayta o'lchanglashda xatolik:", error);
                }
            }
        }, 200);
    } else {
        deliveryFields.style.display = 'none';
        updateTotalAmount();
    }
}

function updateTotalAmount() {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    const totalElement = document.getElementById('total-amount');
    const deliveryCostElement = document.getElementById('delivery-cost-text');

    let baseTotal = {{ total }};
    let deliveryCost = 0;

    if (deliveryRadio && deliveryRadio.checked) {
        deliveryCost = parseFloat(document.getElementById('delivery_price').value) || 0;
    }

    if (deliveryCostElement) {
        if (deliveryCost > 0) {
            deliveryCostElement.textContent = deliveryCost.toLocaleString() + ' so\'m';
        } else {
            deliveryCostElement.textContent = 'Bepul';
        }
    }

    if (totalElement) {
        totalElement.textContent = (baseTotal + deliveryCost).toLocaleString() + ' so\'m';
    }
}

function validateOrder() {
    console.log("validateOrder funksiyasi ishga tushdi");
    
    const orderType = document.querySelector('input[name="order_type"]:checked');

    if (!orderType) {
        alert('Buyurtma turini tanlang!');
        return false;
    }

    console.log("Tanlangan buyurtma turi:", orderType.value);

    if (orderType.value === 'delivery') {
        const deliveryAddress = document.getElementById('delivery_address').value;
        const deliveryLatitude = document.getElementById('delivery_latitude').value;
        const deliveryLongitude = document.getElementById('delivery_longitude').value;
        const branchId = document.getElementById('branch_id').value;

        console.log("Delivery validation:", {
            address: deliveryAddress,
            lat: deliveryLatitude,
            lng: deliveryLongitude,
            branchId: branchId
        });

        if (!deliveryAddress) {
            alert('Yetkazib berish manzilini xaritadan tanlang!');
            return false;
        }

        if (!deliveryLatitude || !deliveryLongitude) {
            alert('Iltimos, xaritadan aniq joylashuvni tanlang!');
            return false;
        }
        
        if (!branchId) {
            alert('Filial tanlanmadi. Iltimos, manzilni qaytadan tanlang!');
            return false;
        }
    }

    const confirmed = confirm('Buyurtma berishni tasdiqlaysizmi?');
    console.log("Tasdiqlash natijasi:", confirmed);
    return confirmed;
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="order_type"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', toggleDeliveryFields);
    });

    // Barcha mavjud xarita class elementlarini tekshirish va duplikatni olib tashlash
    const mapElements = document.querySelectorAll('.ymaps-2-1-79-map');
    if (mapElements.length > 1) {
        console.log("Ko'p xarita elementi topildi, duplikatlarni olib tashlamoqda...");
        // Birinchisidan tashqari barchasini olib tashlash
        for (let i = 1; i < mapElements.length; i++) {
            mapElements[i].remove();
        }
    }
});
        </script>
      {% else %}
        <div class="alert alert-warning">
          <p>Buyurtma berish uchun avval tizimga kiring</p>
          <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('menu') }}" class="btn">‚¨ÖÔ∏è Menuga qaytish</a>
            <a href="{{ url_for('login_page') }}" class="btn big" style="background: #4CAF50;">üîê Foydalanuvchi kirishi</a>
            <a href="{{ url_for('register') }}" class="btn big" style="background: #2196F3;">üìù Ro'yxatdan o'tish</a>
          </div>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="empty-cart">
      <p>Savatchangiz bo'sh</p>
      <a href="{{ url_for('menu') }}" class="btn big">üçΩÔ∏è Taom tanlash</a>
    </div>
  {% endif %}
</div>

<style>
.cart-item {
  display: flex;
  align-items: center;
  padding: 20px;
  border: 1px solid #e2e8f0;
  border-radius: 15px;
  margin-bottom: 15px;
  background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.cart-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.item-info h4 {
  margin: 0 0 8px 0;
  color: #2d3748;
  font-size: 18px;
  font-weight: 600;
}

.item-info p {
  margin: 0;
  color: #4a5568;
  font-weight: 500;
}

.cart-total {
  text-align: center;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.cart-total h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.delivery-section {
  background: #f8f9fa;
  padding: 25px;
  border-radius: 15px;
  margin: 20px 0;
  border-left: 4px solid #007bff;
}

.delivery-instructions {
  margin-bottom: 20px;
}

.instruction-card {
  background: linear-gradient(145deg, #ffffff 0%, #f0f7ff 100%);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #e3f2fd;
  box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.instruction-card h5 {
  color: #1565c0;
  margin: 0 0 15px 0;
  font-weight: 600;
  font-size: 16px;
}

.instruction-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.instruction-list li {
  padding: 8px 0;
  color: #424242;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.instruction-list li:not(:last-child) {
  border-bottom: 1px solid rgba(0,123,255,0.1);
}

.map-hint {
  text-align: center;
  color: #6c757d;
  font-size: 13px;
  margin: 8px 0 0 0;
  font-style: italic;
}

.map-container {
  margin: 20px 0;
}

.map-container h5 {
  margin-bottom: 15px;
  color: #2d3748;
  font-weight: 600;
}

.address-search {
  display: flex;
  gap: 12px;
  margin: 0 0 20px 0;
  padding: 15px;
  background: white;
  border-radius: 10px;
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.address-search input {
  flex: 1;
  padding: 12px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 15px;
  transition: border-color 0.3s ease;
}

.address-search input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.btn-search {
  padding: 12px 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
}

.btn-search:hover {
  background: #0056b3;
}

.delivery-info {
  background: #e8f5e8;
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
  border-left: 4px solid #28a745;
}

.delivery-info h4 {
  margin: 0 0 20px 0;
  color: #155724;
  font-size: 18px;
  font-weight: 600;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.info-icon {
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #f0f9ff;
  border-radius: 50%;
}

.info-content {
  flex: 1;
}

.info-label {
  display: block;
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
  margin-bottom: 2px;
}

.info-value {
  display: block;
  font-size: 14px;
  color: #1f2937;
  font-weight: 600;
}

.total-breakdown {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.total-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.delivery-cost-info {
  margin-bottom: 8px;
  font-size: 14px;
}

.delivery-cost {
  color: #28a745;
  font-weight: 500;
}

.total-final {
  border-top: 2px solid #dee2e6;
  padding-top: 10px;
  margin-top: 10px;
  font-size: 16px;
}

.checkout-btn {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.checkout-btn:hover {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  transform: translateY(-2px);
}

.radio-group {
  display: flex;
  gap: 20px;
  margin: 15px 0;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 10px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.radio-option:hover {
  border-color: #4299e1;
  background: #f7fafc;
}

.radio-option input[type="radio"] {
  margin: 0;
}

.radio-text {
  font-weight: 500;
  color: #2d3748;
}

.empty-cart {
  text-align: center;
  padding: 60px;
  color: #718096;
}

.btn.danger {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  border: none;
  transition: all 0.3s ease;
}

.btn.danger:hover {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  transform: translateY(-1px);
}

/* Notification animatsiyalari */
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* Map controls styling */
.map-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.map-controls .btn {
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.map-controls .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Loading spinner */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}

/* Enhanced info display */
.info-item {
    position: relative;
    overflow: hidden;
}

.info-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.info-item:hover::before {
    opacity: 1;
}

/* Delivery route styling */
.delivery-route-info {
    background: #f8f9ff;
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
    border-left: 4px solid #007bff;
}

.route-details {
    margin-top: 10px;
}

.route-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 14px;
}

.route-icon {
    font-size: 16px;
    min-width: 20px;
}

.route-text {
    flex: 1;
    color: #495057;
}

/* Delivery terms styling */
.delivery-terms {
    background: #fff9e6;
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
    border-left: 4px solid #ffc107;
}

.terms-list {
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
}

.terms-list li {
    padding: 5px 0;
    font-size: 13px;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Enhanced time display */
#delivery-time-display {
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-line;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .info-grid {
        grid-template-columns: 1fr;
    }

    .radio-group {
        flex-direction: column;
        gap: 10px;
    }

    .address-search {
        flex-direction: column;
    }
    
    .map-controls {
        flex-direction: column;
    }
    
    .map-controls .btn {
        width: 100%;
        text-align: center;
    }
    
    #map {
        height: 300px !important;
    }
    
    .notification-toast {
        right: 10px !important;
        left: 10px !important;
        max-width: none !important;
    }
}
</style>
{% endblock %}