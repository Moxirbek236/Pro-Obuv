{% extends "base.html" %}

{% block title %}Savatcha - Restoran{% endblock %}

{% block head %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOti4mM-6x9WDnZIjIeyEU21OpxXqWBgw&libraries=geometry&callback=initMap"></script>
{% endblock %}

{% block content %}
<div class="card">
  <h2>üõí Savatcha</h2>

  {% if cart_items %}
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item">
        <div class="item-info">
          <h4>{{ item.name }}</h4>
          <p>{{ "{:,.0f}".format(item.price) }} so'm x {{ item.quantity }} = {{ "{:,.0f}".format(item.total) }} so'm</p>
        </div>
        <form method="post" action="{{ url_for('remove_from_cart', cart_item_id=item.id) }}" style="margin-left: auto;">
          <button type="submit" class="btn small danger" onclick="return confirm('Rostdan ham olib tashlamoqchimisiz?')">
            üóëÔ∏è O'chirish
          </button>
        </form>
      </div>
      {% endfor %}
    </div>

    <div class="cart-total">
      <h3>Jami: {{ "{:,.0f}".format(total) }} so'm</h3>
    </div>

    <div class="cart-actions">
      {% if session.get('user_id') %}
        <form method="post" action="{{ url_for('user_page') }}" class="checkout-form">
            <h3>üìã Buyurtma berish</h3>

            <div class="order-type-selection">
                <h4>Buyurtma turi:</h4>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="dine_in" checked onchange="toggleDeliveryFields()">
                        <span class="radio-text">üçΩÔ∏è Restoranda iste'mol qilish</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="delivery" onchange="toggleDeliveryFields()">
                        <span class="radio-text">üöö Yetkazib berish</span>
                    </label>
                </div>
            </div>

            <div id="delivery-fields" class="delivery-section" style="display: none;">
                <h4>üìç Yetkazib berish ma'lumotlari:</h4>

                <!-- Profil ma'lumotlari ko'rsatish -->
                <div class="profile-info">
                    <div class="info-row">
                        <span class="info-label">üì± Telefon:</span>
                        <span class="info-value">{{ session.get('user_phone', 'Kiritilmagan') }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">üè† Manzil:</span>
                        <span class="info-value">{{ session.get('user_address', 'Kiritilmagan') }}</span>
                    </div>
                </div>

                <!-- Xaritada joylashuvni tanlash -->
                <div class="map-selection">
                    <label for="location-map">üìç Xaritada joylashuvni belgilang:</label>
                    <div id="location-map-container" style="height: 300px; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                        <div id="location-map" style="height: 100%; width: 100%;"></div>
                    </div>
                    <div class="selected-location">
                        <p><strong>Tanlangan joylashuv:</strong></p>
                        <p id="selected-address">Xaritada joyni belgilang</p>
                        <input type="hidden" id="delivery_address" name="delivery_address">
                        <input type="hidden" id="delivery_latitude" name="delivery_latitude">
                        <input type="hidden" id="delivery_longitude" name="delivery_longitude">
                    </div>
                </div>

                <!-- Manzil qidirish -->
                <div class="mb-3">
                    <label for="address-search" class="form-label">Manzilni qidiring:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="address-search" placeholder="Masalan: Amir Temur ko'chasi">
                        <button type="button" class="btn btn-outline-primary" onclick="searchAddressOnMap()">üîç Qidirish</button>
                    </div>
                </div>


                <!-- Karta ma'lumotlari -->
                <div class="card-info">
                    {% if session.get('user_card_number') %}
                        <div class="info-row">
                            <span class="info-label">üí≥ Karta:</span>
                            <span class="info-value">**** **** **** {{ session.get('user_card_number')[-4:] if session.get('user_card_number') else '' }}</span>
                        </div>
                    {% else %}
                        <div class="form-group">
                            <label for="card_number">üí≥ Karta raqami:</label>
                            <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456"
                                   pattern="[0-9\s]{13,19}" maxlength="19" required>
                            <small class="text-muted">To'lov uchun karta raqamini kiriting</small>
                        </div>
                    {% endif %}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="delivery_distance">Masofa (km):</label>
                        <input type="number" id="delivery_distance" name="delivery_distance" step="0.1" min="0" placeholder="Avtomatik hisoblanadi" readonly>
                    </div>
                    <div class="form-group">
                        <label for="courier_delivery_time">Kuryer taxminiy yetkazish vaqti (daqiqa):</label>
                        <input type="number" id="courier_delivery_time" name="courier_delivery_time" min="10" max="120" placeholder="30" required>
                        <small class="text-muted">Kuryer qancha vaqtda yetkazishini kiriting</small>
                    </div>
                </div>

                <div class="delivery-info">
                    <div class="info-item">
                        <span class="info-icon">‚è±Ô∏è</span>
                        <span class="info-text">Taxminiy yetkazib berish vaqti: 25-45 daqiqa</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üìû</span>
                        <span class="info-text">Kuryer sizga yetib borgunga qadar qo'ng'iroq qiladi</span>
                    </div>
                </div>
            </div>
            <div class="total-section">
                <div class="total-breakdown">
                    <div class="total-item">
                        <span>Mahsulotlar:</span>
                        <span>{{ total }} so'm</span>
                    </div>
                    <div class="delivery-cost-info">
                        <small class="delivery-cost">Yetkazib berish: Bepul</small>
                    </div>
                    <div class="total-final">
                        <strong>Jami summa: <span id="total-amount" class="total-amount">{{ total }} so'm</span></strong>
                    </div>
                </div>
                <button type="submit" class="btn checkout-btn">üõí Buyurtma berish</button>
            </div>
        </form>
        <script>
let map;
let marker;
let selectedLocation = null;
let geocoder;
let autocomplete;

function initMap() {
    // Toshkent markazi
    const tashkent = { lat: 41.2995, lng: 69.2401 };

    map = new google.maps.Map(document.getElementById("location-map"), {
        zoom: 12,
        center: tashkent,
    });

    geocoder = new google.maps.Geocoder();

    // Autocomplete
    const input = document.getElementById("address-search");
    const options = {
        componentRestrictions: { country: "uz" },
        fields: ["formatted_address", "geometry", "name"],
        strictBounds: false,
    };
    autocomplete = new google.maps.places.Autocomplete(input, options);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            // Browser support doesn't support the function.
            window.alert("No details available for input: '" + place.name + "'");
            return;
        }
        // Agar joy tanlangan bo'lsa, uni xaritaga qo'yish
        setDeliveryLocation(place.geometry.location);
        map.setCenter(place.geometry.location);
        map.setZoom(15);
    });


    // Foydalanuvchi joylashuvini olishga harakat qilish
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            map.setCenter(userLocation);
            map.setZoom(15);
        });
    }

    // Xaritaga bosish hodisasi
    map.addListener("click", function(event) {
        setDeliveryLocation(event.latLng);
    });
}

function searchAddressOnMap() {
    const address = document.getElementById("address-search").value;
    if (!address) {
        alert("Manzil kiritilmagan!");
        return;
    }

    geocoder.geocode({ address: address }, function(results, status) {
        if (status === "OK" && results[0]) {
            const location = results[0].geometry.location;
            setDeliveryLocation(location);
            map.setCenter(location);
            map.setZoom(15);
        } else {
            alert("Manzil topilmadi: " + status);
        }
    });
}

function setDeliveryLocation(location) {
    selectedLocation = location;

    // Avvalgi marker
    if (marker) {
        marker.setMap(null);
    }

    // Yangi marker
    marker = new google.maps.Marker({
        position: location,
        map: map,
        title: "Yetkazib berish manzili"
    });

    // Manzilni olish (Reverse Geocoding)
    geocoder.geocode({ location: location }, function(results, status) {
        if (status === "OK" && results[0]) {
            const address = results[0].formatted_address;
            document.getElementById('selected-address').textContent = address;
            document.getElementById('delivery_address').value = address;
            document.getElementById('delivery_latitude').value = location.lat();
            document.getElementById('delivery_longitude').value = location.lng();

            document.getElementById('selected-location-info').style.display = 'block';

            // Masofani hisoblash (Toshkent markazidan)
            calculateDistance(location);
        } else {
            document.getElementById('selected-address').textContent = `Lat: ${location.lat().toFixed(6)}, Lng: ${location.lng().toFixed(6)}`;
            document.getElementById('delivery_address').value = `${location.lat()},${location.lng()}`;
            document.getElementById('delivery_latitude').value = location.lat();
            document.getElementById('delivery_longitude').value = location.lng();
            document.getElementById('selected-location-info').style.display = 'block';
        }
    });
}

function calculateDistance(destination) {
    // Restoran joylashuvi (Toshkent markazi)
    const restaurant = { lat: 41.2995, lng: 69.2401 };

    const service = new google.maps.DistanceMatrixService();
    service.getDistanceMatrix({
        origins: [restaurant],
        destinations: [destination],
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC,
    }, function(response, status) {
        if (status === "OK") {
            const distance = response.rows[0].elements[0].distance;
            if (distance) {
                const distanceKm = distance.value / 1000;
                document.getElementById('delivery_distance').value = distanceKm.toFixed(1);
                updateTotal(); // Masofa hisoblangach umumiy summani yangilash
            }
        }
    });
}

function toggleDeliveryFields() {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    const deliveryFields = document.getElementById('delivery-fields');
    const deliveryAddressInput = document.getElementById('delivery_address');
    const deliveryLatitudeInput = document.getElementById('delivery_latitude');
    const deliveryLongitudeInput = document.getElementById('delivery_longitude');

    if (deliveryRadio.checked) {
        deliveryFields.style.display = 'block';
        deliveryAddressInput.required = true;
        deliveryLatitudeInput.required = true;
        deliveryLongitudeInput.required = true;

        // Xaritani yuklash agar hali yuklanmagan bo'lsa
        if (!map) {
            setTimeout(initMap, 100);
        }
    } else {
        deliveryFields.style.display = 'none';
        deliveryAddressInput.required = false;
        deliveryLatitudeInput.required = false;
        deliveryLongitudeInput.required = false;
        updateTotal();
    }
}

function updateTotal() {
    const baseTotal = {{ total }};
    let deliveryCost = 0;

    const deliveryDistanceInput = document.getElementById('delivery_distance');
    if (deliveryDistanceInput && deliveryDistanceInput.value) {
        const distance = parseFloat(deliveryDistanceInput.value);
        // Oddiy narxlashuv: har bir km uchun 5000 so'm
        if (distance > 0) {
            deliveryCost = distance * 5000; // Masalan, har km uchun 5000 so'm
        }
    }

    const finalTotal = baseTotal + deliveryCost;
    const totalElement = document.getElementById('total-amount');
    if (totalElement) {
        totalElement.textContent = finalTotal.toLocaleString() + " so'm";
    }

    // Delivery cost info yangilash
    const deliveryCostInfoSpan = document.querySelector('.delivery-cost-info .delivery-cost');
    if (deliveryCostInfoSpan) {
        if (deliveryCost > 0) {
            deliveryCostInfoSpan.textContent = `+ ${deliveryCost.toLocaleString()} so'm (yetkazib berish)`;
            deliveryCostInfoSpan.style.color = '#dc3545'; // Qizil rang
        } else {
            deliveryCostInfoSpan.textContent = 'Yetkazib berish: Bepul';
            deliveryCostInfoSpan.style.color = '#28a745'; // Yashil rang
        }
    }
}

// Sahifa yuklanganda xaritani ishga tushirish va boshqa funksiyalarni chaqirish
document.addEventListener('DOMContentLoaded', (event) => {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    if (deliveryRadio && deliveryRadio.checked) {
        toggleDeliveryFields();
    }
    // Agar sahifa ochilganda allaqachon delivery tanlangan bo'lsa, xaritani yuklash
    if (deliveryRadio && deliveryRadio.checked && !map) {
        initMap();
    }
});

        </script>
      {% else %}
        <div class="alert alert-warning">
          <p>Buyurtma berish uchun avval tizimga kiring</p>
          <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('menu') }}" class="btn">‚¨ÖÔ∏è Menuga qaytish</a>
            <a href="{{ url_for('login') }}" class="btn big" style="background: #4CAF50;">üîê Kirish</a>
            <a href="{{ url_for('register') }}" class="btn big" style="background: #2196F3;">üìù Ro'yxatdan o'tish</a>
          </div>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="empty-cart">
      <p>Savatchangiz bo'sh</p>
      <a href="{{ url_for('menu') }}" class="btn big">üçΩÔ∏è Taom tanlash</a>
    </div>
  {% endif %}
</div>

<style>
.cart-item {
  display: flex;
  align-items: center;
  padding: 20px;
  border: 1px solid #e2e8f0;
  border-radius: 15px;
  margin-bottom: 15px;
  background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.cart-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.item-info h4 {
  margin: 0 0 8px 0;
  color: #2d3748;
  font-size: 18px;
  font-weight: 600;
}

.item-info p {
  margin: 0;
  color: #4a5568;
  font-weight: 500;
}

.cart-total {
  text-align: center;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.cart-total h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.cart-actions {
  margin-top: 25px;
}

.cart-actions input[type="text"] {
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 15px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}

.cart-actions input[type="text"]:focus {
  border-color: #4299e1;
  box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.empty-cart {
  text-align: center;
  padding: 60px;
  color: #718096;
}

.empty-cart p {
  font-size: 18px;
  margin-bottom: 20px;
}

.btn.danger {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  border: none;
  transition: all 0.3s ease;
}

.btn.danger:hover {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  transform: translateY(-1px);
}

.cart-actions div {
  gap: 15px;
}

.cart-actions .btn.big {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  font-size: 18px;
  padding: 15px 25px;
  border-radius: 12px;
  font-weight: 600;
}

.cart-actions .btn.big:hover {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  transform: translateY(-2px);
}

.checkout-form .form-label {
    font-weight: 500;
    color: #4a5568;
}

.checkout-form .form-control {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 15px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.checkout-form .form-control:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.checkout-form .text-muted {
    font-size: 0.875em;
    color: #718096;
}

.checkout-form .btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 15px 25px;
    transition: all 0.3s ease;
}

.checkout-form .btn-success:hover {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    transform: translateY(-2px);
}

.delivery-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 4px solid #007bff;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.delivery-info {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.info-icon {
    font-size: 16px;
}

.info-text {
    font-size: 13px;
    color: #495057;
}

.total-breakdown {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.total-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.delivery-cost {
    color: #28a745;
    font-style: italic;
}

.total-final {
    border-top: 2px solid #dee2e6;
    padding-top: 10px;
    margin-top: 10px;
    font-size: 16px;
}

.profile-info {
    background: #e8f5e8;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #28a745;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.info-label {
    font-weight: 500;
    color: #495057;
}

.info-value {
    color: #28a745;
    font-weight: 600;
}

.card-info {
    background: #fff3cd;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #ffc107;
}

.map-selection {
    margin: 20px 0;
}

.selected-location {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    border: 1px solid #dee2e6;
}

.selected-location p {
    margin: 5px 0;
    font-size: 14px;
}

#selected-address {
    color: #007bff;
    font-weight: 500;
}

/* Mobile uchun */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
}

/* Address search uchun qo'shimcha stil */
.mb-3 {
    margin-bottom: 1rem !important;
}
.input-group {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    width: 100%;
}
.form-label {
    margin-bottom: 0.5rem;
}
.btn-outline-primary {
    color: #007bff;
    background-color: transparent;
    background-image: none;
    border-color: #007bff;
}
.btn {
    display: inline-block;
    font-weight: 400;
    color: #212529;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 0.25rem;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
.btn-outline-primary:hover {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
}
.input-group > :not(:last-child):not(.dropdown-toggle):not(.dropdown-menu) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}
.input-group > :not(:first-child):not(.dropdown-menu) {
    margin-left: -1px;
}
.input-group .form-control {
    position: relative;
    flex: 1 1 auto;
    width: 1%;
    margin-bottom: 0;
}
.input-group > .form-control:focus {
    z-index: 3;
}

</style>
{% endblock %}