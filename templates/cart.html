{% extends "base.html" %}

{% block title %}Savatcha - Restoran{% endblock %}

{% block content %}
<div class="card">
  <h2>üõí Savatcha</h2>

  {% if cart_items %}
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item">
        <div class="item-info">
          <h4>{{ item.name }}</h4>
          <p>{{ "{:,.0f}".format(item.price) }} so'm x {{ item.quantity }} = {{ "{:,.0f}".format(item.total) }} so'm</p>
        </div>
        <form method="post" action="{{ url_for('remove_from_cart', cart_item_id=item.id) }}" style="margin-left: auto;">
          <button type="submit" class="btn small danger" onclick="return confirm('Rostdan ham olib tashlamoqchimisiz?')">
            üóëÔ∏è O'chirish
          </button>
        </form>
      </div>
      {% endfor %}
    </div>

    <div class="cart-total">
      <h3>Jami: {{ "{:,.0f}".format(total) }} so'm</h3>
    </div>

    <div class="cart-actions">
      {% if session.get('user_id') %}
        <form method="post" action="{{ url_for('user_page') }}" class="checkout-form">
            <h3>üìã Buyurtma berish</h3>

            <div class="order-type-selection">
                <h4>Buyurtma turi:</h4>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="dine_in" checked onchange="toggleDeliveryFields()">
                        <span class="radio-text">üçΩÔ∏è Restoranda iste'mol qilish</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="delivery" onchange="toggleDeliveryFields()">
                        <span class="radio-text">üöö Yetkazib berish</span>
                    </label>
                </div>
            </div>

            <div id="delivery-fields" class="delivery-section" style="display: none;">
                <h4>üìç Yetkazib berish ma'lumotlari:</h4>
                <div class="form-group">
                    <label for="delivery_address">Manzil:</label>
                    <textarea id="delivery_address" name="delivery_address" placeholder="To'liq manzilni kiriting (Ko'cha, uy raqami, orientir)..." rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customer_phone">Telefon raqamingiz:</label>
                        <input type="tel" id="customer_phone" name="customer_phone" placeholder="+998 90 123 45 67" 
                               value="{{ session.get('user_phone', '') }}">
                    </div>
                    <div class="form-group">
                        <label for="delivery_distance">Masofa (km):</label>
                        <input type="number" id="delivery_distance" name="delivery_distance" step="0.1" min="0" placeholder="5.2">
                    </div>
                </div>

                <div class="form-group">
                    <label for="delivery_price">Yetkazish narxi (so'm):</label>
                    <input type="number" id="delivery_price" name="delivery_price" min="0" placeholder="15000" onchange="updateTotal()">
                    <small class="text-muted">Yetkazib berish xizmati uchun to'lov (ixtiyoriy)</small>
                </div>

                <div class="delivery-info">
                    <div class="info-item">
                        <span class="info-icon">‚è±Ô∏è</span>
                        <span class="info-text">Taxminiy yetkazib berish vaqti: 25-45 daqiqa</span>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üìû</span>
                        <span class="info-text">Kuryer sizga yetib borgunga qadar qo'ng'iroq qiladi</span>
                    </div>
                </div>
            </div>
            <div class="total-section">
                <div class="total-breakdown">
                    <div class="total-item">
                        <span>Mahsulotlar:</span>
                        <span>{{ total }} so'm</span>
                    </div>
                    <div class="delivery-cost-info">
                        <small class="delivery-cost">Yetkazib berish: Bepul</small>
                    </div>
                    <div class="total-final">
                        <strong>Jami summa: <span id="total-amount" class="total-amount">{{ total }} so'm</span></strong>
                    </div>
                </div>
                <button type="submit" class="btn checkout-btn">üõí Buyurtma berish</button>
            </div>
        </form>
        <script>
function toggleDeliveryFields() {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    const deliveryFields = document.getElementById('delivery-fields');
    const deliveryAddress = document.getElementById('delivery_address');
    const customerPhone = document.getElementById('customer_phone');

    if (deliveryRadio.checked) {
        deliveryFields.style.display = 'block';
        deliveryAddress.required = true;
        customerPhone.required = true;
    } else {
        deliveryFields.style.display = 'none';
        deliveryAddress.required = false;
        customerPhone.required = false;
        updateTotal(); // Delivery narxini olib tashlash
    }
}

function updateTotal() {
    const deliveryPrice = document.getElementById('delivery_price');
    const totalElement = document.getElementById('total-amount');
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');

    if (!totalElement) return;

    const baseTotal = {{ total }};
    let deliveryAmount = 0;

    if (deliveryRadio.checked && deliveryPrice.value) {
        deliveryAmount = parseFloat(deliveryPrice.value) || 0;
    }

    const finalTotal = baseTotal + deliveryAmount;
    totalElement.textContent = finalTotal.toLocaleString() + " so'm";

    // Delivery info yangilash
    const deliveryInfo = document.querySelector('.delivery-cost-info');
    if (deliveryInfo) {
        if (deliveryAmount > 0) {
            deliveryInfo.innerHTML = `<small class="delivery-cost">+ ${deliveryAmount.toLocaleString()} so'm (yetkazib berish)</small>`;
        } else {
            deliveryInfo.innerHTML = '<small class="delivery-cost">Yetkazib berish: Bepul</small>';
        }
    }
}
</script>
      {% else %}
        <div class="alert alert-warning">
          <p>Buyurtma berish uchun avval tizimga kiring</p>
          <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('menu') }}" class="btn">‚¨ÖÔ∏è Menuga qaytish</a>
            <a href="{{ url_for('login') }}" class="btn big" style="background: #4CAF50;">üîê Kirish</a>
            <a href="{{ url_for('register') }}" class="btn big" style="background: #2196F3;">üìù Ro'yxatdan o'tish</a>
          </div>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="empty-cart">
      <p>Savatchangiz bo'sh</p>
      <a href="{{ url_for('menu') }}" class="btn big">üçΩÔ∏è Taom tanlash</a>
    </div>
  {% endif %}
</div>

<style>
.cart-item {
  display: flex;
  align-items: center;
  padding: 20px;
  border: 1px solid #e2e8f0;
  border-radius: 15px;
  margin-bottom: 15px;
  background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.cart-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.item-info h4 {
  margin: 0 0 8px 0;
  color: #2d3748;
  font-size: 18px;
  font-weight: 600;
}

.item-info p {
  margin: 0;
  color: #4a5568;
  font-weight: 500;
}

.cart-total {
  text-align: center;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.cart-total h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.cart-actions {
  margin-top: 25px;
}

.cart-actions input[type="text"] {
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 15px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}

.cart-actions input[type="text"]:focus {
  border-color: #4299e1;
  box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.empty-cart {
  text-align: center;
  padding: 60px;
  color: #718096;
}

.empty-cart p {
  font-size: 18px;
  margin-bottom: 20px;
}

.btn.danger {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  border: none;
  transition: all 0.3s ease;
}

.btn.danger:hover {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  transform: translateY(-1px);
}

.cart-actions div {
  gap: 15px;
}

.cart-actions .btn.big {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  font-size: 18px;
  padding: 15px 25px;
  border-radius: 12px;
  font-weight: 600;
}

.cart-actions .btn.big:hover {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  transform: translateY(-2px);
}

.checkout-form .form-label {
    font-weight: 500;
    color: #4a5568;
}

.checkout-form .form-control {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 15px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.checkout-form .form-control:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.checkout-form .text-muted {
    font-size: 0.875em;
    color: #718096;
}

.checkout-form .btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 15px 25px;
    transition: all 0.3s ease;
}

.checkout-form .btn-success:hover {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    transform: translateY(-2px);
}

.delivery-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 4px solid #007bff;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.delivery-info {
    background: #e7f3ff;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.info-icon {
    font-size: 16px;
}

.info-text {
    font-size: 13px;
    color: #495057;
}

.total-breakdown {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.total-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.delivery-cost {
    color: #28a745;
    font-style: italic;
}

.total-final {
    border-top: 2px solid #dee2e6;
    padding-top: 10px;
    margin-top: 10px;
    font-size: 16px;
}

/* Mobile uchun */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
}
</style>
{% endblock %}