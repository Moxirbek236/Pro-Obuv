{% extends "base.html" %}

{% block title %}Savatcha - Restoran{% endblock %}

{% block content %}
<div class="card">
  <h2>üõí Savatcha</h2>

  {% if cart_items %}
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item">
        <div class="item-info">
          <h4>{{ item.name }}</h4>
          <p>{{ "{:,.0f}".format(item.price) }} so'm x {{ item.quantity }} = {{ "{:,.0f}".format(item.total) }} so'm</p>
        </div>
        <form method="post" action="{{ url_for('remove_from_cart', cart_item_id=item.id) }}" style="margin-left: auto;">
          <button type="submit" class="btn small danger" onclick="return confirm('Rostdan ham olib tashlamoqchimisiz?')">
            üóëÔ∏è O'chirish
          </button>
        </form>
      </div>
      {% endfor %}
    </div>

    <div class="cart-total">
      <h3>Jami: {{ "{:,.0f}".format(total) }} so'm</h3>
    </div>

    <div class="cart-actions">
      {% if session.get('user_id') %}
        <form method="post" action="{{ url_for('user_page') }}">
          <div style="display: flex; gap: 10px; align-items: center;">
            <a href="{{ url_for('menu') }}" class="btn">‚¨ÖÔ∏è Menuga qaytish</a>
            <button type="submit" class="btn big" style="background: #4CAF50;">‚úÖ Buyurtma berish</button>
          </div>
        </form>
        <div class="row justify-content-center mt-4">
    <div class="col-md-8">
        <form method="POST" action="{{ url_for('user_page') }}" class="checkout-form">
            <div class="mb-3">
                <label for="delivery_address" class="form-label">üè† Dostavka manzili (ixtiyoriy):</label>
                <textarea class="form-control" id="delivery_address" name="delivery_address" 
                         rows="2" placeholder="Agar dostavka kerak bo'lsa manzilni kiriting..." 
                         onchange="toggleCardNumber()"></textarea>
                <small class="text-muted">Bo'sh qoldirgang takdirda restoranda yeyish uchun buyurtma beriladi.</small>
            </div>
            
            <div class="mb-3" id="card-number-field" style="display: none;">
                <label for="card_number" class="form-label">üí≥ Karta raqami:</label>
                <input type="text" class="form-control" id="card_number" name="card_number" 
                       placeholder="1234 5678 9012 3456" maxlength="19" 
                       pattern="[0-9\s]+" onkeyup="formatCardNumber(this)">
                <small class="text-muted">Dostavka uchun to'lov kartasi raqamini kiriting.</small>
            </div>
            
            <button type="submit" class="btn btn-success btn-lg w-100">
                üõí Buyurtma berish ({{ "{:,}".format(total) }} so'm)
            </button>
        </form>
    </div>
</div>

<script>
function toggleCardNumber() {
    const deliveryAddress = document.getElementById('delivery_address').value.trim();
    const cardField = document.getElementById('card-number-field');
    const cardInput = document.getElementById('card_number');
    
    if (deliveryAddress) {
        cardField.style.display = 'block';
        cardInput.required = true;
    } else {
        cardField.style.display = 'none';
        cardInput.required = false;
        cardInput.value = '';
    }
}

function formatCardNumber(input) {
    let value = input.value.replace(/\s/g, '');
    let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
    if (formattedValue.length > 19) {
        formattedValue = formattedValue.substring(0, 19);
    }
    input.value = formattedValue;
}
</script>
      {% else %}
        <div class="alert alert-warning">
          <p>Buyurtma berish uchun avval tizimga kiring</p>
          <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('menu') }}" class="btn">‚¨ÖÔ∏è Menuga qaytish</a>
            <a href="{{ url_for('login') }}" class="btn big" style="background: #4CAF50;">üîê Kirish</a>
            <a href="{{ url_for('register') }}" class="btn big" style="background: #2196F3;">üìù Ro'yxatdan o'tish</a>
          </div>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="empty-cart">
      <p>Savatchangiz bo'sh</p>
      <a href="{{ url_for('menu') }}" class="btn big">üçΩÔ∏è Taom tanlash</a>
    </div>
  {% endif %}
</div>

<style>
.cart-item {
  display: flex;
  align-items: center;
  padding: 20px;
  border: 1px solid #e2e8f0;
  border-radius: 15px;
  margin-bottom: 15px;
  background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.cart-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.item-info h4 {
  margin: 0 0 8px 0;
  color: #2d3748;
  font-size: 18px;
  font-weight: 600;
}

.item-info p {
  margin: 0;
  color: #4a5568;
  font-weight: 500;
}

.cart-total {
  text-align: center;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.cart-total h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.cart-actions {
  margin-top: 25px;
}

.cart-actions input[type="text"] {
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 15px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}

.cart-actions input[type="text"]:focus {
  border-color: #4299e1;
  box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.empty-cart {
  text-align: center;
  padding: 60px;
  color: #718096;
}

.empty-cart p {
  font-size: 18px;
  margin-bottom: 20px;
}

.btn.danger {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  border: none;
  transition: all 0.3s ease;
}

.btn.danger:hover {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  transform: translateY(-1px);
}

.cart-actions div {
  gap: 15px;
}

.cart-actions .btn.big {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  font-size: 18px;
  padding: 15px 25px;
  border-radius: 12px;
  font-weight: 600;
}

.cart-actions .btn.big:hover {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  transform: translateY(-2px);
}

.checkout-form .form-label {
    font-weight: 500;
    color: #4a5568;
}

.checkout-form .form-control {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 15px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.checkout-form .form-control:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.checkout-form .text-muted {
    font-size: 0.875em;
    color: #718096;
}

.checkout-form .btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    font-weight: 600;
    border-radius: 12px;
    padding: 15px 25px;
    transition: all 0.3s ease;
}

.checkout-form .btn-success:hover {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    transform: translateY(-2px);
}
</style>
{% endblock %}