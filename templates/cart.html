
{% extends "base.html" %}

{% block title %}Savatcha - Restoran{% endblock %}

{% block head %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ config.get('YANDEX_MAPS_API', 'fc256b90-6f74-4f1b-a7ee-d42b695a8284') }}&lang=uz_UZ" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="card cart-section">
  <h2 class="section-title" data-translate="cart_title">üõí Savatcha</h2>

  {% if cart_items %}
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item">
        <div class="item-info">
          <h4>{{ item.name }}</h4>
          <p>{{ "{:,.0f}".format(item.price) }} so'm x {{ item.quantity }} = {{ "{:,.0f}".format(item.total) }} so'm</p>
        </div>
        <form method="post" action="{{ url_for('remove_from_cart', cart_item_id=item.id) }}" style="margin-left: auto;">
          <button type="submit" class="btn small danger" onclick="return confirm('Rostdan ham olib tashlamoqchimisiz?')">
            üóëÔ∏è O'chirish
          </button>
        </form>
      </div>
      {% endfor %}
    </div>

    <div class="cart-total">
      <h3>Jami: {{ "{:,.0f}".format(total) }} so'm</h3>
    </div>

    <div class="cart-actions">
      {% if session.get('user_id') %}
        <form method="post" action="{{ url_for('user_page') }}" class="checkout-form">
            <h3>üìã Buyurtma berish</h3>

            <div class="order-type-selection">
                <h4 data-translate="order_type">Buyurtma turi:</h4>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="dine_in" checked onchange="toggleDeliveryFields()">
                        <span class="radio-text" data-translate="dine_in">üçΩÔ∏è Restoranda iste'mol qilish</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="order_type" value="delivery" onchange="toggleDeliveryFields()">
                        <span class="radio-text" data-translate="delivery">üöö Yetkazib berish</span>
                    </label>
                </div>
            </div>

            <div id="delivery-fields" class="delivery-section" style="display: none;">
                <h4>üìç Yetkazib berish ma'lumotlari:</h4>

                <!-- Xarita -->
                <div class="map-container">
                    <h5>üó∫Ô∏è Joylashuvingizni xaritadan tanlang:</h5>
                    <div id="map" style="height: 400px; border-radius: 12px; border: 2px solid #e2e8f0;"></div>
                    
                    <!-- Manzil qidirish -->
                    <div class="address-search">
                        <input type="text" id="address-search" placeholder="Manzilni qidiring..." class="form-control">
                        <button type="button" onclick="searchAddressOnMap()" class="btn btn-search">üîç Qidirish</button>
                    </div>
                </div>

                <!-- Yetkazib berish ma'lumotlari -->
                <div id="delivery-info" class="delivery-info" style="display: none;">
                    <h4>üì¶ Yetkazib berish ma'lumotlari</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-icon">üè¢</span>
                            <div class="info-content">
                                <span class="info-label">Eng yaqin filial:</span>
                                <span id="branch-name" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üìè</span>
                            <div class="info-content">
                                <span class="info-label">Masofa:</span>
                                <span id="distance-display" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">üí∞</span>
                            <div class="info-content">
                                <span class="info-label">Yetkazish narxi:</span>
                                <span id="delivery-price-display" class="info-value">-</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-icon">‚è±Ô∏è</span>
                            <div class="info-content">
                                <span class="info-label">Taxminiy vaqt:</span>
                                <span id="delivery-time-display" class="info-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yashirin maydonlar -->
                <input type="hidden" id="delivery_address" name="delivery_address">
                <input type="hidden" id="delivery_latitude" name="delivery_latitude">
                <input type="hidden" id="delivery_longitude" name="delivery_longitude">
                <input type="hidden" id="delivery_distance" name="delivery_distance">
                <input type="hidden" id="delivery_price" name="delivery_price">
                <input type="hidden" id="delivery_time" name="delivery_time">
                <input type="hidden" id="branch_id" name="branch_id">
            </div>

            <div class="total-section">
                <div class="total-breakdown">
                    <div class="total-item">
                        <span>Mahsulotlar:</span>
                        <span>{{ "{:,.0f}".format(total) }} so'm</span>
                    </div>
                    <div class="delivery-cost-info">
                        <span class="delivery-cost">Yetkazib berish: <span id="delivery-cost-text">Bepul</span></span>
                    </div>
                    <div class="total-final">
                        <strong>Jami summa: <span id="total-amount">{{ "{:,.0f}".format(total) }} so'm</span></strong>
                    </div>
                </div>
                <button type="submit" class="btn checkout-btn" onclick="return validateOrder()">üõí Buyurtma berish</button>
            </div>
        </form>

        <script>
let map;
let userMarker;
let branchMarker;
let routeLine;
let nearestBranch = null;

function initMap() {
    ymaps.ready(function() {
        // Foydalanuvchi joylashuvi (profil yoki default)
        const userLat = parseFloat('{{ session.get("user_address_latitude", "") }}') || 41.2995;
        const userLng = parseFloat('{{ session.get("user_address_longitude", "") }}') || 69.2401;

        // Xarita yaratish
        map = new ymaps.Map('map', {
            center: [userLat, userLng],
            zoom: 12,
            controls: ['zoomControl', 'fullscreenControl']
        });

        // Foydalanuvchi joylashuvini belgilash
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const userLocation = [position.coords.latitude, position.coords.longitude];
                setUserLocation(userLocation);
            }, function(error) {
                console.log("Joylashuv olishda xatolik:", error);
                setUserLocation([userLat, userLng]);
            });
        } else {
            setUserLocation([userLat, userLng]);
        }

        // Xarita bosilganda yangi joylashuv tanlash
        map.events.add('click', function(e) {
            const coords = e.get('coords');
            setUserLocation(coords);
        });
    });
}

function setUserLocation(coords) {
    // Avvalgi markerlarni olib tashlash
    if (userMarker) {
        map.geoObjects.remove(userMarker);
    }
    if (branchMarker) {
        map.geoObjects.remove(branchMarker);
    }
    if (routeLine) {
        map.geoObjects.remove(routeLine);
    }

    // Foydalanuvchi markeri
    userMarker = new ymaps.Placemark(coords, {
        hintContent: 'Sizning joylashuvingiz',
        balloonContent: 'Yetkazib berish manzili'
    }, {
        iconColor: '#ff6b6b',
        draggable: true
    });

    map.geoObjects.add(userMarker);

    // Marker tortilganda yangi joylashuv
    userMarker.events.add('dragend', function() {
        const newCoords = userMarker.geometry.getCoordinates();
        setUserLocation(newCoords);
    });

    // Manzilni olish
    ymaps.geocode(coords).then(function(res) {
        const firstGeoObject = res.geoObjects.get(0);
        let address = '';

        if (firstGeoObject) {
            address = firstGeoObject.getAddressLine();
        } else {
            address = `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
        }

        document.getElementById('delivery_address').value = address;
        document.getElementById('delivery_latitude').value = coords[0];
        document.getElementById('delivery_longitude').value = coords[1];
    });

    // Eng yaqin filialni topish
    findNearestBranchAndRoute(coords);
}

function findNearestBranchAndRoute(userCoords) {
    fetch('/api/find-nearest-branch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            latitude: userCoords[0],
            longitude: userCoords[1]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            nearestBranch = data;
            const branchCoords = [data.branch.latitude, data.branch.longitude];

            // Filial markeri
            branchMarker = new ymaps.Placemark(branchCoords, {
                hintContent: data.branch.name,
                balloonContent: `${data.branch.name}<br>${data.branch.address}`
            }, {
                iconColor: '#4CAF50',
                preset: 'islands#greenHomeIcon'
            });

            map.geoObjects.add(branchMarker);

            // Yo'lni chizish
            ymaps.route([branchCoords, userCoords], {
                multiRoute: false,
                routingMode: 'auto'
            }).then(function(route) {
                routeLine = route;
                map.geoObjects.add(route);

                // Xaritani yo'lga moslash
                map.setBounds(route.getBounds(), {
                    checkZoomRange: true,
                    zoomMargin: 50
                });

                // Ma'lumotlarni ko'rsatish
                updateDeliveryInfo(data);
            }).catch(function(error) {
                console.error('Yo\'l chizishda xatolik:', error);
                // Oddiy chiziq chizish
                const simpleLine = new ymaps.Polyline([branchCoords, userCoords], {}, {
                    strokeColor: '#4CAF50',
                    strokeWidth: 3,
                    strokeOpacity: 0.8
                });
                map.geoObjects.add(simpleLine);
                routeLine = simpleLine;

                // Ma'lumotlarni ko'rsatish
                updateDeliveryInfo(data);
            });
        } else {
            alert('Yaqin atrofda faol filial topilmadi: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Filial topishda xatolik:', error);
        alert('Filial topishda xatolik yuz berdi');
    });
}

function updateDeliveryInfo(data) {
    // Ma'lumotlarni ko'rsatish
    document.getElementById('branch-name').textContent = data.branch.name;
    document.getElementById('distance-display').textContent = data.distance + ' km';
    document.getElementById('delivery-price-display').textContent = data.delivery_cost.toLocaleString() + ' so\'m';
    document.getElementById('delivery-time-display').textContent = data.delivery_time + ' daqiqa';

    // Yashirin maydonlarni to'ldirish
    document.getElementById('delivery_distance').value = data.distance;
    document.getElementById('delivery_price').value = data.delivery_cost;
    document.getElementById('delivery_time').value = data.delivery_time;
    document.getElementById('branch_id').value = data.branch.id;

    // Info panelni ko'rsatish
    document.getElementById('delivery-info').style.display = 'block';

    // Umumiy summani yangilash
    updateTotalAmount();
}

function searchAddressOnMap() {
    const address = document.getElementById("address-search").value;
    if (!address) {
        alert("Manzil kiritilmagan!");
        return;
    }

    ymaps.geocode(address + ", Toshkent", {
        results: 1
    }).then(function(res) {
        if (res.geoObjects.getLength() > 0) {
            const firstGeoObject = res.geoObjects.get(0);
            const coords = firstGeoObject.geometry.getCoordinates();

            setUserLocation(coords);
            map.setCenter(coords, 15);
        } else {
            alert("Manzil topilmadi!");
        }
    });
}

function toggleDeliveryFields() {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    const deliveryFields = document.getElementById('delivery-fields');

    if (deliveryRadio.checked) {
        deliveryFields.style.display = 'block';
        
        // Xaritani yuklash
        setTimeout(() => {
            if (!map) {
                initMap();
            } else {
                map.container.fitToViewport();
            }
        }, 100);
    } else {
        deliveryFields.style.display = 'none';
        updateTotalAmount();
    }
}

function updateTotalAmount() {
    const deliveryRadio = document.querySelector('input[name="order_type"][value="delivery"]');
    const totalElement = document.getElementById('total-amount');
    const deliveryCostElement = document.getElementById('delivery-cost-text');

    let baseTotal = {{ total }};
    let deliveryCost = 0;

    if (deliveryRadio && deliveryRadio.checked) {
        deliveryCost = parseFloat(document.getElementById('delivery_price').value) || 0;
    }

    if (deliveryCostElement) {
        if (deliveryCost > 0) {
            deliveryCostElement.textContent = deliveryCost.toLocaleString() + ' so\'m';
        } else {
            deliveryCostElement.textContent = 'Bepul';
        }
    }

    if (totalElement) {
        totalElement.textContent = (baseTotal + deliveryCost).toLocaleString() + ' so\'m';
    }
}

function validateOrder() {
    const orderType = document.querySelector('input[name="order_type"]:checked');
    
    if (!orderType) {
        alert('Buyurtma turini tanlang!');
        return false;
    }

    if (orderType.value === 'delivery') {
        const deliveryAddress = document.getElementById('delivery_address').value;
        const deliveryDistance = document.getElementById('delivery_distance').value;

        if (!deliveryAddress) {
            alert('Yetkazib berish manzilini xaritadan tanlang!');
            return false;
        }

        if (!deliveryDistance || parseFloat(deliveryDistance) <= 0) {
            alert('Iltimos, xaritadan manzilni tanlang va masofa hisoblanishini kuting!');
            return false;
        }
    }

    return confirm('Buyurtma berishni tasdiqlaysizmi?');
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="order_type"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', toggleDeliveryFields);
    });
});
        </script>
      {% else %}
        <div class="alert alert-warning">
          <p>Buyurtma berish uchun avval tizimga kiring</p>
          <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('menu') }}" class="btn">‚¨ÖÔ∏è Menuga qaytish</a>
            <a href="{{ url_for('login') }}" class="btn big" style="background: #4CAF50;">üîê Kirish</a>
            <a href="{{ url_for('register') }}" class="btn big" style="background: #2196F3;">üìù Ro'yxatdan o'tish</a>
          </div>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="empty-cart">
      <p>Savatchangiz bo'sh</p>
      <a href="{{ url_for('menu') }}" class="btn big">üçΩÔ∏è Taom tanlash</a>
    </div>
  {% endif %}
</div>

<style>
.cart-item {
  display: flex;
  align-items: center;
  padding: 20px;
  border: 1px solid #e2e8f0;
  border-radius: 15px;
  margin-bottom: 15px;
  background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.cart-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.item-info h4 {
  margin: 0 0 8px 0;
  color: #2d3748;
  font-size: 18px;
  font-weight: 600;
}

.item-info p {
  margin: 0;
  color: #4a5568;
  font-weight: 500;
}

.cart-total {
  text-align: center;
  margin: 25px 0;
  padding: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  color: white;
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.cart-total h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.delivery-section {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 15px;
  margin: 20px 0;
  border-left: 4px solid #007bff;
}

.map-container {
  margin: 20px 0;
}

.map-container h5 {
  margin-bottom: 15px;
  color: #2d3748;
  font-weight: 600;
}

.address-search {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.address-search input {
  flex: 1;
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 16px;
}

.btn-search {
  padding: 12px 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
}

.btn-search:hover {
  background: #0056b3;
}

.delivery-info {
  background: #e8f5e8;
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
  border-left: 4px solid #28a745;
}

.delivery-info h4 {
  margin: 0 0 20px 0;
  color: #155724;
  font-size: 18px;
  font-weight: 600;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.info-icon {
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: #f0f9ff;
  border-radius: 50%;
}

.info-content {
  flex: 1;
}

.info-label {
  display: block;
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
  margin-bottom: 2px;
}

.info-value {
  display: block;
  font-size: 14px;
  color: #1f2937;
  font-weight: 600;
}

.total-breakdown {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.total-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.delivery-cost-info {
  margin-bottom: 8px;
  font-size: 14px;
}

.delivery-cost {
  color: #28a745;
  font-weight: 500;
}

.total-final {
  border-top: 2px solid #dee2e6;
  padding-top: 10px;
  margin-top: 10px;
  font-size: 16px;
}

.checkout-btn {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.checkout-btn:hover {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  transform: translateY(-2px);
}

.radio-group {
  display: flex;
  gap: 20px;
  margin: 15px 0;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 10px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.radio-option:hover {
  border-color: #4299e1;
  background: #f7fafc;
}

.radio-option input[type="radio"] {
  margin: 0;
}

.radio-text {
  font-weight: 500;
  color: #2d3748;
}

.empty-cart {
  text-align: center;
  padding: 60px;
  color: #718096;
}

.btn.danger {
  background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  color: white;
  border: none;
  transition: all 0.3s ease;
}

.btn.danger:hover {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  transform: translateY(-1px);
}

@media (max-width: 768px) {
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .radio-group {
    flex-direction: column;
    gap: 10px;
  }

  .address-search {
    flex-direction: column;
  }
}
</style>
{% endblock %}
