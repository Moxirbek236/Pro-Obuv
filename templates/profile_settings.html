{% extends "base.html" %} {% block title %}Profil sozlamalari{% endblock %} {% block head %}
<style>
  .settings-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px 0;
  }

  .settings-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    max-width: 900px;
    margin: 0 auto;
    backdrop-filter: blur(10px);
  }

  .settings-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e2e8f0;
  }

  .settings-header h3 {
    color: #2d3748;
    font-weight: 700;
    margin-bottom: 10px;
  }

  .settings-header p {
    color: #718096;
    font-size: 1.1rem;
  }

  .settings-section {
    margin-bottom: 40px;
    padding: 30px;
    background: rgba(248, 250, 252, 0.8);
    border-radius: 15px;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
  }

  .settings-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  .settings-section h5 {
    color: #2d3748;
    font-weight: 600;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-control {
    border-radius: 10px;
    padding: 12px 15px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    transform: translateY(-1px);
  }

  .btn-save {
    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    border: none;
    color: white;
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-save:hover {
    background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(69, 160, 73, 0.4);
  }

  .btn-danger {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    border: none;
    color: white;
    padding: 8px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-danger:hover {
    background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4);
  }

  .session-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .session-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
  }

  .session-current {
    border-color: #4caf50;
    background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
  }

  .role-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .role-super-admin {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
  }

  .role-staff {
    background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
    color: white;
  }

  .role-courier {
    background: linear-gradient(135deg, #45b7d1 0%, #96c93d 100%);
    color: white;
  }

  .role-user {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 5px;
  }

  .stat-label {
    color: #718096;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .settings-card {
      padding: 20px;
      margin: 10px;
    }

    .settings-section {
      padding: 20px;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="settings-container">
  <div class="settings-card">
    <div class="settings-header">
      <h3>‚öôÔ∏è Profil sozlamalari</h3>
      <p>
        {% if session.get('super_admin') %}
        <span class="role-badge role-super-admin">Super Admin</span> profil
        sozlamalari {% elif session.get('staff_id') %}
        <span class="role-badge role-staff">Xodim</span> profil sozlamalari {%
        elif session.get('courier_id') %}
        <span class="role-badge role-courier">Kuryer</span> profil sozlamalari
        {% elif session.get('user_id') %}
        <span class="role-badge role-user">Foydalanuvchi</span> profil
        sozlamalari {% endif %}
      </p>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div
      class="alert alert-{{ 'danger' if category=='error' else 'success' if category=='success' else category }} alert-dismissible fade show"
      role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %} {% endif %} {% endwith %}

    <!-- User Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number">{{ session.get('user_orders_count', 0) }}</div>
        <div class="stat-label">üì¶ Jami buyurtmalar</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ session.get('user_total_spent', 0) }}</div>
        <div class="stat-label">üí∞ Jami sarflangan (so'm)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">
          {{ session.get('user_sessions_count', 1) }}
        </div>
        <div class="stat-label">üîí Faol sessiyalar</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">
          {{ session.get('user_last_login', 'N/A') }}
        </div>
        <div class="stat-label">üïê So'nggi kirish</div>
      </div>
    </div>

    <!-- Parol o'zgartirish -->
    <div class="settings-section">
      <h5>üîê Parolni o'zgartirish</h5>
      <form method="POST" action="{{ url_for('change_password') }}">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="current_password" class="form-label">Joriy parol</label>
            <input
              type="password"
              class="form-control"
              id="current_password"
              name="current_password"
              required />
          </div>
          <div class="col-md-6 mb-3">
            <label for="new_password" class="form-label">Yangi parol</label>
            <input
              type="password"
              class="form-control"
              id="new_password"
              name="new_password"
              required
              minlength="6" />
          </div>
        </div>
        <div class="mb-3">
          <label for="confirm_password" class="form-label"
            >Yangi parolni tasdiqlash</label
          >
          <input
            type="password"
            class="form-control"
            id="confirm_password"
            name="confirm_password"
            required
            minlength="6" />
        </div>
        <button type="submit" class="btn btn-save">
          üîë Parolni o'zgartirish
        </button>
      </form>
    </div>

    <!-- Shaxsiy ma'lumotlar (faqat user uchun) -->
    {% if session.get('user_id') %}
    <div class="settings-section">
      <h5>üë§ Shaxsiy ma'lumotlar</h5>
      <form
        method="POST"
        action="{{ url_for('update_profile') }}"
        enctype="multipart/form-data">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="first_name" class="form-label">Ism</label>
            <input
              type="text"
              class="form-control"
              id="first_name"
              name="first_name"
              value="{{ session.get('user_name', '').split()[0] if session.get('user_name') else '' }}"
              required />
          </div>
          <div class="col-md-6 mb-3">
            <label for="last_name" class="form-label">Familiya</label>
            <input
              type="text"
              class="form-control"
              id="last_name"
              name="last_name"
              value="{{ session.get('user_name', '').split()[1] if session.get('user_name') and session.get('user_name').split()|length > 1 else '' }}" />
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              value="{{ session.get('user_email', '') }}"
              required />
          </div>
          <div class="col-md-6 mb-3">
            <label for="phone" class="form-label">Telefon raqami</label>
            <input
              type="tel"
              class="form-control"
              id="phone"
              name="phone"
              value="{{ session.get('user_phone', '') }}" />
          </div>
        </div>
        <div class="mb-3">
          <label for="card_number" class="form-label">Karta raqami</label>
          <input
            type="text"
            class="form-control"
            id="card_number"
            name="card_number"
            value="{{ session.get('user_card_number','') }}"
            placeholder="XXXX-XXXX-XXXX-XXXX" />
        </div>
        <div class="mb-3">
          <label class="form-label">Profil rasmi</label>
          <div class="d-flex align-items-center gap-3">
            <img
              src="{{ session.get('user_avatar','/static/images/default-avatar.svg') }}"
              alt="avatar"
              width="64"
              height="64"
              class="rounded-circle"
              style="object-fit: cover" />
            <input
              type="file"
              name="avatar"
              accept="image/*"
              class="form-control-file" />
          </div>
        </div>
        <button type="submit" class="btn btn-save">
          üíæ Ma'lumotlarni yangilash
        </button>
      </form>
    </div>
    {% endif %}

    <!-- Faol sessiyalar -->
    <div class="settings-section">
      <h5>üîí Faol sessiyalar</h5>
      <p class="text-muted mb-3">
        Barcha qurilmalardagi faol sessiyalarni boshqaring
      </p>

      <div class="mb-3">
        <button class="btn btn-danger" onclick="terminateAllSessions()">
          üö´ Barcha sessiyalarni tugatish
        </button>
        <button
          class="btn btn-outline-primary ms-2"
          onclick="refreshSessions()">
          üîÑ Yangilash
        </button>
      </div>

      <div id="sessionsList">
        <!-- Sessiyalar bu yerda ko'rsatiladi -->
      </div>
    </div>

    <!-- Super Admin uchun maxsus sozlamalar -->
    {% if session.get('super_admin') %}
    <div class="settings-section">
      <h5>üëë Super Admin sozlamalari</h5>
      <div class="row">
        <div class="col-md-6">
          <a
            href="{{ url_for('super_admin_dashboard') }}"
            class="btn btn-outline-primary w-100 mb-2">
            üè† Admin Dashboard
          </a>
        </div>
        <div class="col-md-6">
          <a
            href="{{ url_for('general_settings') }}"
            class="btn btn-outline-secondary w-100 mb-2">
            ‚öôÔ∏è Umumiy sozlamalar
          </a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Navigatsiya tugmalari -->
    <div class="text-center">
      <a href="{{ url_for('profile') }}" class="btn btn-outline-secondary me-2">
        üë§ Profil
      </a>
      <a href="{{ url_for('index') }}" class="btn btn-outline-primary me-2">
        üè† Bosh sahifa
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
        üö™ Chiqish
      </a>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Sessiyalarni yuklash
  function loadSessions() {
    fetch("/api/user-sessions")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          displaySessions(data.sessions);
        } else {
          document.getElementById("sessionsList").innerHTML =
            '<div class="text-center py-3"><p class="text-muted">Sessiyalarni yuklashda xatolik</p></div>';
        }
      })
      .catch((error) => {
        console.error("Error loading sessions:", error);
        document.getElementById("sessionsList").innerHTML =
          '<div class="text-center py-3"><p class="text-muted">Tarmoq xatoligi</p></div>';
      });
  }

  // Sessiyalarni ko'rsatish
  function displaySessions(sessions) {
    const container = document.getElementById("sessionsList");

    if (!sessions || sessions.length === 0) {
      container.innerHTML = `
        <div class="text-center py-3">
          <i class="fas fa-shield-alt" style="font-size: 2rem; color: #ccc;"></i>
          <p class="text-muted mt-2">Hech qanday faol sessiyalar topilmadi.</p>
        </div>
      `;
      return;
    }

    let html = "";
    sessions.forEach((session) => {
      const isCurrent = session.session_id === "{{ session.session_id }}";
      html += `
        <div class="session-item ${isCurrent ? "session-current" : ""}">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <strong>${session.ip || "Noma'lum IP"}</strong>
                ${
                  isCurrent
                    ? '<span class="badge bg-success">Bu qurilma</span>'
                    : ""
                }
              </div>
              <div class="text-muted small mb-1">${
                session.user_agent || ""
              }</div>
              <div class="text-muted small">
                <strong>Sozlangan:</strong> ${session.created_at}<br>
                <strong>So'ng ko'rilgan:</strong> ${session.last_seen}
              </div>
            </div>
            <div>
              <button
                class="btn btn-sm btn-danger"
                onclick="terminateSession('${
                  session.session_id
                }', ${isCurrent})">
                ${isCurrent ? "üîÑ Tugatish va chiqish" : "‚ùå Tugatish"}
              </button>
            </div>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // Bitta sessiyani tugatish
  async function terminateSession(sessionId, isCurrent = false) {
    try {
      const resp = await fetch("/api/terminate-session", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": typeof CSRF_TOKEN !== 'undefined' ? CSRF_TOKEN : '' },
        body: JSON.stringify({ session_id: sessionId }),
      });
      const data = await resp.json();
      if (resp.ok && data.success) {
        if (isCurrent) window.location.href = '/login_page';
        else await loadSessions();
      } else {
        alert(data.message || "Sessiyani tugatishda xatolik");
      }
    } catch (e) {
      alert("Tarmoqqa ulanish xatosi");
    }
  }

  // Barcha sessiyalarni tugatish
  async function terminateAllSessions() {
    if (
      !confirm("Barcha sessiyalarni tugatmoqchimisiz? Bu sizni ham chiqaradi!")
    ) {
      return;
    }

    try {
      const resp = await fetch("/api/terminate-all-sessions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      const data = await resp.json();

      if (resp.ok && data.success) {
        alert("Barcha sessiyalar tugatildi. Siz chiqarildingiz.");
        window.location.href = "{{ url_for('login') }}";
      } else {
        alert(data.error || "Sessiyalarni tugatib bo'lmadi");
      }
    } catch (e) {
      console.error("terminateAllSessions error", e);
      alert("Tarmoq xatoligi");
    }
  }

  // Sessiyalarni yangilash
  function refreshSessions() {
    loadSessions();
  }

  // Sahifa yuklanganda sessiyalarni yuklash
  document.addEventListener("DOMContentLoaded", function () {
    loadSessions();
  });
</script>
{% endblock %}
