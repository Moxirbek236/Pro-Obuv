
<old_str>
{% extends "base.html" %}

{% block content %}
<div class="analytics-container">
    <h1>üìä Advanced Analytics Dashboard</h1>
    
    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <h3>üí∞ Bugungi Daromad</h3>
            <div class="kpi-value" id="today-revenue">0 so'm</div>
            <div class="kpi-change positive" id="revenue-change">+12.5%</div>
        </div>
        
        <div class="kpi-card">
            <h3>üì¶ Bugungi Buyurtmalar</h3>
            <div class="kpi-value" id="today-orders">0</div>
            <div class="kpi-change positive" id="orders-change">+8.3%</div>
        </div>
        
        <div class="kpi-card">
            <h3>üë• Faol Foydalanuvchilar</h3>
            <div class="kpi-value" id="active-users">0</div>
            <div class="kpi-change neutral" id="users-change">+2.1%</div>
        </div>
        
        <div class="kpi-card">
            <h3>‚≠ê O'rtacha Baho</h3>
            <div class="kpi-value" id="avg-rating">4.5</div>
            <div class="kpi-change positive" id="rating-change">+0.2</div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>üìà Daromad Trendi (30 kun)</h3>
            <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>üçΩÔ∏è Top Mahsulotlar</h3>
            <canvas id="productsChart"></canvas>
        </div>
    </div>
    
    <!-- Real-time Activity -->
    <div class="activity-section">
        <h3>üî¥ Real-time Faollik</h3>
        <div id="real-time-feed" class="activity-feed">
            <!-- Real-time updates will be inserted here -->
        </div>
    </div>
</div>

<style>
.analytics-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.kpi-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 10px 0;
}

.kpi-change {
    font-size: 1.1rem;
    font-weight: 500;
}

.kpi-change.positive { color: #4ade80; }
.kpi-change.negative { color: #f87171; }
.kpi-change.neutral { color: #fbbf24; }

.charts-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.activity-section {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.activity-feed {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
}

.activity-item {
    padding: 10px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    align-items: center;
    gap: 10px;
}

.activity-time {
    color: #6b7280;
    font-size: 0.875rem;
}
</style>

<script>
// Real-time updates
function startRealTimeUpdates() {
    setInterval(() => {
        updateKPIs();
        updateRealTimeFeed();
    }, 30000); // Har 30 soniyada yangilash
}

function updateKPIs() {
    fetch('/api/super-admin/kpis')
        .then(response => response.json())
        .then(data => {
            document.getElementById('today-revenue').textContent = data.revenue.toLocaleString() + ' so\'m';
            document.getElementById('today-orders').textContent = data.orders;
            document.getElementById('active-users').textContent = data.activeUsers;
            document.getElementById('avg-rating').textContent = data.avgRating;
        })
        .catch(error => console.error('KPI update error:', error));
}

function updateRealTimeFeed() {
    fetch('/api/super-admin/activity-feed')
        .then(response => response.json())
        .then(data => {
            const feed = document.getElementById('real-time-feed');
            feed.innerHTML = '';
            
            data.activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <span class="activity-icon">${activity.icon}</span>
                    <span class="activity-text">${activity.text}</span>
                    <span class="activity-time">${activity.time}</span>
                `;
                feed.appendChild(item);
            });
        })
        .catch(error => console.error('Activity feed error:', error));
}

// Initialize charts and real-time updates when page loads
document.addEventListener('DOMContentLoaded', function() {
    startRealTimeUpdates();
    updateKPIs();
    updateRealTimeFeed();
});
</script>
{% endblock %}</old_str>
<new_str>
{% extends "base.html" %}

{% block title %}Analytics - Super Admin{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1>üìä Advanced Analytics Dashboard</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Analytics
        </div>
    </div>
    
    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card revenue">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-content">
                <h3>Bugungi Daromad</h3>
                <div class="kpi-value" id="today-revenue">0 so'm</div>
                <div class="kpi-change positive" id="revenue-change">+12.5%</div>
            </div>
        </div>
        
        <div class="kpi-card orders">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-content">
                <h3>Bugungi Buyurtmalar</h3>
                <div class="kpi-value" id="today-orders">0</div>
                <div class="kpi-change positive" id="orders-change">+8.3%</div>
            </div>
        </div>
        
        <div class="kpi-card users">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-content">
                <h3>Faol Foydalanuvchilar</h3>
                <div class="kpi-value" id="active-users">0</div>
                <div class="kpi-change neutral" id="users-change">+2.1%</div>
            </div>
        </div>
        
        <div class="kpi-card rating">
            <div class="kpi-icon">‚≠ê</div>
            <div class="kpi-content">
                <h3>O'rtacha Baho</h3>
                <div class="kpi-value" id="avg-rating">4.5</div>
                <div class="kpi-change positive" id="rating-change">+0.2</div>
            </div>
        </div>
    </div>
    
    <!-- Time Period Selector -->
    <div class="time-selector">
        <label>Vaqt oralig'i:</label>
        <select id="timePeriod" onchange="updateAnalytics()">
            <option value="today">Bugun</option>
            <option value="week">Bu hafta</option>
            <option value="month">Bu oy</option>
            <option value="year">Bu yil</option>
        </select>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-grid">
        <div class="chart-container">
            <h3>üìà Daromad Trendi</h3>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>üìä Buyurtmalar Statistikasi</h3>
            <canvas id="ordersChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>ü•ò Eng Mashhur Taomlar</h3>
            <div id="popularItems"></div>
        </div>
        
        <div class="chart-container">
            <h3>üïí Soatlik Faollik</h3>
            <canvas id="hourlyChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- Detailed Statistics -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <h4>üí≥ To'lov Statistikasi</h4>
                <div id="paymentStats"></div>
            </div>
            
            <div class="stat-card">
                <h4>üöö Yetkazib Berish</h4>
                <div id="deliveryStats"></div>
            </div>
            
            <div class="stat-card">
                <h4>üìç Hudud bo'yicha</h4>
                <div id="regionStats"></div>
            </div>
            
            <div class="stat-card">
                <h4>üì± Qurilmalar</h4>
                <div id="deviceStats"></div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};

// Analytics ma'lumotlarini yuklash
function loadAnalytics(period = 'today') {
    fetch(`/api/super-admin/analytics?period=${period}`)
        .then(response => response.json())
        .then(data => {
            updateKPIs(data.kpis);
            updateCharts(data.charts);
            updateStats(data.stats);
        })
        .catch(error => {
            console.error('Analytics yuklashda xatolik:', error);
        });
}

// KPI kartalarini yangilash
function updateKPIs(kpis) {
    document.getElementById('today-revenue').textContent = formatCurrency(kpis.revenue || 0);
    document.getElementById('today-orders').textContent = kpis.orders || 0;
    document.getElementById('active-users').textContent = kpis.activeUsers || 0;
    document.getElementById('avg-rating').textContent = (kpis.avgRating || 0).toFixed(1);
    
    // Change percentages
    updateChangeIndicator('revenue-change', kpis.revenueChange || 0);
    updateChangeIndicator('orders-change', kpis.ordersChange || 0);
    updateChangeIndicator('users-change', kpis.usersChange || 0);
    updateChangeIndicator('rating-change', kpis.ratingChange || 0);
}

// O'zgarish indikatorini yangilash
function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    element.textContent = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
    element.className = change >= 0 ? 'kpi-change positive' : 'kpi-change negative';
}

// Chartlarni yangilash
function updateCharts(chartData) {
    // Revenue chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    if (charts.revenue) charts.revenue.destroy();
    
    charts.revenue = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: chartData.revenue.labels || [],
            datasets: [{
                label: 'Daromad',
                data: chartData.revenue.data || [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
    
    // Orders chart
    const ordersCtx = document.getElementById('ordersChart').getContext('2d');
    if (charts.orders) charts.orders.destroy();
    
    charts.orders = new Chart(ordersCtx, {
        type: 'doughnut',
        data: {
            labels: ['Kutilmoqda', 'Tayyor', 'Berildi', 'Bekor qilindi'],
            datasets: [{
                data: chartData.orders.data || [0, 0, 0, 0],
                backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    
    // Hourly chart
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    if (charts.hourly) charts.hourly.destroy();
    
    charts.hourly = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: chartData.hourly.labels || [],
            datasets: [{
                label: 'Buyurtmalar',
                data: chartData.hourly.data || [],
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Mashhur mahsulotlarni ko'rsatish
function updatePopularItems(items) {
    const container = document.getElementById('popularItems');
    let html = '<div class="popular-items">';
    
    items.forEach((item, index) => {
        html += `
            <div class="popular-item">
                <span class="rank">#${index + 1}</span>
                <span class="name">${item.name}</span>
                <span class="count">${item.orders_count} buyurtma</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Statistikalarni yangilash
function updateStats(stats) {
    // To'lov statistikasi
    document.getElementById('paymentStats').innerHTML = `
        <div class="stat-item">
            <span>Karta orqali:</span>
            <span>${stats.cardPayments || 0}%</span>
        </div>
        <div class="stat-item">
            <span>Naqd:</span>
            <span>${stats.cashPayments || 0}%</span>
        </div>
    `;
    
    // Yetkazib berish statistikasi
    document.getElementById('deliveryStats').innerHTML = `
        <div class="stat-item">
            <span>Yetkazib berish:</span>
            <span>${stats.deliveryOrders || 0}</span>
        </div>
        <div class="stat-item">
            <span>Olib ketish:</span>
            <span>${stats.pickupOrders || 0}</span>
        </div>
        <div class="stat-item">
            <span>O'rtacha vaqt:</span>
            <span>${stats.avgDeliveryTime || 0} daq</span>
        </div>
    `;
    
    // Hudud statistikasi
    document.getElementById('regionStats').innerHTML = `
        <div class="stat-item">
            <span>Toshkent:</span>
            <span>${stats.tashkentOrders || 0}</span>
        </div>
        <div class="stat-item">
            <span>Boshqa hududlar:</span>
            <span>${stats.otherRegions || 0}</span>
        </div>
    `;
}

// Vaqt oralig'ini yangilash
function updateAnalytics() {
    const period = document.getElementById('timePeriod').value;
    loadAnalytics(period);
}

// Pul formatini ko'rsatish
function formatCurrency(amount) {
    return new Intl.NumberFormat('uz-UZ').format(amount) + ' so\'m';
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js kutubxonasini yuklash
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => {
            console.log('Chart.js yuklandi');
            loadAnalytics();
        };
        script.onerror = () => {
            console.error('Chart.js yuklanmadi, mock ma\'lumotlar ishlatiladi');
            loadMockAnalytics();
        };
        document.head.appendChild(script);
    } else {
        loadAnalytics();
    }
});

// Mock analytics ma'lumotlari
function loadMockAnalytics() {
    // Mock KPI ma'lumotlari
    updateKPIs({
        revenue: 2500000,
        orders: 45,
        activeUsers: 23,
        avgRating: 4.7,
        revenueChange: 12.5,
        ordersChange: 8.3,
        usersChange: 2.1,
        ratingChange: 0.2
    });
    
    // Mock chartlar uchun canvas elementlarini tekshirish
    const revenueCanvas = document.getElementById('revenueChart');
    const ordersCanvas = document.getElementById('ordersChart');
    const hourlyCanvas = document.getElementById('hourlyChart');
    
    if (revenueCanvas) {
        revenueCanvas.style.background = '#f8f9fa';
        revenueCanvas.style.border = '1px solid #dee2e6';
        const ctx = revenueCanvas.getContext('2d');
        ctx.fillStyle = '#6c757d';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Chart.js yuklanmadi', revenueCanvas.width/2, revenueCanvas.height/2);
    }
    
    // Mock statistikalar
    updateStats({
        cardPayments: 75,
        cashPayments: 25,
        deliveryOrders: 120,
        pickupOrders: 80,
        avgDeliveryTime: 25,
        tashkentOrders: 150,
        otherRegions: 50
    });
}
</script>

<style>
.analytics-container {
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
}

.analytics-header {
    margin-bottom: 30px;
}

.analytics-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.2s ease;
}

.kpi-card:hover {
    transform: translateY(-2px);
}

.kpi-card.revenue { border-left: 4px solid #28a745; }
.kpi-card.orders { border-left: 4px solid #007bff; }
.kpi-card.users { border-left: 4px solid #6f42c1; }
.kpi-card.rating { border-left: 4px solid #ffc107; }

.kpi-icon {
    font-size: 3rem;
    opacity: 0.8;
}

.kpi-content h3 {
    font-size: 1rem;
    color: #718096;
    margin-bottom: 8px;
}

.kpi-value {
    font-size: 2rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
}

.kpi-change {
    font-size: 0.9rem;
    font-weight: 500;
}

.kpi-change.positive { color: #28a745; }
.kpi-change.negative { color: #dc3545; }
.kpi-change.neutral { color: #6c757d; }

.time-selector {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.time-selector label {
    font-weight: 500;
    color: #2d3748;
}

.time-selector select {
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.chart-container h3 {
    margin-bottom: 20px;
    color: #2d3748;
    font-size: 1.2rem;
}

.stats-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.stat-card {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px;
}

.stat-card h4 {
    margin-bottom: 15px;
    color: #2d3748;
    font-size: 1.1rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f7fafc;
}

.stat-item:last-child {
    border-bottom: none;
}

.popular-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.popular-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
}

.popular-item .rank {
    font-weight: bold;
    color: #007bff;
    min-width: 30px;
}

.popular-item .name {
    flex: 1;
    font-weight: 500;
}

.popular-item .count {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .analytics-container {
        padding: 15px;
    }
    
    .kpi-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .kpi-card {
        padding: 20px;
    }
    
    .kpi-icon {
        font-size: 2.5rem;
    }
    
    .kpi-value {
        font-size: 1.5rem;
    }
    
    .time-selector {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>
{% endblock %}</new_str>
{% extends "base.html" %}

{% block content %}
<div class="analytics-container">
    <h1>üìä Analytics Dashboard</h1>
    
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3>üìà Sotuvlar Statistikasi</h3>
            <canvas id="salesChart"></canvas>
        </div>
        
        <div class="analytics-card">
            <h3>üë• Foydalanuvchilar Faolligi</h3>
            <canvas id="usersChart"></canvas>
        </div>
        
        <div class="analytics-card">
            <h3>üçΩÔ∏è Mashhur Mahsulotlar</h3>
            <canvas id="productsChart"></canvas>
        </div>
        
        <div class="analytics-card">
            <h3>üí∞ Daromad Tahlili</h3>
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    
    <div class="back-button">
        <a href="{{ url_for('super_admin_dashboard') }}" class="btn btn-primary">‚¨ÖÔ∏è Dashboard ga qaytish</a>
    </div>
</div>

<style>
.analytics-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.analytics-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.back-button {
    text-align: center;
}
</style>
{% endblock %}
