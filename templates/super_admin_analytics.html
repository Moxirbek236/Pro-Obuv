
{% extends "base.html" %}

{% block title %}Analytics - Super Admin{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1>📊 Biznes Analytics va Statistika</h1>
        <div class="breadcrumb">
            <a href="{{ url_for('super_admin_dashboard') }}">Dashboard</a> / Analytics
        </div>
    </div>

    <!-- Asosiy metrikalar -->
    <div class="metrics-grid">
        <div class="metric-card revenue">
            <div class="metric-icon">💰</div>
            <div class="metric-content">
                <h4>Jami Daromad</h4>
                <div class="metric-value">{{ "{:,}".format(analytics.monthly.revenue) }} so'm</div>
                <div class="metric-subtitle">Oxirgi 30 kun</div>
            </div>
        </div>

        <div class="metric-card orders">
            <div class="metric-icon">📦</div>
            <div class="metric-content">
                <h4>Jami Buyurtmalar</h4>
                <div class="metric-value">{{ analytics.monthly.orders }}</div>
                <div class="metric-subtitle">Oxirgi 30 kun</div>
            </div>
        </div>

        <div class="metric-card daily">
            <div class="metric-icon">📅</div>
            <div class="metric-content">
                <h4>Bugungi Daromad</h4>
                <div class="metric-value">{{ "{:,}".format(analytics.daily.revenue) }} so'm</div>
                <div class="metric-subtitle">{{ analytics.daily.orders }} buyurtma</div>
            </div>
        </div>

        <div class="metric-card weekly">
            <div class="metric-icon">📈</div>
            <div class="metric-content">
                <h4>Haftalik O'sish</h4>
                <div class="metric-value">+{{ "%.1f"|format(((analytics.weekly.revenue / (analytics.monthly.revenue or 1)) * 100)) }}%</div>
                <div class="metric-subtitle">{{ analytics.weekly.orders }} buyurtma</div>
            </div>
        </div>
    </div>

    <!-- Grafik va jadvallar -->
    <div class="analytics-content">
        <div class="analytics-tabs">
            <button class="analytics-tab active" onclick="showAnalyticsTab('revenue')">💰 Daromad Tahlili</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('orders')">📊 Buyurtmalar Tahlili</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('products')">🍽️ Mahsulotlar</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('customers')">👥 Mijozlar</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('performance')">⚡ Performance</button>
        </div>

        <!-- Daromad tahlili -->
        <div id="revenue-analytics" class="analytics-section active">
            <h3>💰 Daromad Tahlili</h3>
            <div class="revenue-stats">
                <div class="revenue-chart" id="revenueChart">
                    <canvas id="revenueChartCanvas" width="400" height="200"></canvas>
                </div>
                <div class="revenue-breakdown">
                    <h4>Davr bo'yicha daromad:</h4>
                    <div class="breakdown-item">
                        <span>Bugun:</span>
                        <span class="amount">{{ "{:,}".format(analytics.daily.revenue) }} so'm</span>
                    </div>
                    <div class="breakdown-item">
                        <span>Bu hafta:</span>
                        <span class="amount">{{ "{:,}".format(analytics.weekly.revenue) }} so'm</span>
                    </div>
                    <div class="breakdown-item">
                        <span>Bu oy:</span>
                        <span class="amount">{{ "{:,}".format(analytics.monthly.revenue) }} so'm</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buyurtmalar tahlili -->
        <div id="orders-analytics" class="analytics-section">
            <h3>📊 Buyurtmalar Tahlili</h3>
            <div class="orders-overview" id="ordersData">
                <p class="text-center">Ma'lumotlar yuklanmoqda...</p>
            </div>
        </div>

        <!-- Mahsulotlar tahlili -->
        <div id="products-analytics" class="analytics-section">
            <h3>🍽️ Mahsulotlar Tahlili</h3>
            <div class="products-overview" id="productsData">
                <p class="text-center">Ma'lumotlar yuklanmoqda...</p>
            </div>
        </div>

        <!-- Mijozlar tahlili -->
        <div id="customers-analytics" class="analytics-section">
            <h3>👥 Mijozlar Tahlili</h3>
            <div class="customers-overview" id="customersData">
                <p class="text-center">Ma'lumotlar yuklanmoqda...</p>
            </div>
        </div>

        <!-- Performance tahlili -->
        <div id="performance-analytics" class="analytics-section">
            <h3>⚡ Performance Tahlili</h3>
            <div class="performance-overview">
                <div class="performance-metrics">
                    <div class="perf-metric">
                        <h4>🚀 Server Performance</h4>
                        <div class="perf-indicator good">Yaxshi</div>
                        <div class="perf-details">
                            <div>CPU: 45%</div>
                            <div>Memory: 62%</div>
                            <div>Response time: 250ms</div>
                        </div>
                    </div>
                    
                    <div class="perf-metric">
                        <h4>📊 Database Performance</h4>
                        <div class="perf-indicator excellent">A'lo</div>
                        <div class="perf-details">
                            <div>Query time: 15ms</div>
                            <div>Connections: 5/20</div>
                            <div>Cache hit: 87%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="back-button">
        <a href="{{ url_for('super_admin_dashboard') }}" class="btn btn-primary">⬅️ Dashboard ga qaytish</a>
    </div>
</div>

<script>
function showAnalyticsTab(tabName) {
    // Barcha tablarni yashirish
    document.querySelectorAll('.analytics-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Barcha tugmalardan active ni olib tashlash
    document.querySelectorAll('.analytics-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Kerakli section va tugmani faollashtirish
    document.getElementById(`${tabName}-analytics`).classList.add('active');
    event.target.classList.add('active');
    
    // Ma'lumotlarni yuklash
    if (tabName === 'orders') {
        loadOrdersAnalytics();
    } else if (tabName === 'products') {
        loadProductsAnalytics();
    } else if (tabName === 'customers') {
        loadCustomersAnalytics();
    }
}

function loadOrdersAnalytics() {
    fetch('/api/super-admin/reports?type=monthly')
        .then(response => response.json())
        .then(data => {
            let html = `
                <div class="orders-stats">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <h5>Jami buyurtmalar</h5>
                            <div class="stat-number">${data.summary.total_orders}</div>
                        </div>
                        <div class="stat-item">
                            <h5>O'rtacha check</h5>
                            <div class="stat-number">${Math.round(data.summary.total_revenue / data.summary.total_orders || 0).toLocaleString()} so'm</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('ordersData').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('ordersData').innerHTML = '<p class="text-center">Ma\'lumotlarni yuklashda xatolik</p>';
        });
}

function loadProductsAnalytics() {
    fetch('/super-admin/get-menu')
        .then(response => response.json())
        .then(data => {
            let html = '<div class="products-table">';
            html += '<table class="analytics-table"><thead><tr>';
            html += '<th>Mahsulot</th><th>Kategoriya</th><th>Sotilgan</th><th>Narxi</th><th>Baho</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(product => {
                html += `<tr>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.category}</td>
                    <td>${product.orders_count || 0}</td>
                    <td>${product.price.toLocaleString()} so'm</td>
                    <td>${product.rating || 0} ⭐</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('productsData').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('productsData').innerHTML = '<p class="text-center">Ma\'lumotlarni yuklashda xatolik</p>';
        });
}

function loadCustomersAnalytics() {
    fetch('/api/super-admin/reports?type=monthly')
        .then(response => response.json())
        .then(data => {
            let html = '<div class="customers-table">';
            html += '<table class="analytics-table"><thead><tr>';
            html += '<th>Mijoz</th><th>Email</th><th>Buyurtmalar</th><th>Jami xarid</th>';
            html += '</tr></thead><tbody>';
            
            data.customers.forEach(customer => {
                html += `<tr>
                    <td><strong>${customer.first_name} ${customer.last_name}</strong></td>
                    <td>${customer.email}</td>
                    <td>${customer.orders_count || 0}</td>
                    <td>${(customer.total_spent || 0).toLocaleString()} so'm</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('customersData').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('customersData').innerHTML = '<p class="text-center">Ma\'lumotlarni yuklashda xatolik</p>';
        });
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    // Default tab - revenue
    loadOrdersAnalytics();
});
</script>

<style>
.analytics-container {
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
}

.analytics-header {
    margin-bottom: 30px;
}

.analytics-header h1 {
    color: #2d3748;
    margin-bottom: 10px;
}

.breadcrumb {
    color: #718096;
    font-size: 14px;
}

.breadcrumb a {
    color: #3182ce;
    text-decoration: none;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
    border-left: 4px solid #007bff;
}

.metric-card.revenue { border-left-color: #28a745; }
.metric-card.orders { border-left-color: #007bff; }
.metric-card.daily { border-left-color: #ffc107; }
.metric-card.weekly { border-left-color: #17a2b8; }

.metric-icon {
    font-size: 3rem;
    opacity: 0.8;
}

.metric-content h4 {
    color: #718096;
    font-size: 1rem;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
}

.metric-subtitle {
    color: #a0aec0;
    font-size: 0.9rem;
}

.analytics-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 30px;
}

.analytics-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #e2e8f0;
    overflow-x: auto;
}

.analytics-tab {
    background: none;
    border: none;
    padding: 15px 25px;
    cursor: pointer;
    font-size: 14px;
    color: #718096;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.analytics-tab.active,
.analytics-tab:hover {
    background: white;
    color: #2d3748;
    border-bottom: 3px solid #007bff;
}

.analytics-section {
    display: none;
    padding: 25px;
}

.analytics-section.active {
    display: block;
}

.analytics-section h3 {
    margin-bottom: 20px;
    color: #2d3748;
}

.revenue-stats {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    align-items: start;
}

.revenue-chart {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    min-height: 300px;
}

.revenue-breakdown h4 {
    margin-bottom: 15px;
    color: #2d3748;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #e2e8f0;
}

.amount {
    font-weight: bold;
    color: #28a745;
}

.analytics-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.analytics-table th,
.analytics-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.analytics-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2d3748;
}

.analytics-table tr:hover {
    background: #f8f9fa;
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-item h5 {
    margin-bottom: 10px;
    color: #718096;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}

.performance-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.perf-metric {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
}

.perf-metric h4 {
    margin-bottom: 15px;
    color: #2d3748;
}

.perf-indicator {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    display: inline-block;
}

.perf-indicator.excellent { background: #d4edda; color: #155724; }
.perf-indicator.good { background: #cce7f0; color: #0c5460; }
.perf-indicator.warning { background: #fff3cd; color: #856404; }

.perf-details {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 0.9rem;
    color: #6c757d;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
    color: white;
    text-decoration: none;
}

.back-button {
    text-align: center;
}

.text-center { text-align: center; }

/* Mobile responsive */
@media (max-width: 768px) {
    .analytics-container {
        padding: 15px;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .metric-card {
        flex-direction: column;
        text-align: center;
    }
    
    .revenue-stats {
        grid-template-columns: 1fr;
    }
    
    .analytics-tabs {
        flex-direction: column;
    }
    
    .performance-metrics {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
