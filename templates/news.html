{% extends "base.html" %} {% block title %}Yangiliklar - PRO-OBUV{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1 class="mb-3">ðŸ“° Yangiliklar</h1>

  {% if session.get('super_admin') %}
  <div class="mb-3">
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#newsModalPublic"
      onclick="openNewsModalPublic()">
      âž• Yangilik qo'shish
    </button>
  </div>
  {% endif %}

  <!-- Simple ticker: recent titles -->
  <div
    id="news-ticker"
    class="mb-3"
    style="
      background: #111;
      color: #fff;
      padding: 8px;
      border-radius: 6px;
      overflow: hidden;
    ">
    <div
      id="ticker-inner"
      style="
        white-space: nowrap;
        display: inline-block;
        animation: ticker 20s linear infinite;
      "></div>
  </div>

  <style>
    @keyframes ticker {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }
    /* Unified news card styles */
    .news-item {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 220px; /* uniform card height for visual consistency */
    }
    .news-item .d-flex {
      align-items: center;
      gap: 10px;
    }
    .news-media {
      margin-top: 6px;
      margin-bottom: 6px;
      width: 100%;
      max-height: 360px;
      overflow: hidden;
      border-radius: 8px;
      display: block;
    }
    .news-media img,
    .news-media video,
    .news-media iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .news-body {
      flex: 1 1 auto;
      overflow: hidden;
    }

    /* Responsive stack for narrower screens */
    @media (min-width: 900px) {
      #news-list .news-item {
        flex-direction: row;
        align-items: stretch;
        min-height: 180px;
      }
      .news-media {
        width: 34%;
        max-width: 420px;
      }
      .news-body {
        width: 66%;
        padding-left: 16px;
      }
    }
    @media (max-width: 899px) {
      .news-item {
        min-height: auto;
      }
    }
    /* Date positioning inside news card */
    .news-card-date {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      background: rgba(0, 0, 0, 0.15);
      padding: 4px 8px;
      border-radius: 6px;
    }
  </style>

  {% if news %}
  <div id="news-list">
    {% for item in news %}
    <article class="news-item card p-3 position-relative">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="h5 mb-0">{{ item.title }}</h3>
      </div>

      <div class="news-media">
        {% if item.youtube_embed %}
        <div
          style="
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 8px;
          ">
          <iframe
            src="{{ item.youtube_embed }}"
            style="
              position: absolute;
              inset: 0;
              width: 100%;
              height: 100%;
              border: 0;
            "
            allowfullscreen></iframe>
        </div>
        {% elif item.video or item.video_url %}
        <div style="width: 100%; height: 100%">
          <video
            controls
            style="
              width: 100%;
              height: 100%;
              object-fit: cover;
              border-radius: 8px;
            ">
            <source src="{{ item.video_url or item.video }}" />
          </video>
        </div>
        {% elif item.image or item.image_url %}
        <img src="{{ item.image_url or item.image }}" alt="{{ item.title }}" />
        {% endif %}
      </div>

      <div class="news-body">
        <p>{{ (item.description or item.content) | safe }}</p>
      </div>
      <div style="position: absolute; right: 12px; bottom: 12px">
        <small class="text-muted news-card-date"
          >{{ item.created_at.split('T')[0] if item.created_at else '' }}</small
        >
      </div>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">Hozircha yangiliklar mavjud emas.</div>
  {% endif %}
</div>

<script>
  (function(){
    const news = {{ (news|length if news else 0) }};
    const items = [];
    {% for it in news %}
      items.push("{{ it.title|replace('"','\"') }}");
    {% endfor %}
    const ticker = document.getElementById('ticker-inner');
    if(items.length){
      ticker.innerText = items.join('  â€¢  ');
    } else {
      ticker.innerText = 'Yangiliklar yo\'q';
    }
  })();
</script>

<!-- Public Add News Modal (for superadmin on /news page) -->
{% if session.get('super_admin') %}
<div class="modal fade" id="newsModalPublic" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yangilik qo'shish</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newsFormPublic">
          <div class="mb-3">
            <label class="form-label">Sarlavha *</label>
            <input
              type="text"
              id="newsTitlePublic"
              class="form-control"
              required
              maxlength="200" />
          </div>
          <div class="mb-3">
            <label class="form-label">Matn</label>
            <textarea
              id="newsContentPublic"
              class="form-control"
              rows="3"
              maxlength="500"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Rasm</label>
              <input
                type="file"
                id="newsImageFilePublic"
                class="form-control"
                accept="image/*"
                onchange="uploadMediaFilePublic('image')" />
              <input type="hidden" id="newsImageUrlPublic" />
              <img
                id="imagePreviewPublic"
                style="display: none; max-width: 180px; margin-top: 8px" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Video (yuklash yoki YouTube URL)</label>
              <input
                type="file"
                id="newsVideoFilePublic"
                class="form-control"
                accept="video/*"
                onchange="uploadMediaFilePublic('video')" />
              <input type="hidden" id="newsVideoUrlPublic" />
              <video
                id="videoPreviewPublic"
                style="display: none; max-width: 180px; margin-top: 8px"
                controls
                muted></video>

              <div class="mt-2">
                <label class="form-label">YouTube URL (ixtiyoriy)</label>
                <input
                  type="url"
                  id="newsYoutubeUrlPublic"
                  class="form-control"
                  placeholder="https://www.youtube.com/watch?v=..." />
                <small class="form-text text-muted"
                  >Agar YouTube havolasi kiritilsa, yuklangan video o'rniga shu
                  manba ishlatiladi.</small
                >

                <div
                  id="youtubePreviewPublicContainer"
                  style="
                    display: none;
                    margin-top: 8px;
                    position: relative;
                    padding-bottom: 56.25%;
                    height: 0;
                    overflow: hidden;
                    border-radius: 8px;
                  ">
                  <iframe
                    id="youtubePreviewPublic"
                    style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      border: 0;
                    "
                    allowfullscreen></iframe>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3 mt-2">
            <label class="form-label">Turi</label>
            <select id="newsTypePublic" class="form-control">
              <option value="news">ðŸ“° Yangilik</option>
              <option value="advertisement">ðŸ“¢ Reklama</option>
            </select>
          </div>
          <div class="form-check mb-3">
            <input
              type="checkbox"
              id="newsIsActivePublic"
              class="form-check-input"
              checked />
            <label for="newsIsActivePublic" class="form-check-label"
              >Faol</label
            >
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Bekor qilish
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveNewsPublic()">
          Saqlash
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function openNewsModalPublic() {
    document.getElementById("newsFormPublic").reset();
    document.getElementById("imagePreviewPublic").style.display = "none";
    document.getElementById("videoPreviewPublic").style.display = "none";
    document.getElementById("newsImageUrlPublic").value = "";
    document.getElementById("newsVideoUrlPublic").value = "";
    if (document.getElementById("newsYoutubeUrlPublic")) {
      document.getElementById("newsYoutubeUrlPublic").value = "";
      const ytCont = document.getElementById("youtubePreviewPublicContainer");
      if (ytCont) ytCont.style.display = "none";
      const ytIframe = document.getElementById("youtubePreviewPublic");
      if (ytIframe) ytIframe.src = "";
    }
  }

  function uploadMediaFilePublic(type) {
    const fileInput = document.getElementById(
      type === "image" ? "newsImageFilePublic" : "newsVideoFilePublic"
    );
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("file", file);

    fetch("/admin/upload-news-media", { method: "POST", body: formData })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          if (type === "image") {
            document.getElementById("newsImageUrlPublic").value = data.file_url;
            const img = document.getElementById("imagePreviewPublic");
            img.src = data.file_url;
            img.style.display = "block";
          } else {
            document.getElementById("newsVideoUrlPublic").value = data.file_url;
            const vid = document.getElementById("videoPreviewPublic");
            vid.src = data.file_url;
            vid.style.display = "block";
            // clear youtube preview when uploading a file
            const yt = document.getElementById("newsYoutubeUrlPublic");
            if (yt) yt.value = "";
            const ytCont = document.getElementById(
              "youtubePreviewPublicContainer"
            );
            if (ytCont) ytCont.style.display = "none";
          }
        } else {
          alert("Upload xatosi: " + (data.message || ""));
        }
      })
      .catch((err) => {
        console.error("Upload error", err);
        alert("Fayl yuklashda xatolik");
      });
  }

  function saveNewsPublic() {
    const title = document.getElementById("newsTitlePublic").value.trim();
    if (!title) {
      alert("Sarlavha kiritilishi shart");
      return;
    }

    // Prefer YouTube URL over uploaded video file
    const youtubeUrl =
      (document.getElementById("newsYoutubeUrlPublic") &&
        document.getElementById("newsYoutubeUrlPublic").value.trim()) ||
      "";
    const computedVideoUrl =
      youtubeUrl || document.getElementById("newsVideoUrlPublic").value;

    const payload = {
      title: title,
      content: document.getElementById("newsContentPublic").value.trim(),
      type: document.getElementById("newsTypePublic").value,
      image_url: document.getElementById("newsImageUrlPublic").value,
      video_url: computedVideoUrl,
      is_active: document.getElementById("newsIsActivePublic").checked,
      display_order: 0,
    };

    fetch("/api/news", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          alert("Yangilik qo'shildi");
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("newsModalPublic")
          );
          if (modal) modal.hide();
          // reload page to show new item
          window.location.reload();
        } else {
          alert("Xato: " + (data.message || ""));
        }
      })
      .catch((err) => {
        console.error(err);
        alert("Saqlashda xatolik");
      });
  }

  // Show small YouTube preview when URL is entered in public modal
  (function () {
    const el = document.getElementById("newsYoutubeUrlPublic");
    if (!el) return;
    el.addEventListener("input", function () {
      const v = el.value.trim();
      const container = document.getElementById(
        "youtubePreviewPublicContainer"
      );
      const iframe = document.getElementById("youtubePreviewPublic");
      if (!v) {
        iframe.src = "";
        container.style.display = "none";
        return;
      }
      try {
        const m = v.match(/(?:v=|\/embed\/|youtu\.be\/)([A-Za-z0-9_\-]{11})/);
        if (m && m[1]) {
          iframe.src = "https://www.youtube.com/embed/" + m[1];
          container.style.display = "block";
          // hide uploaded video preview
          const vp = document.getElementById("videoPreviewPublic");
          if (vp) vp.style.display = "none";
        } else {
          iframe.src = "";
          container.style.display = "none";
        }
      } catch (err) {
        iframe.src = "";
        container.style.display = "none";
      }
    });
  })();
</script>
{% endif %} {% endblock %}
