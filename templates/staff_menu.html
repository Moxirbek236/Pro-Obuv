{% extends "base.html" %} {% block content %}
<div class="card">
  <h2>üìã Mahsulotlar boshqaruvi</h2>
  <p class="muted">Do'kon mahsulotlarini boshqaring</p>

  <div style="margin-bottom: 30px">
    <h3>Yangi mahsulot qo'shish</h3>
    <form
      method="post"
      action="{{ url_for('admin_add_menu_item') }}"
      class="add-item-form"
      enctype="multipart/form-data">
      <div class="form-grid">
        <div>
          <label>Nomi:</label>
          <input type="text" name="name" required placeholder="Mahsulot nomi" />
        </div>
        <div>
          <label>Narxi (so'm):</label>
          <input type="number" name="price" required placeholder="25000" />
        </div>
        <div>
          <label>Kategoriya:</label>
          <select name="category" required>
            <option value="">Tanlang</option>
            <option value="specobuv">ü•æ –°–ø–µ—Ü–æ–±—É–≤—å</option>
            <option value="specodezhda">ü¶∫ –°–ø–µ—Ü–æ–¥–µ–∂–¥–∞</option>
          </select>
        </div>
        <div>
          <label>Mahsulot rasmlari va videolar:</label>
          <input
            type="file"
            name="media_files"
            accept="image/*,video/*"
            multiple
            placeholder="Rasm va videolar tanlang" />
          <small class="text-muted"
            >Ko'p fayllarni birga tanlash mumkin. Birinchi rasm asosiy
            bo'ladi.</small
          >
        </div>
        <div>
          <label>Chegirma (%):</label>
          <input
            type="number"
            name="discount_percentage"
            step="0.1"
            min="0"
            max="100"
            placeholder="0" />
        </div>
        <div>
          <label>O'lchamlar (vergul bilan):</label>
          <input type="text" name="sizes" placeholder="e.g. 36,37,38,39" />
        </div>
        <div>
          <label>Ranglar (vergul bilan):</label>
          <input
            type="text"
            name="colors"
            placeholder="e.g. black,brown,white" />
        </div>
        <div>
          <label>Tavsif:</label>
          <textarea
            name="description"
            placeholder="Mahsulot haqida qisqacha ma'lumot"
            rows="2"></textarea>
        </div>
        <div style="display: flex; align-items: end">
          <button type="submit" class="btn">‚ûï Qo'shish</button>
        </div>
      </div>
    </form>
  </div>

  <div class="menu-items">
    <h3>Mavjud mahsulotlar</h3>
    <div class="menu-items-grid">
      {% for item in menu_items %}
      <div
        class="menu-item-card {% if not item.available %}unavailable{% endif %}">
        <div class="item-image">
          <img
            src="{{ item.image_url or 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&h=200&fit=crop' }}"
            alt="{{ item.name }}"
            onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=300&h=200&fit=crop'" />
        </div>

        <div class="item-details">
          <h4>{{ item.name }}</h4>
          <p class="item-description">
            {{ item.description or 'Tavsif mavjud emas' }}
          </p>

          <div class="price-section">
            {% if item.discount_percentage and item.discount_percentage > 0 %}
            <div class="price-with-discount">
              <span class="original-price"
                >{{ "{:,.0f}".format(item.price) }} so'm</span
              >
              <span class="discount-price"
                >{{ "{:,.0f}".format(item.price * (100 -
                item.discount_percentage) / 100) }} so'm</span
              >
              <span class="discount-badge"
                >-{{ item.discount_percentage }}%</span
              >
            </div>
            {% else %}
            <span class="price">{{ "{:,.0f}".format(item.price) }} so'm</span>
            {% endif %}
          </div>

          <div class="item-info">
            <span class="category">
              {% if item.category == 'tufli' %}üëû Tufli {% elif item.category ==
              'etik' %}ü•æ Etik {% elif item.category == 'mokasima' %}ü©¥ Mokasima
              {% elif item.category == 'krosovka' %}üëü Krosovka {% elif
              item.category == 'botik' %}ü©∞ Botik {% elif item.category ==
              'tapochka' %}üè† Tapochka {% elif item.category == 'sandal' %}üë°
              Sandal {% elif item.category == 'tuflya' %}üë† Tuflya {% else %}üëü
              Oyoq kiyim{% endif %}
            </span>
            <span
              class="status {% if item.available %}available{% else %}unavailable{% endif %}">
              {% if item.available %}‚úÖ Mavjud{% else %}‚ùå Mavjud emas{% endif
              %}
            </span>
          </div>

          <!-- Baho ko'rsatish -->
          <div class="rating-info">
            <div class="rating-display">
              <span class="rating-stars">
                {% for i in range(1, 6) %} {% if i <= (item.rating or 0) %}‚≠ê{%
                else %}‚òÜ{% endif %} {% endfor %}
              </span>
              <span class="rating-text"
                >{{ "%.1f"|format(item.rating or 0) }} ({{ item.orders_count or
                0 }} buyurtma)</span
              >
            </div>
            <button class="btn small" onclick="showItemRatings({{ item.id }})">
              üìä Baholarni ko'rish
            </button>
          </div>

          <!-- Tahrirlash formasƒ± -->
          <div
            class="edit-form"
            id="edit-form-{{ item.id }}"
            style="display: none">
            <form
              method="post"
              action="{{ url_for('admin_edit_menu_item', item_id=item.id) }}"
              enctype="multipart/form-data">
              <div class="edit-grid">
                <input
                  type="text"
                  name="name"
                  value="{{ item.name }}"
                  placeholder="Nomi"
                  required />
                <input
                  type="number"
                  name="price"
                  value="{{ item.price }}"
                  placeholder="Narxi"
                  required />
                <input
                  type="number"
                  name="discount_percentage"
                  value="{{ item.discount_percentage or 0 }}"
                  placeholder="Skidka %"
                  min="0"
                  max="100"
                  step="0.1" />
                <input
                  type="text"
                  name="sizes"
                  value="{{ item.sizes or '' }}"
                  placeholder="O'lchamlar (36,37,38)" />
                <input
                  type="text"
                  name="colors"
                  value="{{ item.colors or '' }}"
                  placeholder="Ranglar (black,brown)" />
                <input
                  type="file"
                  name="media_files"
                  accept="image/*,video/*"
                  multiple />
                <textarea name="description" placeholder="Tavsif">
{{ item.description }}</textarea
                >
                <div class="edit-buttons">
                  <button type="submit" class="btn small success">
                    üíæ Saqlash
                  </button>
                  <button
                    type="button"
                    class="btn small"
                    onclick="toggleEdit({{ item.id }})">
                    ‚ùå Bekor qilish
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="item-actions">
            <button class="btn small" onclick="toggleEdit({{ item.id }})">
              ‚úèÔ∏è Tahrirlash
            </button>
            <button
              type="button"
              class="btn small"
              onclick="toggleMenuItem({{ item.id }})">
              {% if item.available %}Yashirish{% else %}Ko'rsatish{% endif %}
            </button>
            <button
              type="button"
              class="btn small danger"
              onclick="deleteMenuItem({{ item.id }}, '{{ item.name }}')">
              üóëÔ∏è O'chirish
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div style="margin-top: 20px">
    <a href="{{ url_for('staff_dashboard') }}" class="btn"
      >‚¨ÖÔ∏è Bosh sahifaga qaytish</a
    >
  </div>
</div>

<style>
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 15px;
    align-items: end;
  }

  .form-grid label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .form-grid input,
  .form-grid select,
  .form-grid textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .menu-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .menu-item-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .menu-item-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .menu-item-card.unavailable {
    opacity: 0.6;
    background: #f5f5f5;
  }

  .item-image {
    height: 200px;
    overflow: hidden;
  }

  .item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .item-details {
    padding: 15px;
  }

  .item-details h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.2em;
  }

  .item-description {
    color: #666;
    font-size: 0.9em;
    margin-bottom: 10px;
    line-height: 1.4;
  }

  .price-section {
    margin-bottom: 10px;
  }

  .price {
    color: #28a745;
    font-weight: bold;
    font-size: 1.1em;
  }

  .price-with-discount {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .original-price {
    color: #999;
    text-decoration: line-through;
    font-size: 0.9em;
  }

  .discount-price {
    color: #28a745;
    font-weight: bold;
    font-size: 1.1em;
  }

  .discount-badge {
    background: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
  }

  .item-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 0.9em;
  }

  .category {
    color: #666;
  }

  .status.available {
    color: #4caf50;
    font-weight: bold;
  }

  .status.unavailable {
    color: #f44336;
    font-weight: bold;
  }

  .edit-form {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
  }

  .edit-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }

  .edit-grid input,
  .edit-grid textarea {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .edit-grid textarea {
    grid-column: 1 / -1;
    resize: vertical;
    min-height: 60px;
  }

  .edit-buttons {
    grid-column: 1 / -1;
    display: flex;
    gap: 10px;
  }

  .item-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn.small {
    padding: 6px 12px;
    font-size: 0.85em;
  }

  .btn.success {
    background: #28a745;
    color: white;
  }

  .btn.success:hover {
    background: #218838;
  }

  .btn.danger {
    background: #dc3545;
    color: white;
  }

  .btn.danger:hover {
    background: #c82333;
  }

  .rating-info {
    margin: 10px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #ffd700;
  }

  .rating-display {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .rating-stars {
    font-size: 16px;
  }

  .rating-text {
    font-size: 0.9rem;
    color: #666;
  }

  /* Baholar modali */
  .ratings-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ratings-modal-content {
    background: white;
    border-radius: 15px;
    max-width: 600px;
    width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
  }

  .ratings-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 15px 15px 0 0;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .close-btn:hover {
    background: #f0f0f0;
    color: #333;
  }

  .ratings-summary {
    padding: 15px 20px;
    background: #fff3cd;
    border-left: 4px solid #ffd700;
    margin: 0;
  }

  .ratings-list {
    padding: 20px;
  }

  .rating-item {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
  }

  .rating-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .rating-user {
    font-weight: bold;
    color: #4299e1;
  }

  .rating-date {
    font-size: 0.8rem;
    color: #999;
  }

  .rating-comment {
    color: #555;
    line-height: 1.5;
    margin-top: 10px;
    padding: 10px;
    background: white;
    border-radius: 5px;
  }

  .no-ratings {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
  }

  @media (max-width: 768px) {
    .menu-items-grid {
      grid-template-columns: 1fr;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .edit-grid {
      grid-template-columns: 1fr;
    }

    .item-actions {
      justify-content: center;
    }

    .rating-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
    }
  }
</style>

<script>
  function toggleEdit(itemId) {
    const editForm = document.getElementById("edit-form-" + itemId);
    if (editForm.style.display === "none") {
      editForm.style.display = "block";
    } else {
      editForm.style.display = "none";
    }
  }

  function showItemRatings(itemId) {
    fetch(`/api/get-menu-ratings/${itemId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          let ratingsHtml = `
                    <div class="ratings-modal">
                        <div class="ratings-modal-content">
                            <div class="ratings-header">
                                <h3>Mahsulot baholari</h3>
                                <button onclick="closeRatingsModal()" class="close-btn">‚úï</button>
                            </div>
                            <div class="ratings-summary">
                                <p><strong>O'rtacha baho:</strong> ${data.average_rating}/5 (${data.total_ratings} baho)</p>
                            </div>
                            <div class="ratings-list">
                `;

          if (data.ratings.length > 0) {
            data.ratings.forEach((rating) => {
              ratingsHtml += `
                            <div class="rating-item">
                                <div class="rating-header">
                                    <span class="rating-user">${
                                      rating.user_name
                                    }</span>
                                    <span class="rating-stars">${"‚≠ê".repeat(
                                      rating.rating
                                    )}${"‚òÜ".repeat(5 - rating.rating)}</span>
                                    <span class="rating-date">${
                                      rating.created_at
                                    }</span>
                                </div>
                                ${
                                  rating.comment
                                    ? `<div class="rating-comment">${rating.comment}</div>`
                                    : ""
                                }
                            </div>
                        `;
            });
          } else {
            ratingsHtml += '<p class="no-ratings">Hali baholar yo\'q</p>';
          }

          ratingsHtml += `
                            </div>
                        </div>
                    </div>
                `;

          document.body.insertAdjacentHTML("beforeend", ratingsHtml);
        } else {
          alert("Baholarni yuklashda xatolik: " + data.message);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Baholarni yuklashda xatolik");
      });
  }

  function closeRatingsModal() {
    const modal = document.querySelector(".ratings-modal");
    if (modal) {
      modal.remove();
    }
  }

  function toggleMenuItem(itemId) {
    if (!confirm("Mahsulot holatini o'zgartirishni xohlaysizmi?")) {
      return;
    }

    fetch(`/admin/toggle_menu_item/${itemId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": typeof CSRF_TOKEN !== "undefined" ? CSRF_TOKEN : "",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Sahifani qayta yuklash
          location.reload();
        } else {
          alert(
            "Xatolik: " + (data.message || data.error || "Noma'lum xatolik")
          );
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Xatolik yuz berdi");
      });
  }

  function deleteMenuItem(itemId, itemName) {
    // Ikki marta tasdiqlash - xavfsizlik uchun
    if (
      !confirm(
        `Haqiqatan ham '${itemName}' mahsulotini butunlay o'chirmoqchimisiz?\n\n‚ö†Ô∏è DIQQAT: Bu amalni bekor qilish mumkin emas!`
      )
    ) {
      return;
    }

    if (
      !confirm(
        "Oxirgi tasdiqlash: Mahsulot va unga bog'liq barcha ma'lumotlar (buyurtmalar, baholar, sevimlilar) o'chiriladi. Davom etasizmi?"
      )
    ) {
      return;
    }

    // Loading indicator
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = "‚è≥ O'chirilmoqda...";
    button.disabled = true;

    fetch(`/admin/delete_menu_item/${itemId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": typeof CSRF_TOKEN !== "undefined" ? CSRF_TOKEN : "",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("‚úÖ " + (data.message || "Mahsulot muvaffaqiyatli o'chirildi"));
          // Sahifani qayta yuklash
          location.reload();
        } else {
          alert(
            "‚ùå Xatolik: " + (data.message || data.error || "Noma'lum xatolik")
          );
          // Button holatini tiklash
          button.innerHTML = originalText;
          button.disabled = false;
        }
      })
      .catch((error) => {
        console.error("Delete error:", error);
        alert("‚ùå Mahsulotni o'chirishda xatolik yuz berdi");
        // Button holatini tiklash
        button.innerHTML = originalText;
        button.disabled = false;
      });
  }
</script>
{% endblock %}
