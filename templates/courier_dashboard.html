{% extends "base.html" %}

{% block title %}Kuryer Dashboard{% endblock %}

{% block head %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=036467b2-54b9-44c8-bc32-9e85e02183c4&lang=uz_UZ" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2>🚚 Kuryer Dashboard</h2>
    <p>Salom, {{ session.get('courier_name') }}!</p>

    <div class="section-card">
        <h3>📦 Yetkazib berish uchun buyurtmalar</h3>

        {% if orders %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Buyurtma #</th>
                        <th>Mijoz</th>
                        <th>Telefon</th>
                        <th>Manzil</th>
                        <th>Masofa</th>
                        <th>Yetkazish narxi</th>
                        <th>Mahsulotlar</th>
                        <th>Status</th>
                        <th>Buyurtma vaqti</th>
                        <th>Yetib borish vaqti</th>
                        <th>Amallar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td><strong>#{{ order.ticket_no }}</strong></td>
                        <td>{{ order.customer_name }}</td>
                        <td>
                            {% if order.customer_phone %}
                                <a href="tel:{{ order.customer_phone }}" class="phone-link">
                                    📞 {{ order.customer_phone }}
                                </a>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if order.delivery_address %}
                                <div class="address-info">
                                    <span class="address-text">{{ order.delivery_address }}</span>
                                    {% if order.delivery_map_url %}
                                        <a href="{{ order.delivery_map_url }}"
                                           target="_blank" class="map-link">
                                            🗺️ Aniq joylashuv
                                        </a>
                                    {% else %}
                                        <a href="https://yandex.uz/maps/?text={{ order.delivery_address | urlencode }}"
                                           target="_blank" class="map-link">
                                            🗺️ Qidirib ko'rish
                                        </a>
                                    {% endif %}
                                    {% if order.customer_note %}
                                        <div class="customer-note">
                                            <small>💬 {{ order.customer_note }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if order.delivery_distance and order.delivery_distance > 0 %}
                                <span class="distance-badge">{{ "%.1f" | format(order.delivery_distance) }} km</span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if order.delivery_price and order.delivery_price > 0 %}
                                <span class="price-badge">{{ order.delivery_price }} so'm</span>
                            {% else %}
                                Bepul
                            {% endif %}
                        </td>
                        <td>
                            <div class="order-items">
                                {{ order.order_items or 'N/A' }}
                            </div>
                        </td>
                        <td>
                            {% if order.status == 'ready' %}
                                <span class="badge bg-warning">🟡 Tayyor</span>
                            {% elif order.status == 'on_way' %}
                                <span class="badge bg-info">🔵 Yo'lda</span>
                            {% elif order.status == 'delivered' %}
                                <span class="badge bg-success">🟢 Yetkazildi</span>
                            {% endif %}
                        </td>
                        <td>{{ order.created_at[:16].replace('T', ' ') }}</td>
                        <td>
                            <td class="eta-time">
                            <div>Tayyor: {{ order.eta_time[:16].replace('T', ' ') }}</div>
                            {% if order.courier_delivery_time %}
                                <div class="delivery-time">Yetkazish: {{ order.courier_delivery_time }} daq</div>
                            {% endif %}
                        </td>
                        </td>
                        <td>
                            {% if order.status == 'ready' %}
                                <div class="courier-actions">
                                    <form method="POST" action="{{ url_for('courier_take_order', order_id=order.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-primary">🚚 Olish va jo'nab ketish</button>
                                    </form>
                                </div>
                            {% elif order.status == 'on_way' %}
                                <div class="delivery-actions">
                                    {% if order.courier_price and order.courier_price > 0 %}
                                        <div class="courier-info">
                                            <small class="text-success">💰 {{ order.courier_price }} so'm</small>
                                            {% if order.courier_delivery_minutes and order.courier_delivery_minutes > 0 %}
                                                <small class="text-info">⏱️ {{ order.courier_delivery_minutes }} daq</small>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    <form method="POST" action="{{ url_for('courier_mark_delivered', order_id=order.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-success">✅ Yetkazib berdim</button>
                                    </form>
                                    {% if order.customer_phone %}
                                    <a href="tel:{{ order.customer_phone }}" class="btn btn-sm btn-info">📞 Qo'ng'iroq</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p class="text-center">🚚 Hozircha yetkazib berish uchun buyurtmalar yo'q.</p>
            <p class="text-center text-muted">Yangi delivery buyurtmalar paydo bo'lganda bu yerda ko'rinadi.</p>
        </div>
        {% endif %}
    </div>

    <!-- Kuryer statistikasi -->
    <div class="section-card">
        <h3>📈 Mening statistikam</h3>
        <div class="courier-stats">
            <div class="stat-item">
                <span class="stat-icon">📦</span>
                <div class="stat-info">
                    <span class="stat-number">{{ session.get('courier_deliveries', 0) }}</span>
                    <span class="stat-label">Yetkazib bergan</span>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-icon">⏰</span>
                <div class="stat-info">
                    <span class="stat-number">{{ session.get('courier_hours', 0) }}h</span>
                    <span class="stat-label">Ish soatlari</span>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-icon">🎯</span>
                <div class="stat-info">
                    <span class="stat-number">{{ session.get('courier_active_orders', 0) }}</span>
                    <span class="stat-label">Faol buyurtmalar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Yo'lda buyurtmalar -->
    <div class="section-card">
        <h3>🛣️ Yo'lda buyurtmalar</h3>
        <div id="active-deliveries">
            <!-- JavaScript orqali yangilanadi -->
        </div>
    </div>
</div>

<script>
// Har 30 soniyada ma'lumotlarni yangilash
setInterval(function() {
    updateActiveDeliveries();
}, 30000);

function updateActiveDeliveries() {
    // Bu yerda AJAX orqali faol buyurtmalarni yangilash mumkin
    console.log('Faol buyurtmalar yangilanmoqda...');
}

// Telefon raqamiga qo'ng'iroq qilish tugmasi
function callCustomer(phone) {
    if (confirm(`${phone} raqamiga qo'ng'iroq qilasizmi?`)) {
        window.location.href = `tel:${phone}`;
    }
}

// Xaritani ochish
function openMap(address) {
    const mapUrl = `https://yandex.uz/maps/?text=${encodeURIComponent(address)}`;
    window.open(mapUrl, '_blank');
}

// Sahifa avtomatik yangilanishi
</script>

<style>
.dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.section-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 25px;
    border-left: 5px solid #007bff;
}

.table-responsive {
    overflow-x: auto;
    margin-top: 15px;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.table th,
.table td {
    padding: 12px 8px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
    vertical-align: middle;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.table-hover tbody tr:hover {
    background-color: #f5f5f5;
}

.address-info {
    max-width: 200px;
}

.address-text {
    display: block;
    margin-bottom: 5px;
    font-size: 13px;
}

.map-link {
    color: #007bff;
    text-decoration: none;
    font-size: 12px;
    display: inline-block;
    padding: 2px 6px;
    border: 1px solid #007bff;
    border-radius: 4px;
}

.map-link:hover {
    background-color: #007bff;
    color: white;
}

.phone-link {
    color: #28a745;
    text-decoration: none;
    display: inline-block;
    padding: 4px 8px;
    border: 1px solid #28a745;
    border-radius: 4px;
    font-size: 12px;
}

.phone-link:hover {
    background-color: #28a745;
    color: white;
}

.distance-badge {
    background-color: #17a2b8;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.price-badge {
    background-color: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.order-items {
    max-width: 150px;
    font-size: 12px;
    line-height: 1.3;
}

.badge {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
    display: inline-block;
}

.bg-warning { background-color: #ffc107; color: #212529; }
.bg-info { background-color: #17a2b8; color: white; }
.bg-success { background-color: #28a745; color: white; }

.btn {
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    margin: 2px;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.btn-sm {
    padding: 6px 10px;
    font-size: 11px;
}

.delivery-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.courier-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.pricing-form {
    background: #f8f9fa;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.price-inputs {
    display: flex;
    gap: 5px;
    margin-bottom: 5px;
}

.form-control-sm {
    padding: 4px 6px;
    font-size: 11px;
    border: 1px solid #ced4da;
    border-radius: 3px;
    width: 80px;
}

.courier-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-bottom: 5px;
}

.customer-note {
    margin-top: 5px;
    padding: 3px 6px;
    background: #e7f3ff;
    border-radius: 3px;
    font-style: italic;
}

.eta-time {
    color: #007bff;
    font-weight: bold;
    font-size: 13px;
}

.delivery-time {
    font-size: 11px;
    color: #6c757d;
    margin-top: 3px;
}

.courier-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #007bff;
}

.stat-icon {
    font-size: 24px;
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-number {
    font-size: 18px;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.text-center {
    text-align: center;
}

.text-muted {
    color: #6c757d;
}

/* Mobile responsiv */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }

    .table th,
    .table td {
        padding: 8px 4px;
        font-size: 11px;
    }

    .address-info {
        max-width: 120px;
    }

    .order-items {
        max-width: 100px;
    }

    .delivery-actions {
        flex-direction: column;
    }

    .courier-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}